{"version":3,"file":"bridge-mode\\agent-cli-side.js","sources":["webpack://@sqai/web/webpack/runtime/define_property_getters","webpack://@sqai/web/webpack/runtime/has_own_property","webpack://@sqai/web/webpack/runtime/make_namespace_object","webpack://@sqai/web/./src/bridge-mode/agent-cli-side.ts"],"sourcesContent":["__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n        if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n            Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n        }\n    }\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","import { Agent, type AgentOpt } from '@sqai/core/agent';\r\nimport { assert } from '@sqai/shared/utils';\r\nimport { commonWebActionsForWebPage } from '../web-page';\r\nimport type { KeyboardAction, MouseAction } from '../web-page';\r\nimport {\r\n  type BridgeConnectTabOptions,\r\n  BridgeEvent,\r\n  BridgePageType,\r\n  DefaultBridgeServerPort,\r\n  KeyboardEvent,\r\n  MouseEvent,\r\n} from './common';\r\nimport { BridgeServer } from './io-server';\r\nimport type { ExtensionBridgePageBrowserSide } from './page-browser-side';\r\n\r\ninterface ChromeExtensionPageCliSide extends ExtensionBridgePageBrowserSide {\r\n  showStatusMessage: (message: string) => Promise<void>;\r\n}\r\n\r\nconst sleep = (ms: number) => new Promise((resolve) => setTimeout(resolve, ms));\r\n\r\n// actually, this is a proxy to the page in browser side\r\nexport const getBridgePageInCliSide = (\r\n  timeout?: number | false,\r\n  closeConflictServer?: boolean,\r\n): ChromeExtensionPageCliSide => {\r\n  const server = new BridgeServer(\r\n    DefaultBridgeServerPort,\r\n    undefined,\r\n    undefined,\r\n    closeConflictServer,\r\n  );\r\n  server.listen({\r\n    timeout,\r\n  });\r\n  const bridgeCaller = (method: string) => {\r\n    return async (...args: any[]) => {\r\n      const response = await server.call(method, args);\r\n      return response;\r\n    };\r\n  };\r\n  const page = {\r\n    showStatusMessage: async (message: string) => {\r\n      await server.call(BridgeEvent.UpdateAgentStatus, [message]);\r\n    },\r\n  };\r\n\r\n  const proxyPage = new Proxy(page, {\r\n    get(target, prop, receiver) {\r\n      assert(typeof prop === 'string', 'prop must be a string');\r\n\r\n      if (prop === 'toJSON') {\r\n        return () => {\r\n          return {\r\n            interfaceType: BridgePageType,\r\n          };\r\n        };\r\n      }\r\n\r\n      if (prop === 'getContext') {\r\n        return undefined;\r\n      }\r\n\r\n      if (prop === 'interfaceType') {\r\n        return BridgePageType;\r\n      }\r\n\r\n      if (prop === 'actionSpace') {\r\n        return () => commonWebActionsForWebPage(proxyPage);\r\n      }\r\n\r\n      if (Object.keys(page).includes(prop)) {\r\n        return page[prop as keyof typeof page];\r\n      }\r\n\r\n      if (prop === 'mouse') {\r\n        const mouse: MouseAction = {\r\n          click: bridgeCaller(MouseEvent.Click),\r\n          wheel: bridgeCaller(MouseEvent.Wheel),\r\n          move: bridgeCaller(MouseEvent.Move),\r\n          drag: bridgeCaller(MouseEvent.Drag),\r\n        };\r\n        return mouse;\r\n      }\r\n\r\n      if (prop === 'keyboard') {\r\n        const keyboard: KeyboardAction = {\r\n          type: bridgeCaller(KeyboardEvent.Type),\r\n          press: bridgeCaller(KeyboardEvent.Press),\r\n        };\r\n        return keyboard;\r\n      }\r\n\r\n      if (prop === 'destroy') {\r\n        return async (...args: any[]) => {\r\n          try {\r\n            const caller = bridgeCaller('destroy');\r\n            await caller(...args);\r\n          } catch (e) {\r\n            // console.error('error calling destroy', e);\r\n          }\r\n          return server.close();\r\n        };\r\n      }\r\n\r\n      return bridgeCaller(prop);\r\n    },\r\n  }) as ChromeExtensionPageCliSide;\r\n\r\n  return proxyPage;\r\n};\r\n\r\nexport class AgentOverChromeBridge extends Agent<ChromeExtensionPageCliSide> {\r\n  private destroyAfterDisconnectFlag?: boolean;\r\n\r\n  constructor(\r\n    opts?: AgentOpt & {\r\n      closeNewTabsAfterDisconnect?: boolean;\r\n      serverListeningTimeout?: number | false;\r\n      closeConflictServer?: boolean;\r\n    },\r\n  ) {\r\n    const page = getBridgePageInCliSide(opts?.serverListeningTimeout);\r\n    const originalOnTaskStartTip = opts?.onTaskStartTip;\r\n    super(\r\n      page,\r\n      Object.assign(opts || {}, {\r\n        onTaskStartTip: (tip: string) => {\r\n          this.page.showStatusMessage(tip);\r\n          if (originalOnTaskStartTip) {\r\n            originalOnTaskStartTip?.call(this, tip);\r\n          }\r\n        },\r\n      }),\r\n    );\r\n    this.destroyAfterDisconnectFlag = opts?.closeNewTabsAfterDisconnect;\r\n  }\r\n\r\n  async setDestroyOptionsAfterConnect() {\r\n    if (this.destroyAfterDisconnectFlag) {\r\n      this.page.setDestroyOptions({\r\n        closeTab: true,\r\n      });\r\n    }\r\n  }\r\n\r\n  async connectNewTabWithUrl(url: string, options?: BridgeConnectTabOptions) {\r\n    await this.page.connectNewTabWithUrl(url, options);\r\n    await sleep(500);\r\n    await this.setDestroyOptionsAfterConnect();\r\n  }\r\n\r\n  async getBrowserTabList() {\r\n    return await this.page.getBrowserTabList();\r\n  }\r\n\r\n  async setActiveTabId(tabId: string) {\r\n    return await this.page.setActiveTabId(Number.parseInt(tabId));\r\n  }\r\n\r\n  async connectCurrentTab(options?: BridgeConnectTabOptions) {\r\n    await this.page.connectCurrentTab(options);\r\n    await sleep(500);\r\n    await this.setDestroyOptionsAfterConnect();\r\n  }\r\n\r\n  async aiAction(prompt: string, options?: any) {\r\n    if (options) {\r\n      console.warn(\r\n        'the `options` parameter of aiAction is not supported in cli side',\r\n      );\r\n    }\r\n    return await super.aiAction(prompt);\r\n  }\r\n\r\n  async destroy(closeNewTabsAfterDisconnect?: boolean) {\r\n    if (typeof closeNewTabsAfterDisconnect === 'boolean') {\r\n      await this.page.setDestroyOptions({\r\n        closeTab: closeNewTabsAfterDisconnect,\r\n      });\r\n    }\r\n    await super.destroy();\r\n  }\r\n}\r\n"],"names":["__webpack_require__","definition","key","Object","obj","prop","Symbol","sleep","ms","Promise","resolve","setTimeout","getBridgePageInCliSide","timeout","closeConflictServer","server","BridgeServer","DefaultBridgeServerPort","undefined","bridgeCaller","method","args","response","page","message","BridgeEvent","proxyPage","Proxy","target","receiver","assert","BridgePageType","commonWebActionsForWebPage","mouse","MouseEvent","keyboard","KeyboardEvent","caller","e","AgentOverChromeBridge","Agent","url","options","tabId","Number","prompt","console","closeNewTabsAfterDisconnect","opts","originalOnTaskStartTip","tip"],"mappings":"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"}