{"version":3,"file":"bridge-mode\\page-browser-side.js","sources":["webpack://@sqaitech/web/webpack/runtime/compat_get_default_export","webpack://@sqaitech/web/webpack/runtime/define_property_getters","webpack://@sqaitech/web/webpack/runtime/has_own_property","webpack://@sqaitech/web/webpack/runtime/make_namespace_object","webpack://@sqaitech/web/./src/bridge-mode/page-browser-side.ts"],"sourcesContent":["// getDefaultExport function for compatibility with non-ESM modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};\n","__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n        if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n            Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n        }\n    }\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","import { assert } from '@sqaitech/shared/utils';\r\nimport ChromeExtensionProxyPage from '../chrome-extension/page';\r\nimport type {\r\n  ChromePageDestroyOptions,\r\n  KeyboardAction,\r\n  MouseAction,\r\n} from '../web-page';\r\nimport {\r\n  type BridgeConnectTabOptions,\r\n  BridgeEvent,\r\n  DefaultBridgeServerPort,\r\n  KeyboardEvent,\r\n  MouseEvent,\r\n} from './common';\r\nimport { BridgeClient } from './io-client';\r\n\r\ndeclare const __VERSION__: string;\r\n\r\nexport class ExtensionBridgePageBrowserSide extends ChromeExtensionProxyPage {\r\n  public bridgeClient: BridgeClient | null = null;\r\n\r\n  private destroyOptions?: ChromePageDestroyOptions;\r\n\r\n  private newlyCreatedTabIds: number[] = [];\r\n\r\n  constructor(\r\n    public onDisconnect: () => void = () => {},\r\n    public onLogMessage: (\r\n      message: string,\r\n      type: 'log' | 'status',\r\n    ) => void = () => {},\r\n    forceSameTabNavigation = true,\r\n  ) {\r\n    super(forceSameTabNavigation);\r\n  }\r\n\r\n  private async setupBridgeClient() {\r\n    this.bridgeClient = new BridgeClient(\r\n      `ws://localhost:${DefaultBridgeServerPort}`,\r\n      async (method, args: any[]) => {\r\n        console.log('bridge call from cli side', method, args);\r\n        if (method === BridgeEvent.ConnectNewTabWithUrl) {\r\n          return this.connectNewTabWithUrl.apply(\r\n            this,\r\n            args as unknown as [string],\r\n          );\r\n        }\r\n\r\n        if (method === BridgeEvent.GetBrowserTabList) {\r\n          return this.getBrowserTabList.apply(this, args as any);\r\n        }\r\n\r\n        if (method === BridgeEvent.SetActiveTabId) {\r\n          return this.setActiveTabId.apply(this, args as any);\r\n        }\r\n\r\n        if (method === BridgeEvent.ConnectCurrentTab) {\r\n          return this.connectCurrentTab.apply(this, args as any);\r\n        }\r\n\r\n        if (method === BridgeEvent.UpdateAgentStatus) {\r\n          return this.onLogMessage(args[0] as string, 'status');\r\n        }\r\n\r\n        const tabId = await this.getActiveTabId();\r\n        if (!tabId || tabId === 0) {\r\n          throw new Error('no tab is connected');\r\n        }\r\n\r\n        // this.onLogMessage(`calling method: ${method}`);\r\n\r\n        if (method.startsWith(MouseEvent.PREFIX)) {\r\n          const actionName = method.split('.')[1] as keyof MouseAction;\r\n          if (actionName === 'drag') {\r\n            return this.mouse[actionName].apply(this.mouse, args as any);\r\n          }\r\n          return this.mouse[actionName].apply(this.mouse, args as any);\r\n        }\r\n\r\n        if (method.startsWith(KeyboardEvent.PREFIX)) {\r\n          const actionName = method.split('.')[1] as keyof KeyboardAction;\r\n          if (actionName === 'press') {\r\n            return this.keyboard[actionName].apply(this.keyboard, args as any);\r\n          }\r\n          return this.keyboard[actionName].apply(this.keyboard, args as any);\r\n        }\r\n\r\n        if (!this[method as keyof ChromeExtensionProxyPage]) {\r\n          console.warn('method not found', method);\r\n          return undefined;\r\n        }\r\n\r\n        try {\r\n          // @ts-expect-error\r\n          const result = await this[method as keyof ChromeExtensionProxyPage](\r\n            ...args,\r\n          );\r\n          return result;\r\n        } catch (e) {\r\n          const errorMessage = e instanceof Error ? e.message : 'Unknown error';\r\n          console.error('error calling method', method, args, e);\r\n          this.onLogMessage(\r\n            `Error calling method: ${method}, ${errorMessage}`,\r\n            'log',\r\n          );\r\n          throw new Error(errorMessage, { cause: e });\r\n        }\r\n      },\r\n      // on disconnect\r\n      () => {\r\n        return this.destroy();\r\n      },\r\n    );\r\n    await this.bridgeClient.connect();\r\n    this.onLogMessage(\r\n      `Bridge connected, cli-side version v${this.bridgeClient.serverVersion}, browser-side version v${__VERSION__}`,\r\n      'log',\r\n    );\r\n  }\r\n\r\n  public async connect() {\r\n    return await this.setupBridgeClient();\r\n  }\r\n\r\n  public async connectNewTabWithUrl(\r\n    url: string,\r\n    options: BridgeConnectTabOptions = {\r\n      forceSameTabNavigation: true,\r\n    },\r\n  ) {\r\n    const tab = await chrome.tabs.create({ url });\r\n    const tabId = tab.id;\r\n    assert(tabId, 'failed to get tabId after creating a new tab');\r\n\r\n    // new tab\r\n    this.onLogMessage(`Creating new tab: ${url}`, 'log');\r\n    this.newlyCreatedTabIds.push(tabId);\r\n\r\n    if (options?.forceSameTabNavigation) {\r\n      this.forceSameTabNavigation = true;\r\n    }\r\n\r\n    await this.setActiveTabId(tabId);\r\n  }\r\n\r\n  public async connectCurrentTab(\r\n    options: BridgeConnectTabOptions = {\r\n      forceSameTabNavigation: true,\r\n    },\r\n  ) {\r\n    const tabs = await chrome.tabs.query({ active: true, currentWindow: true });\r\n    const tabId = tabs[0]?.id;\r\n    assert(tabId, 'failed to get tabId');\r\n\r\n    this.onLogMessage(`Connected to current tab: ${tabs[0]?.url}`, 'log');\r\n\r\n    if (options?.forceSameTabNavigation) {\r\n      this.forceSameTabNavigation = true;\r\n    }\r\n\r\n    await this.setActiveTabId(tabId);\r\n  }\r\n\r\n  public async setDestroyOptions(options: ChromePageDestroyOptions) {\r\n    this.destroyOptions = options;\r\n  }\r\n\r\n  async destroy() {\r\n    if (this.destroyOptions?.closeTab && this.newlyCreatedTabIds.length > 0) {\r\n      this.onLogMessage('Closing all newly created tabs by bridge...', 'log');\r\n      for (const tabId of this.newlyCreatedTabIds) {\r\n        await chrome.tabs.remove(tabId);\r\n      }\r\n      this.newlyCreatedTabIds = [];\r\n    }\r\n\r\n    await super.destroy();\r\n\r\n    if (this.bridgeClient) {\r\n      this.bridgeClient.disconnect();\r\n      this.bridgeClient = null;\r\n      this.onDisconnect();\r\n    }\r\n  }\r\n}\r\n"],"names":["__webpack_require__","module","getter","definition","key","Object","obj","prop","Symbol","ExtensionBridgePageBrowserSide","ChromeExtensionProxyPage","BridgeClient","DefaultBridgeServerPort","method","args","console","BridgeEvent","tabId","Error","MouseEvent","actionName","KeyboardEvent","result","e","errorMessage","url","options","tab","chrome","assert","_tabs_","_tabs_1","tabs","_this_destroyOptions","onDisconnect","onLogMessage","forceSameTabNavigation"],"mappings":"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"}