{"version":3,"file":"bridge-mode\\io-client.mjs","sources":["webpack://@sqai/web/./src/bridge-mode/io-client.ts"],"sourcesContent":["import { assert } from '@sqai/shared/utils';\r\nimport { io as ClientIO, type Socket as ClientSocket } from 'socket.io-client';\r\nimport {\r\n  type BridgeCallRequest,\r\n  type BridgeCallResponse,\r\n  type BridgeConnectedEventPayload,\r\n  BridgeEvent,\r\n} from './common';\r\n\r\ndeclare const __VERSION__: string;\r\n\r\n// ws client, this is where the request is processed\r\nexport class BridgeClient {\r\n  private socket: ClientSocket | null = null;\r\n  public serverVersion: string | null = null;\r\n  constructor(\r\n    public endpoint: string,\r\n    public onBridgeCall: (method: string, args: any[]) => Promise<any>,\r\n    public onDisconnect?: () => void,\r\n  ) {}\r\n\r\n  async connect() {\r\n    return new Promise((resolve, reject) => {\r\n      this.socket = ClientIO(this.endpoint, {\r\n        reconnection: false,\r\n        query: {\r\n          version: __VERSION__,\r\n        },\r\n      });\r\n\r\n      const timeout = setTimeout(() => {\r\n        try {\r\n          this.socket?.offAny();\r\n          this.socket?.close();\r\n        } catch (e) {\r\n          console.warn('got error when offing socket', e);\r\n        }\r\n        this.socket = null;\r\n        reject(new Error('failed to connect to bridge server after timeout'));\r\n      }, 1 * 1000);\r\n\r\n      // on disconnect\r\n      this.socket.on('disconnect', (reason: string) => {\r\n        // console.log('bridge-disconnected, reason:', reason);\r\n        this.socket = null;\r\n        this.onDisconnect?.();\r\n      });\r\n\r\n      this.socket.on('connect_error', (e: any) => {\r\n        console.error('bridge-connect-error', e);\r\n        reject(new Error(e || 'bridge connect error'));\r\n      });\r\n\r\n      this.socket.on(\r\n        BridgeEvent.Connected,\r\n        (payload: BridgeConnectedEventPayload) => {\r\n          clearTimeout(timeout);\r\n          this.serverVersion = payload?.version || 'unknown';\r\n          resolve(this.socket);\r\n        },\r\n      );\r\n      this.socket.on(BridgeEvent.Refused, (e: any) => {\r\n        console.error('bridge-refused', e);\r\n        try {\r\n          this.socket?.disconnect();\r\n        } catch (e) {\r\n          // console.warn('got error when disconnecting socket', e);\r\n        }\r\n        reject(new Error(e || 'bridge refused'));\r\n      });\r\n      this.socket.on(BridgeEvent.Call, (call: BridgeCallRequest) => {\r\n        const id = call.id;\r\n        assert(typeof id !== 'undefined', 'call id is required');\r\n        (async () => {\r\n          let response: any;\r\n          try {\r\n            response = await this.onBridgeCall(call.method, call.args);\r\n          } catch (e: any) {\r\n            const errorContent = `Error from bridge client when calling, method: ${call.method}, args: ${call.args}, error: ${e?.message || e}\\n${e?.stack || ''}`;\r\n            console.error(errorContent);\r\n            return this.socket?.emit(BridgeEvent.CallResponse, {\r\n              id,\r\n              error: errorContent,\r\n            } as BridgeCallResponse);\r\n          }\r\n          this.socket?.emit(BridgeEvent.CallResponse, {\r\n            id,\r\n            response,\r\n          } as BridgeCallResponse);\r\n        })();\r\n      });\r\n    });\r\n  }\r\n\r\n  disconnect() {\r\n    this.socket?.disconnect();\r\n    this.socket = null;\r\n  }\r\n}\r\n"],"names":["BridgeClient","Promise","resolve","reject","ClientIO","__VERSION__","timeout","setTimeout","_this_socket","_this_socket1","e","console","Error","reason","_this","BridgeEvent","payload","clearTimeout","call","id","assert","response","errorContent","endpoint","onBridgeCall","onDisconnect"],"mappings":"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"}