{"version":3,"file":"chrome-extension\\cdpInput.mjs","sources":["webpack://@sqaitech/web/./src/chrome-extension/cdpInput.ts"],"sourcesContent":["// From https://github.com/puppeteer/puppeteer/blob/15abcc390862fd08cc3475532f2d9a11284aee6b/packages/puppeteer-core/src/cdp/Input.ts#L55\r\n// with some modifications to fit the session type\r\n/**\r\n * @license\r\n * Copyright 2017 Google Inc.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n\r\nimport {\r\n  type KeyDefinition,\r\n  type KeyInput,\r\n  _keyDefinitions,\r\n} from '@sqaitech/shared/us-keyboard-layout';\r\nimport { assert } from '@sqaitech/shared/utils';\r\n\r\ntype KeyDescription = Required<\r\n  Pick<KeyDefinition, 'keyCode' | 'key' | 'text' | 'code' | 'location'>\r\n>;\r\n\r\n/**\r\n * @public\r\n */\r\nexport interface KeyDownOptions {\r\n  /**\r\n   * @deprecated Do not use. This is automatically handled.\r\n   */\r\n  text?: string;\r\n  /**\r\n   * @deprecated Do not use. This is automatically handled.\r\n   */\r\n  commands?: string[];\r\n}\r\n\r\n/**\r\n * @public\r\n */\r\nexport interface KeyboardTypeOptions {\r\n  /**\r\n   * Time to wait between key presses in milliseconds\r\n   * @default undefined\r\n   */\r\n  delay?: number;\r\n}\r\n\r\n/**\r\n * @public\r\n */\r\nexport type KeyPressOptions = KeyDownOptions & KeyboardTypeOptions;\r\n\r\ntype InternalCDPSession = {\r\n  send: (command: string, params: any) => Promise<void>;\r\n};\r\n\r\n/**\r\n * @internal\r\n */\r\nexport class CdpKeyboard {\r\n  #pressedKeys = new Set<string>();\r\n\r\n  #client: InternalCDPSession;\r\n\r\n  _modifiers = 0;\r\n\r\n  constructor(client: InternalCDPSession) {\r\n    this.#client = client;\r\n  }\r\n\r\n  updateClient(client: InternalCDPSession): void {\r\n    this.#client = client;\r\n  }\r\n\r\n  async down(\r\n    key: KeyInput,\r\n    options: Readonly<KeyDownOptions> = {\r\n      text: undefined,\r\n      commands: [],\r\n    },\r\n  ): Promise<void> {\r\n    const description = this.#keyDescriptionForString(key);\r\n\r\n    const autoRepeat = this.#pressedKeys.has(description.code);\r\n    this.#pressedKeys.add(description.code);\r\n    this._modifiers |= this.#modifierBit(description.key);\r\n\r\n    const text = options.text === undefined ? description.text : options.text;\r\n    await this.#client.send('Input.dispatchKeyEvent', {\r\n      type: text ? 'keyDown' : 'rawKeyDown',\r\n      modifiers: this._modifiers,\r\n      windowsVirtualKeyCode: description.keyCode,\r\n      code: description.code,\r\n      key: description.key,\r\n      text: text,\r\n      unmodifiedText: text,\r\n      autoRepeat,\r\n      location: description.location,\r\n      isKeypad: description.location === 3,\r\n      commands: options.commands,\r\n    });\r\n  }\r\n\r\n  #modifierBit(key: string): number {\r\n    if (key === 'Alt') {\r\n      return 1;\r\n    }\r\n    if (key === 'Control') {\r\n      return 2;\r\n    }\r\n    if (key === 'Meta') {\r\n      return 4;\r\n    }\r\n    if (key === 'Shift') {\r\n      return 8;\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  #keyDescriptionForString(keyString: KeyInput): KeyDescription {\r\n    const shift = this._modifiers & 8;\r\n    const description = {\r\n      key: '',\r\n      keyCode: 0,\r\n      code: '',\r\n      text: '',\r\n      location: 0,\r\n    };\r\n\r\n    const definition = _keyDefinitions[keyString];\r\n\r\n    assert(definition, `Unknown key: \"${keyString}\"`);\r\n\r\n    if (definition.key) {\r\n      description.key = definition.key;\r\n    }\r\n    if (shift && definition.shiftKey) {\r\n      description.key = definition.shiftKey;\r\n    }\r\n\r\n    if (definition.keyCode) {\r\n      description.keyCode = definition.keyCode;\r\n    }\r\n    if (shift && definition.shiftKeyCode) {\r\n      description.keyCode = definition.shiftKeyCode;\r\n    }\r\n\r\n    if (definition.code) {\r\n      description.code = definition.code;\r\n    }\r\n\r\n    if (definition.location) {\r\n      description.location = definition.location;\r\n    }\r\n\r\n    if (description.key.length === 1) {\r\n      description.text = description.key;\r\n    }\r\n\r\n    if (definition.text) {\r\n      description.text = definition.text;\r\n    }\r\n    if (shift && definition.shiftText) {\r\n      description.text = definition.shiftText;\r\n    }\r\n\r\n    // if any modifiers besides shift are pressed, no text should be sent\r\n    if (this._modifiers & ~8) {\r\n      description.text = '';\r\n    }\r\n\r\n    return description;\r\n  }\r\n\r\n  async up(key: KeyInput): Promise<void> {\r\n    const description = this.#keyDescriptionForString(key);\r\n\r\n    this._modifiers &= ~this.#modifierBit(description.key);\r\n    this.#pressedKeys.delete(description.code);\r\n    await this.#client.send('Input.dispatchKeyEvent', {\r\n      type: 'keyUp',\r\n      modifiers: this._modifiers,\r\n      key: description.key,\r\n      windowsVirtualKeyCode: description.keyCode,\r\n      code: description.code,\r\n      location: description.location,\r\n    });\r\n  }\r\n\r\n  async sendCharacter(char: string): Promise<void> {\r\n    await this.#client.send('Input.insertText', { text: char });\r\n  }\r\n\r\n  private charIsKey(char: string): char is KeyInput {\r\n    return !!_keyDefinitions[char as KeyInput];\r\n  }\r\n\r\n  async type(\r\n    text: string,\r\n    options: Readonly<KeyboardTypeOptions> = {},\r\n  ): Promise<void> {\r\n    const delay = options.delay || undefined;\r\n    for (const char of text) {\r\n      if (this.charIsKey(char)) {\r\n        await this.press(char, { delay });\r\n      } else {\r\n        if (delay) {\r\n          await new Promise((f) => {\r\n            return setTimeout(f, delay);\r\n          });\r\n        }\r\n        await this.sendCharacter(char);\r\n      }\r\n    }\r\n  }\r\n\r\n  async press(\r\n    key: KeyInput | KeyInput[],\r\n    options: Readonly<KeyPressOptions> = {},\r\n  ): Promise<void> {\r\n    const { delay = null } = options;\r\n    const keys = Array.isArray(key) ? key : [key];\r\n\r\n    for (const k of keys) {\r\n      await this.down(k, options);\r\n    }\r\n\r\n    if (delay) {\r\n      await new Promise((f) => {\r\n        return setTimeout(f, options.delay);\r\n      });\r\n    }\r\n\r\n    for (const k of [...keys].reverse()) {\r\n      await this.up(k);\r\n    }\r\n  }\r\n}\r\n"],"names":["_pressedKeys","_client","modifierBit","keyDescriptionForString","CdpKeyboard","client","key","options","undefined","description","autoRepeat","text","char","_keyDefinitions","delay","Promise","f","setTimeout","keys","Array","k","Set","keyString","shift","definition","assert"],"mappings":"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"}