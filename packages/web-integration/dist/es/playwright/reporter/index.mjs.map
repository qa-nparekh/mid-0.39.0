{"version":3,"file":"playwright\\reporter\\index.mjs","sources":["webpack://@sqai/web/./src/playwright/reporter/index.ts"],"sourcesContent":["import { readFileSync, rmSync } from 'node:fs';\r\nimport type { ReportDumpWithAttributes } from '@sqai/core';\r\nimport { getReportFileName, printReportMsg } from '@sqai/core/agent';\r\nimport { writeDumpReport } from '@sqai/core/utils';\r\nimport { replaceIllegalPathCharsAndSpace } from '@sqai/shared/utils';\r\nimport type {\r\n  FullConfig,\r\n  Reporter,\r\n  Suite,\r\n  TestCase,\r\n  TestResult,\r\n} from '@playwright/test/reporter';\r\n\r\ninterface MidsceneReporterOptions {\r\n  type?: 'merged' | 'separate';\r\n}\r\n\r\nclass MidsceneReporter implements Reporter {\r\n  private mergedFilename?: string;\r\n  private testTitleToFilename = new Map<string, string>();\r\n  mode?: 'merged' | 'separate';\r\n\r\n  constructor(options: MidsceneReporterOptions = {}) {\r\n    // Set mode from constructor options (official Playwright way)\r\n    this.mode = MidsceneReporter.getMode(options.type ?? 'merged');\r\n  }\r\n\r\n  private static getMode(reporterType: string): 'merged' | 'separate' {\r\n    if (!reporterType) {\r\n      return 'merged';\r\n    }\r\n    if (reporterType !== 'merged' && reporterType !== 'separate') {\r\n      throw new Error(\r\n        `Unknown reporter type in playwright config: ${reporterType}, only support 'merged' or 'separate'`,\r\n      );\r\n    }\r\n    return reporterType;\r\n  }\r\n\r\n  private getSeparatedFilename(testTitle: string): string {\r\n    if (!this.testTitleToFilename.has(testTitle)) {\r\n      const baseTag = `playwright-${replaceIllegalPathCharsAndSpace(testTitle)}`;\r\n      const generatedFilename = getReportFileName(baseTag);\r\n      this.testTitleToFilename.set(testTitle, generatedFilename);\r\n    }\r\n    return this.testTitleToFilename.get(testTitle)!;\r\n  }\r\n\r\n  private getReportFilename(testTitle?: string): string {\r\n    if (this.mode === 'merged') {\r\n      if (!this.mergedFilename) {\r\n        this.mergedFilename = getReportFileName('playwright-merged');\r\n      }\r\n      return this.mergedFilename;\r\n    } else if (this.mode === 'separate') {\r\n      if (!testTitle) throw new Error('testTitle is required in separate mode');\r\n      return this.getSeparatedFilename(testTitle);\r\n    }\r\n    throw new Error(`Unknown mode: ${this.mode}`);\r\n  }\r\n\r\n  private updateReport(testData: ReportDumpWithAttributes) {\r\n    if (!testData || !this.mode) return;\r\n    const fileName = this.getReportFilename(\r\n      testData.attributes?.playwright_test_title,\r\n    );\r\n    const reportPath = writeDumpReport(\r\n      fileName,\r\n      testData,\r\n      this.mode === 'merged',\r\n    );\r\n    reportPath && printReportMsg(reportPath);\r\n  }\r\n\r\n  async onBegin(config: FullConfig, suite: Suite) {}\r\n\r\n  onTestBegin(_test: TestCase, _result: TestResult) {\r\n    // logger(`Starting test ${test.title}`);\r\n  }\r\n\r\n  onTestEnd(test: TestCase, result: TestResult) {\r\n    const dumpAnnotation = test.annotations.find((annotation) => {\r\n      return annotation.type === 'MIDSCENE_DUMP_ANNOTATION';\r\n    });\r\n    if (!dumpAnnotation?.description) return;\r\n\r\n    const tempFilePath = dumpAnnotation.description;\r\n    let dumpString: string;\r\n\r\n    try {\r\n      dumpString = readFileSync(tempFilePath, 'utf-8');\r\n    } catch (error) {\r\n      console.error(\r\n        `Failed to read Midscene dump file: ${tempFilePath}`,\r\n        error,\r\n      );\r\n      return;\r\n    }\r\n\r\n    const retry = result.retry ? `(retry #${result.retry})` : '';\r\n    const testId = `${test.id}${retry}`;\r\n    const testData: ReportDumpWithAttributes = {\r\n      dumpString,\r\n      attributes: {\r\n        playwright_test_id: testId,\r\n        playwright_test_title: `${test.title}${retry}`,\r\n        playwright_test_status: result.status,\r\n        playwright_test_duration: result.duration,\r\n      },\r\n    };\r\n\r\n    this.updateReport(testData);\r\n\r\n    // Clean up: delete temp file\r\n    try {\r\n      rmSync(tempFilePath, { force: true });\r\n    } catch (error) {\r\n      console.warn(\r\n        `Failed to delete Midscene temp file: ${tempFilePath}`,\r\n        error,\r\n      );\r\n    }\r\n  }\r\n}\r\n\r\nexport default MidsceneReporter;\r\n"],"names":["MidsceneReporter","reporterType","Error","testTitle","baseTag","replaceIllegalPathCharsAndSpace","generatedFilename","getReportFileName","testData","_testData_attributes","fileName","reportPath","writeDumpReport","printReportMsg","config","suite","_test","_result","test","result","dumpAnnotation","annotation","tempFilePath","dumpString","readFileSync","error","console","retry","testId","rmSync","options","Map"],"mappings":"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"}