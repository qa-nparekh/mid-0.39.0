{"version":3,"file":"web-element.mjs","sources":["webpack://@sqai/web/./src/web-element.ts"],"sourcesContent":["import type {\r\n  AgentOpt,\r\n  DeviceAction,\r\n  Rect,\r\n  UIContext,\r\n  WebElementInfo,\r\n} from '@sqai/core';\r\nimport type { AbstractInterface } from '@sqai/core/device';\r\nimport { traverseTree } from '@sqai/shared/extractor';\r\nimport { getDebug } from '@sqai/shared/logger';\r\nimport { _keyDefinitions } from '@sqai/shared/us-keyboard-layout';\r\n\r\nimport { commonContextParser } from '@sqai/core/agent';\r\nimport type { NodeType } from '@sqai/shared/constants';\r\nimport type ChromeExtensionProxyPage from './chrome-extension/page';\r\nimport type { PlaywrightWebPage } from './playwright';\r\nimport type { PuppeteerWebPage } from './puppeteer';\r\nimport type { StaticPage } from './static';\r\nexport type { WebElementInfo };\r\n\r\nexport type WebPageAgentOpt = AgentOpt & WebPageOpt;\r\nexport type WebPageOpt = {\r\n  waitForNavigationTimeout?: number;\r\n  waitForNetworkIdleTimeout?: number;\r\n  forceSameTabNavigation?: boolean /* if limit the new tab to the current page, default true */;\r\n  beforeInvokeAction?: () => Promise<void>;\r\n  afterInvokeAction?: () => Promise<void>;\r\n  customActions?: DeviceAction<any>[];\r\n};\r\n\r\nexport type WebPage =\r\n  | PlaywrightWebPage\r\n  | PuppeteerWebPage\r\n  | StaticPage\r\n  | ChromeExtensionProxyPage;\r\n\r\nexport class WebElementInfoImpl implements WebElementInfo {\r\n  content: string;\r\n\r\n  rect: Rect;\r\n\r\n  center: [number, number];\r\n\r\n  id: string;\r\n\r\n  indexId: number;\r\n\r\n  attributes: {\r\n    nodeType: NodeType;\r\n    [key: string]: string;\r\n  };\r\n\r\n  xpaths?: string[];\r\n\r\n  isVisible: boolean;\r\n\r\n  constructor({\r\n    content,\r\n    rect,\r\n    id,\r\n    attributes,\r\n    indexId,\r\n    xpaths,\r\n    isVisible,\r\n  }: {\r\n    content: string;\r\n    rect: Rect;\r\n    id: string;\r\n    attributes: {\r\n      nodeType: NodeType;\r\n      [key: string]: string;\r\n    };\r\n    indexId: number;\r\n    xpaths?: string[];\r\n    isVisible: boolean;\r\n  }) {\r\n    this.content = content;\r\n    this.rect = rect;\r\n    this.center = [\r\n      Math.floor(rect.left + rect.width / 2),\r\n      Math.floor(rect.top + rect.height / 2),\r\n    ];\r\n    this.id = id;\r\n    this.attributes = attributes;\r\n    this.indexId = indexId;\r\n    this.xpaths = xpaths;\r\n    this.isVisible = isVisible;\r\n  }\r\n}\r\n\r\nconst debug = getDebug('web:parse-context');\r\nexport async function WebPageContextParser(\r\n  page: AbstractInterface,\r\n  _opt: { uploadServerUrl?: string },\r\n): Promise<UIContext> {\r\n  const basicContext = await commonContextParser(page, {\r\n    uploadServerUrl: _opt.uploadServerUrl,\r\n  });\r\n\r\n  debug('will traverse element tree');\r\n  const tree = (await page.getElementsNodeTree?.()) || {\r\n    node: null,\r\n    children: [],\r\n  };\r\n  const webTree = traverseTree(tree!, (elementInfo) => {\r\n    const { rect, id, content, attributes, indexId, isVisible } = elementInfo;\r\n    return new WebElementInfoImpl({\r\n      rect,\r\n      id,\r\n      content,\r\n      attributes,\r\n      indexId,\r\n      isVisible,\r\n    });\r\n  });\r\n  debug('traverse element tree end');\r\n\r\n  return {\r\n    ...basicContext,\r\n    tree: webTree,\r\n  };\r\n}\r\n\r\nexport const limitOpenNewTabScript = `\r\nif (!window.__MIDSCENE_NEW_TAB_INTERCEPTOR_INITIALIZED__) {\r\n  window.__MIDSCENE_NEW_TAB_INTERCEPTOR_INITIALIZED__ = true;\r\n\r\n  // Intercept the window.open method (only once)\r\n  window.open = function(url) {\r\n    console.log('Blocked window.open:', url);\r\n    window.location.href = url;\r\n    return null;\r\n  };\r\n\r\n  // Block all a tag clicks with target=\"_blank\" (only once)\r\n  document.addEventListener('click', function(e) {\r\n    const target = e.target.closest('a');\r\n    if (target && target.target === '_blank') {\r\n      e.preventDefault();\r\n      console.log('Blocked new tab:', target.href);\r\n      window.location.href = target.href;\r\n      target.removeAttribute('target');\r\n    }\r\n  }, true);\r\n}\r\n`;\r\n"],"names":["WebElementInfoImpl","content","rect","id","attributes","indexId","xpaths","isVisible","Math","debug","getDebug","WebPageContextParser","page","_opt","basicContext","commonContextParser","tree","webTree","traverseTree","elementInfo","limitOpenNewTabScript"],"mappings":";;;;;;;;;;;;;AAoCO,MAAMA;IAoBX,YAAY,EACVC,OAAO,EACPC,IAAI,EACJC,EAAE,EACFC,UAAU,EACVC,OAAO,EACPC,MAAM,EACNC,SAAS,EAYV,CAAE;QAtCH;QAEA;QAEA;QAEA;QAEA;QAEA;QAKA;QAEA;QAsBE,IAAI,CAAC,OAAO,GAAGN;QACf,IAAI,CAAC,IAAI,GAAGC;QACZ,IAAI,CAAC,MAAM,GAAG;YACZM,KAAK,KAAK,CAACN,KAAK,IAAI,GAAGA,KAAK,KAAK,GAAG;YACpCM,KAAK,KAAK,CAACN,KAAK,GAAG,GAAGA,KAAK,MAAM,GAAG;SACrC;QACD,IAAI,CAAC,EAAE,GAAGC;QACV,IAAI,CAAC,UAAU,GAAGC;QAClB,IAAI,CAAC,OAAO,GAAGC;QACf,IAAI,CAAC,MAAM,GAAGC;QACd,IAAI,CAAC,SAAS,GAAGC;IACnB;AACF;AAEA,MAAME,QAAQC,SAAS;AAChB,eAAeC,qBACpBC,IAAuB,EACvBC,IAAkC;QAOdD;IALpB,MAAME,eAAe,MAAMC,oBAAoBH,MAAM;QACnD,iBAAiBC,KAAK,eAAe;IACvC;IAEAJ,MAAM;IACN,MAAMO,OAAQ,eAAMJ,CAAAA,4BAAAA,KAAK,mBAAmB,AAAD,IAAvBA,KAAAA,IAAAA,0BAAAA,IAAAA,CAAAA,KAAI,KAA6B;QACnD,MAAM;QACN,UAAU,EAAE;IACd;IACA,MAAMK,UAAUC,aAAaF,MAAO,CAACG;QACnC,MAAM,EAAEjB,IAAI,EAAEC,EAAE,EAAEF,OAAO,EAAEG,UAAU,EAAEC,OAAO,EAAEE,SAAS,EAAE,GAAGY;QAC9D,OAAO,IAAInB,mBAAmB;YAC5BE;YACAC;YACAF;YACAG;YACAC;YACAE;QACF;IACF;IACAE,MAAM;IAEN,OAAO;QACL,GAAGK,YAAY;QACf,MAAMG;IACR;AACF;AAEO,MAAMG,wBAAwB,CAAC;;;;;;;;;;;;;;;;;;;;;;AAsBtC,CAAC"}