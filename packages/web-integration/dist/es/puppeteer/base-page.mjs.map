{"version":3,"file":"puppeteer\\base-page.mjs","sources":["webpack://@sqaitech/web/./src/puppeteer/base-page.ts"],"sourcesContent":["import { type WebPageAgentOpt, WebPageContextParser } from '@/web-element';\r\nimport type {\r\n  DeviceAction,\r\n  ElementCacheFeature,\r\n  ElementTreeNode,\r\n  Point,\r\n  Rect,\r\n  Size,\r\n  UIContext,\r\n} from '@sqaitech/core';\r\nimport type { AbstractInterface } from '@sqaitech/core/device';\r\nimport { sleep } from '@sqaitech/core/utils';\r\nimport {\r\n  DEFAULT_WAIT_FOR_NAVIGATION_TIMEOUT,\r\n  DEFAULT_WAIT_FOR_NETWORK_IDLE_CONCURRENCY,\r\n  DEFAULT_WAIT_FOR_NETWORK_IDLE_TIMEOUT,\r\n} from '@sqaitech/shared/constants';\r\nimport type { ElementInfo } from '@sqaitech/shared/extractor';\r\nimport { treeToList } from '@sqaitech/shared/extractor';\r\nimport { createImgBase64ByFormat } from '@sqaitech/shared/img';\r\nimport { type DebugFunction, getDebug } from '@sqaitech/shared/logger';\r\nimport {\r\n  getElementInfosScriptContent,\r\n  getExtraReturnLogic,\r\n} from '@sqaitech/shared/node';\r\nimport { assert } from '@sqaitech/shared/utils';\r\nimport type { Page as PlaywrightPage } from 'playwright';\r\nimport type { Page as PuppeteerPage } from 'puppeteer';\r\nimport {\r\n  type KeyInput,\r\n  type MouseButton,\r\n  commonWebActionsForWebPage,\r\n} from '../web-page';\r\n\r\nexport const debugPage = getDebug('web:page');\r\n\r\ntype WebElementCacheFeature = ElementCacheFeature & {\r\n  xpaths?: string[];\r\n};\r\n\r\nconst sanitizeXpaths = (xpaths: unknown): string[] => {\r\n  if (!Array.isArray(xpaths)) {\r\n    return [];\r\n  }\r\n\r\n  return xpaths.filter(\r\n    (xpath): xpath is string => typeof xpath === 'string' && xpath.length > 0,\r\n  );\r\n};\r\n\r\nexport class Page<\r\n  AgentType extends 'puppeteer' | 'playwright',\r\n  InterfaceType extends PuppeteerPage | PlaywrightPage,\r\n> implements AbstractInterface\r\n{\r\n  underlyingPage: InterfaceType;\r\n  protected waitForNavigationTimeout: number;\r\n  protected waitForNetworkIdleTimeout: number;\r\n  private viewportSize?: Size;\r\n  private onBeforeInvokeAction?: AbstractInterface['beforeInvokeAction'];\r\n  private onAfterInvokeAction?: AbstractInterface['afterInvokeAction'];\r\n  private customActions?: DeviceAction<any>[];\r\n\r\n  interfaceType: AgentType;\r\n\r\n  actionSpace(): DeviceAction[] {\r\n    const defaultActions = commonWebActionsForWebPage(this);\r\n    const customActions = this.customActions || [];\r\n    return [...defaultActions, ...customActions];\r\n  }\r\n\r\n  private async evaluate<R>(\r\n    pageFunction: string | ((...args: any[]) => R | Promise<R>),\r\n    arg?: any,\r\n  ): Promise<R> {\r\n    let result: R;\r\n    debugPage('evaluate function begin');\r\n    if (this.interfaceType === 'puppeteer') {\r\n      result = await (this.underlyingPage as PuppeteerPage).evaluate(\r\n        pageFunction,\r\n        arg,\r\n      );\r\n    } else {\r\n      result = await (this.underlyingPage as PlaywrightPage).evaluate(\r\n        pageFunction,\r\n        arg,\r\n      );\r\n    }\r\n    debugPage('evaluate function end');\r\n    return result;\r\n  }\r\n\r\n  constructor(\r\n    underlyingPage: InterfaceType,\r\n    interfaceType: AgentType,\r\n    opts?: WebPageAgentOpt,\r\n  ) {\r\n    this.underlyingPage = underlyingPage;\r\n    this.interfaceType = interfaceType;\r\n    this.waitForNavigationTimeout =\r\n      opts?.waitForNavigationTimeout ?? DEFAULT_WAIT_FOR_NAVIGATION_TIMEOUT;\r\n    this.waitForNetworkIdleTimeout =\r\n      opts?.waitForNetworkIdleTimeout ?? DEFAULT_WAIT_FOR_NETWORK_IDLE_TIMEOUT;\r\n    this.onBeforeInvokeAction = opts?.beforeInvokeAction;\r\n    this.onAfterInvokeAction = opts?.afterInvokeAction;\r\n    this.customActions = opts?.customActions;\r\n  }\r\n\r\n  async evaluateJavaScript<T = any>(script: string): Promise<T> {\r\n    return this.evaluate(script);\r\n  }\r\n\r\n  async waitForNavigation() {\r\n    if (this.waitForNavigationTimeout === 0) {\r\n      debugPage('waitForNavigation timeout is 0, skip waiting');\r\n      return;\r\n    }\r\n\r\n    // issue: https://github.com/puppeteer/puppeteer/issues/3323\r\n    if (\r\n      this.interfaceType === 'puppeteer' ||\r\n      this.interfaceType === 'playwright'\r\n    ) {\r\n      debugPage('waitForNavigation begin');\r\n      debugPage(`waitForNavigation timeout: ${this.waitForNavigationTimeout}`);\r\n      try {\r\n        await (this.underlyingPage as PuppeteerPage).waitForSelector('html', {\r\n          timeout: this.waitForNavigationTimeout,\r\n        });\r\n      } catch (error) {\r\n        // Ignore timeout error, continue execution\r\n        console.warn(\r\n          '[sqai:warning] Waiting for the \"navigation\" has timed out, but SQAI will continue execution. Please check https://sqai.tech/faq.html#customize-the-network-timeout for more information on customizing the network timeout',\r\n        );\r\n      }\r\n      debugPage('waitForNavigation end');\r\n    }\r\n  }\r\n\r\n  async waitForNetworkIdle(): Promise<void> {\r\n    if (this.interfaceType === 'puppeteer') {\r\n      if (this.waitForNetworkIdleTimeout === 0) {\r\n        debugPage('waitForNetworkIdle timeout is 0, skip waiting');\r\n        return;\r\n      }\r\n\r\n      try {\r\n        await (this.underlyingPage as PuppeteerPage).waitForNetworkIdle({\r\n          idleTime: 200,\r\n          concurrency: DEFAULT_WAIT_FOR_NETWORK_IDLE_CONCURRENCY,\r\n          timeout: this.waitForNetworkIdleTimeout,\r\n        });\r\n      } catch (error) {\r\n        // Ignore timeout error, continue execution\r\n        console.warn(\r\n          '[sqai:warning] Waiting for the \"network idle\" has timed out, but SQAI will continue execution. Please check https://sqai.tech/faq.html#customize-the-network-timeout for more information on customizing the network timeout',\r\n        );\r\n      }\r\n    } else {\r\n      // TODO: implement playwright waitForNetworkIdle\r\n    }\r\n  }\r\n\r\n  // @deprecated\r\n  async getElementsInfo() {\r\n    // const scripts = await getExtraReturnLogic();\r\n    // const captureElementSnapshot = await this.evaluate(scripts);\r\n    // return captureElementSnapshot as ElementInfo[];\r\n    await this.waitForNavigation();\r\n    debugPage('getElementsInfo begin');\r\n    const tree = await this.getElementsNodeTree();\r\n    debugPage('getElementsInfo end');\r\n    return treeToList(tree);\r\n  }\r\n\r\n  async getXpathsById(id: string) {\r\n    const elementInfosScriptContent = getElementInfosScriptContent();\r\n\r\n    return this.evaluateJavaScript(\r\n      `${elementInfosScriptContent}midscene_element_inspector.getXpathsById(${JSON.stringify(id)})`,\r\n    );\r\n  }\r\n\r\n  async getXpathsByPoint(point: Point, isOrderSensitive: boolean) {\r\n    const elementInfosScriptContent = getElementInfosScriptContent();\r\n\r\n    return this.evaluateJavaScript(\r\n      `${elementInfosScriptContent}midscene_element_inspector.getXpathsByPoint({left: ${point.left}, top: ${point.top}}, ${isOrderSensitive})`,\r\n    );\r\n  }\r\n\r\n  async getElementInfoByXpath(xpath: string) {\r\n    const elementInfosScriptContent = getElementInfosScriptContent();\r\n\r\n    return this.evaluateJavaScript(\r\n      `${elementInfosScriptContent}midscene_element_inspector.getElementInfoByXpath(${JSON.stringify(xpath)})`,\r\n    );\r\n  }\r\n\r\n  async cacheFeatureForRect(\r\n    rect: Rect,\r\n    opt?: { _orderSensitive: boolean },\r\n  ): Promise<ElementCacheFeature> {\r\n    const center: Point = {\r\n      left: Math.floor(rect.left + rect.width / 2),\r\n      top: Math.floor(rect.top + rect.height / 2),\r\n    };\r\n\r\n    try {\r\n      const orderSensitive = opt?._orderSensitive ?? false;\r\n      const xpaths = await this.getXpathsByPoint(center, orderSensitive);\r\n      const sanitized = sanitizeXpaths(xpaths);\r\n      if (!sanitized.length) {\r\n        debugPage('cacheFeatureForRect: no xpath found at rect %o', rect);\r\n      }\r\n      return {\r\n        xpaths: sanitized,\r\n      };\r\n    } catch (error) {\r\n      debugPage('cacheFeatureForRect failed: %s', error);\r\n      return {\r\n        xpaths: [],\r\n      };\r\n    }\r\n  }\r\n\r\n  async rectMatchesCacheFeature(feature: ElementCacheFeature): Promise<Rect> {\r\n    const webFeature = feature as WebElementCacheFeature;\r\n    const xpaths = sanitizeXpaths(webFeature.xpaths);\r\n\r\n    for (const xpath of xpaths) {\r\n      try {\r\n        const elementInfo = await this.getElementInfoByXpath(xpath);\r\n        if (elementInfo?.rect) {\r\n          const matchedRect: Rect = {\r\n            left: elementInfo.rect.left,\r\n            top: elementInfo.rect.top,\r\n            width: elementInfo.rect.width,\r\n            height: elementInfo.rect.height,\r\n          };\r\n\r\n          if (this.viewportSize?.dpr) {\r\n            matchedRect.dpr = this.viewportSize.dpr;\r\n          }\r\n\r\n          return matchedRect;\r\n        }\r\n      } catch (error) {\r\n        debugPage(\r\n          'rectMatchesCacheFeature failed for xpath %s: %s',\r\n          xpath,\r\n          error,\r\n        );\r\n      }\r\n    }\r\n\r\n    throw new Error(\r\n      'No matching element rect found for the provided cache feature',\r\n    );\r\n  }\r\n\r\n  async getElementsNodeTree() {\r\n    // ref: packages/web-integration/src/playwright/ai-fixture.ts popup logic\r\n    // During test execution, a new page might be opened through a connection, and the page remains confined to the same page instance.\r\n    // The page may go through opening, closing, and reopening; if the page is closed, evaluate may return undefined, which can lead to errors.\r\n    await this.waitForNavigation();\r\n    const scripts = await getExtraReturnLogic(true);\r\n    assert(scripts, 'scripts should be set before writing report in browser');\r\n    const startTime = Date.now();\r\n    const captureElementSnapshot = await this.evaluate(scripts);\r\n    const endTime = Date.now();\r\n    debugPage(`getElementsNodeTree end, cost: ${endTime - startTime}ms`);\r\n    return captureElementSnapshot as ElementTreeNode<ElementInfo>;\r\n  }\r\n\r\n  async size(): Promise<Size> {\r\n    if (this.viewportSize) return this.viewportSize;\r\n    const sizeInfo: Size = await this.evaluate(() => {\r\n      return {\r\n        width: document.documentElement.clientWidth,\r\n        height: document.documentElement.clientHeight,\r\n        dpr: window.devicePixelRatio,\r\n      };\r\n    });\r\n    this.viewportSize = sizeInfo;\r\n    return sizeInfo;\r\n  }\r\n\r\n  async screenshotBase64(): Promise<string> {\r\n    const imgType = 'jpeg';\r\n    const quality = 90;\r\n    await this.waitForNavigation();\r\n    const startTime = Date.now();\r\n    debugPage('screenshotBase64 begin');\r\n\r\n    let base64: string;\r\n    if (this.interfaceType === 'puppeteer') {\r\n      const result = await (this.underlyingPage as PuppeteerPage).screenshot({\r\n        type: imgType,\r\n        quality,\r\n        encoding: 'base64',\r\n      });\r\n      base64 = createImgBase64ByFormat(imgType, result);\r\n    } else if (this.interfaceType === 'playwright') {\r\n      const buffer = await (this.underlyingPage as PlaywrightPage).screenshot({\r\n        type: imgType,\r\n        quality,\r\n        timeout: 10 * 1000,\r\n      });\r\n      base64 = createImgBase64ByFormat(imgType, buffer.toString('base64'));\r\n    } else {\r\n      throw new Error('Unsupported page type for screenshot');\r\n    }\r\n    const endTime = Date.now();\r\n    debugPage(`screenshotBase64 end, cost: ${endTime - startTime}ms`);\r\n    return base64;\r\n  }\r\n\r\n  async url(): Promise<string> {\r\n    return this.underlyingPage.url();\r\n  }\r\n\r\n  describe(): string {\r\n    const url = this.underlyingPage.url();\r\n    return url || '';\r\n  }\r\n\r\n  get mouse() {\r\n    return {\r\n      click: async (\r\n        x: number,\r\n        y: number,\r\n        options?: { button?: MouseButton; count?: number },\r\n      ) => {\r\n        await this.mouse.move(x, y);\r\n        const { button = 'left', count = 1 } = options || {};\r\n        debugPage(`mouse click ${x}, ${y}, ${button}, ${count}`);\r\n\r\n        if (count === 2 && this.interfaceType === 'playwright') {\r\n          await (this.underlyingPage as PlaywrightPage).mouse.dblclick(x, y, {\r\n            button,\r\n          });\r\n        } else {\r\n          if (this.interfaceType === 'puppeteer') {\r\n            if (button === 'left' && count === 1) {\r\n              await (this.underlyingPage as PuppeteerPage).mouse.click(x, y);\r\n            } else {\r\n              await (this.underlyingPage as PuppeteerPage).mouse.click(x, y, {\r\n                button,\r\n                count,\r\n              });\r\n            }\r\n          } else if (this.interfaceType === 'playwright') {\r\n            (this.underlyingPage as PlaywrightPage).mouse.click(x, y, {\r\n              button,\r\n              clickCount: count,\r\n            });\r\n          }\r\n        }\r\n      },\r\n      wheel: async (deltaX: number, deltaY: number) => {\r\n        debugPage(`mouse wheel ${deltaX}, ${deltaY}`);\r\n        if (this.interfaceType === 'puppeteer') {\r\n          await (this.underlyingPage as PuppeteerPage).mouse.wheel({\r\n            deltaX,\r\n            deltaY,\r\n          });\r\n        } else if (this.interfaceType === 'playwright') {\r\n          await (this.underlyingPage as PlaywrightPage).mouse.wheel(\r\n            deltaX,\r\n            deltaY,\r\n          );\r\n        }\r\n      },\r\n      move: async (x: number, y: number) => {\r\n        this.everMoved = true;\r\n        debugPage(`mouse move to ${x}, ${y}`);\r\n        return this.underlyingPage.mouse.move(x, y);\r\n      },\r\n      drag: async (\r\n        from: { x: number; y: number },\r\n        to: { x: number; y: number },\r\n      ) => {\r\n        debugPage(\r\n          `begin mouse drag from ${from.x}, ${from.y} to ${to.x}, ${to.y}`,\r\n        );\r\n        await (this.underlyingPage as PlaywrightPage).mouse.move(\r\n          from.x,\r\n          from.y,\r\n        );\r\n        await sleep(200);\r\n        await (this.underlyingPage as PlaywrightPage).mouse.down();\r\n        await sleep(300);\r\n        await (this.underlyingPage as PlaywrightPage).mouse.move(to.x, to.y);\r\n        await sleep(500);\r\n        await (this.underlyingPage as PlaywrightPage).mouse.up();\r\n        await sleep(200);\r\n        debugPage(\r\n          `end mouse drag from ${from.x}, ${from.y} to ${to.x}, ${to.y}`,\r\n        );\r\n      },\r\n    };\r\n  }\r\n\r\n  get keyboard() {\r\n    return {\r\n      type: async (text: string) => {\r\n        debugPage(`keyboard type ${text}`);\r\n        return this.underlyingPage.keyboard.type(text, { delay: 80 });\r\n      },\r\n      press: async (\r\n        action:\r\n          | { key: KeyInput; command?: string }\r\n          | { key: KeyInput; command?: string }[],\r\n      ) => {\r\n        const keys = Array.isArray(action) ? action : [action];\r\n        debugPage('keyboard press', keys);\r\n        for (const k of keys) {\r\n          const commands = k.command ? [k.command] : [];\r\n          await this.underlyingPage.keyboard.down(k.key, { commands });\r\n        }\r\n        for (const k of [...keys].reverse()) {\r\n          await this.underlyingPage.keyboard.up(k.key);\r\n        }\r\n      },\r\n      down: async (key: KeyInput) => {\r\n        debugPage(`keyboard down ${key}`);\r\n        return this.underlyingPage.keyboard.down(key);\r\n      },\r\n      up: async (key: KeyInput) => {\r\n        debugPage(`keyboard up ${key}`);\r\n        return this.underlyingPage.keyboard.up(key);\r\n      },\r\n    };\r\n  }\r\n\r\n  async clearInput(element: ElementInfo): Promise<void> {\r\n    if (!element) {\r\n      console.warn('No element to clear input');\r\n      return;\r\n    }\r\n\r\n    const backspace = async () => {\r\n      await sleep(100);\r\n      await this.keyboard.press([{ key: 'Backspace' }]);\r\n    };\r\n\r\n    const isMac = process.platform === 'darwin';\r\n    debugPage('clearInput begin');\r\n    if (isMac) {\r\n      if (this.interfaceType === 'puppeteer') {\r\n        // https://github.com/segment-boneyard/nightmare/issues/810#issuecomment-452669866\r\n        await this.mouse.click(element.center[0], element.center[1], {\r\n          count: 3,\r\n        });\r\n        await backspace();\r\n      }\r\n\r\n      await this.mouse.click(element.center[0], element.center[1]);\r\n      await this.underlyingPage.keyboard.down('Meta');\r\n      await this.underlyingPage.keyboard.press('a');\r\n      await this.underlyingPage.keyboard.up('Meta');\r\n      await backspace();\r\n    } else {\r\n      await this.mouse.click(element.center[0], element.center[1]);\r\n      await this.underlyingPage.keyboard.down('Control');\r\n      await this.underlyingPage.keyboard.press('a');\r\n      await this.underlyingPage.keyboard.up('Control');\r\n      await backspace();\r\n    }\r\n    debugPage('clearInput end');\r\n  }\r\n\r\n  private everMoved = false;\r\n  private async moveToPointBeforeScroll(point?: Point): Promise<void> {\r\n    if (point) {\r\n      await this.mouse.move(point.left, point.top);\r\n    } else if (!this.everMoved) {\r\n      // If the mouse has never moved, move it to the center of the page\r\n      const size = await this.size();\r\n      const targetX = Math.floor(size.width / 2);\r\n      const targetY = Math.floor(size.height / 2);\r\n      await this.mouse.move(targetX, targetY);\r\n    }\r\n  }\r\n\r\n  async scrollUntilTop(startingPoint?: Point): Promise<void> {\r\n    await this.moveToPointBeforeScroll(startingPoint);\r\n    return this.mouse.wheel(0, -9999999);\r\n  }\r\n\r\n  async scrollUntilBottom(startingPoint?: Point): Promise<void> {\r\n    await this.moveToPointBeforeScroll(startingPoint);\r\n    return this.mouse.wheel(0, 9999999);\r\n  }\r\n\r\n  async scrollUntilLeft(startingPoint?: Point): Promise<void> {\r\n    await this.moveToPointBeforeScroll(startingPoint);\r\n    return this.mouse.wheel(-9999999, 0);\r\n  }\r\n\r\n  async scrollUntilRight(startingPoint?: Point): Promise<void> {\r\n    await this.moveToPointBeforeScroll(startingPoint);\r\n    return this.mouse.wheel(9999999, 0);\r\n  }\r\n\r\n  async scrollUp(distance?: number, startingPoint?: Point): Promise<void> {\r\n    const innerHeight = await this.evaluate(() => window.innerHeight);\r\n    const scrollDistance = distance || innerHeight * 0.7;\r\n    await this.moveToPointBeforeScroll(startingPoint);\r\n    return this.mouse.wheel(0, -scrollDistance);\r\n  }\r\n\r\n  async scrollDown(distance?: number, startingPoint?: Point): Promise<void> {\r\n    const innerHeight = await this.evaluate(() => window.innerHeight);\r\n    const scrollDistance = distance || innerHeight * 0.7;\r\n    await this.moveToPointBeforeScroll(startingPoint);\r\n    return this.mouse.wheel(0, scrollDistance);\r\n  }\r\n\r\n  async scrollLeft(distance?: number, startingPoint?: Point): Promise<void> {\r\n    const innerWidth = await this.evaluate(() => window.innerWidth);\r\n    const scrollDistance = distance || innerWidth * 0.7;\r\n    await this.moveToPointBeforeScroll(startingPoint);\r\n    return this.mouse.wheel(-scrollDistance, 0);\r\n  }\r\n\r\n  async scrollRight(distance?: number, startingPoint?: Point): Promise<void> {\r\n    const innerWidth = await this.evaluate(() => window.innerWidth);\r\n    const scrollDistance = distance || innerWidth * 0.7;\r\n    await this.moveToPointBeforeScroll(startingPoint);\r\n    return this.mouse.wheel(scrollDistance, 0);\r\n  }\r\n\r\n  async navigate(url: string): Promise<void> {\r\n    debugPage(`navigate to ${url}`);\r\n    if (this.interfaceType === 'puppeteer') {\r\n      await (this.underlyingPage as PuppeteerPage).goto(url);\r\n    } else if (this.interfaceType === 'playwright') {\r\n      await (this.underlyingPage as PlaywrightPage).goto(url);\r\n    } else {\r\n      throw new Error('Unsupported page type for navigate');\r\n    }\r\n  }\r\n\r\n  async beforeInvokeAction(name: string, param: any): Promise<void> {\r\n    await Promise.all([this.waitForNavigation(), this.waitForNetworkIdle()]);\r\n    if (this.onBeforeInvokeAction) {\r\n      await this.onBeforeInvokeAction(name, param);\r\n    }\r\n  }\r\n\r\n  async afterInvokeAction(name: string, param: any): Promise<void> {\r\n    await Promise.all([this.waitForNavigation(), this.waitForNetworkIdle()]);\r\n    if (this.onAfterInvokeAction) {\r\n      await this.onAfterInvokeAction(name, param);\r\n    }\r\n  }\r\n\r\n  async destroy(): Promise<void> {}\r\n\r\n  async getContext(): Promise<UIContext> {\r\n    return await WebPageContextParser(this, {});\r\n  }\r\n  async swipe(\r\n    from: { x: number; y: number },\r\n    to: { x: number; y: number },\r\n    duration?: number,\r\n  ) {\r\n    const LONG_PRESS_THRESHOLD = 500;\r\n    const MIN_PRESS_THRESHOLD = 150;\r\n    duration = duration || 100;\r\n    if (duration < MIN_PRESS_THRESHOLD) {\r\n      duration = MIN_PRESS_THRESHOLD;\r\n    }\r\n    if (duration > LONG_PRESS_THRESHOLD) {\r\n      duration = LONG_PRESS_THRESHOLD;\r\n    }\r\n    debugPage(\r\n      `mouse swipe from ${from.x}, ${from.y} to ${to.x}, ${to.y} with duration ${duration}ms`,\r\n    );\r\n\r\n    if (this.interfaceType === 'puppeteer') {\r\n      const page = this.underlyingPage as PuppeteerPage;\r\n      await page.mouse.move(from.x, from.y);\r\n      await page.mouse.down({ button: 'left' });\r\n\r\n      const steps = 30;\r\n      const delay = duration / steps;\r\n      for (let i = 1; i <= steps; i++) {\r\n        const x = from.x + (to.x - from.x) * (i / steps);\r\n        const y = from.y + (to.y - from.y) * (i / steps);\r\n        await page.mouse.move(x, y);\r\n        await new Promise((resolve) => setTimeout(resolve, delay));\r\n      }\r\n\r\n      await page.mouse.up({ button: 'left' });\r\n    } else if (this.interfaceType === 'playwright') {\r\n      const page = this.underlyingPage as PlaywrightPage;\r\n      await page.mouse.move(from.x, from.y);\r\n      await page.mouse.down();\r\n\r\n      const steps = 30;\r\n      const delay = duration / steps;\r\n      for (let i = 1; i <= steps; i++) {\r\n        const x = from.x + (to.x - from.x) * (i / steps);\r\n        const y = from.y + (to.y - from.y) * (i / steps);\r\n        await page.mouse.move(x, y);\r\n        await page.waitForTimeout(delay);\r\n      }\r\n\r\n      await page.mouse.up({ button: 'left' });\r\n    }\r\n  }\r\n  async longPress(x: number, y: number, duration?: number) {\r\n    duration = duration || 500;\r\n    const LONG_PRESS_THRESHOLD = 600;\r\n    const MIN_PRESS_THRESHOLD = 300;\r\n    if (duration > LONG_PRESS_THRESHOLD) {\r\n      duration = LONG_PRESS_THRESHOLD;\r\n    }\r\n    if (duration < MIN_PRESS_THRESHOLD) {\r\n      duration = MIN_PRESS_THRESHOLD;\r\n    }\r\n    debugPage(`mouse longPress at ${x}, ${y} for ${duration}ms`);\r\n    if (this.interfaceType === 'puppeteer') {\r\n      const page = this.underlyingPage as PuppeteerPage;\r\n      await page.mouse.move(x, y);\r\n      await page.mouse.down({ button: 'left' });\r\n      await new Promise((res) => setTimeout(res, duration));\r\n      await page.mouse.up({ button: 'left' });\r\n    } else if (this.interfaceType === 'playwright') {\r\n      const page = this.underlyingPage as PlaywrightPage;\r\n      await page.mouse.move(x, y);\r\n      await page.mouse.down({ button: 'left' });\r\n      await page.waitForTimeout(duration);\r\n      await page.mouse.up({ button: 'left' });\r\n    }\r\n  }\r\n}\r\n\r\nexport function forceClosePopup(\r\n  page: PuppeteerPage | PlaywrightPage,\r\n  debugProfile: DebugFunction,\r\n) {\r\n  page.on('popup', async (popup) => {\r\n    if (!popup) {\r\n      console.warn('got a popup event, but the popup is not ready yet, skip');\r\n      return;\r\n    }\r\n    const url = await (popup as PuppeteerPage).url();\r\n    console.log(`Popup opened: ${url}`);\r\n    if (!(popup as PuppeteerPage).isClosed()) {\r\n      try {\r\n        await (popup as PuppeteerPage).close(); // Close the newly opened TAB\r\n      } catch (error) {\r\n        debugProfile(`failed to close popup ${url}, error: ${error}`);\r\n      }\r\n    } else {\r\n      debugProfile(`popup is already closed, skip close ${url}`);\r\n    }\r\n\r\n    if (!page.isClosed()) {\r\n      try {\r\n        await page.goto(url);\r\n      } catch (error) {\r\n        debugProfile(`failed to goto ${url}, error: ${error}`);\r\n      }\r\n    } else {\r\n      debugProfile(`page is already closed, skip goto ${url}`);\r\n    }\r\n  });\r\n}\r\n"],"names":["debugPage","getDebug","sanitizeXpaths","xpaths","Array","xpath","Page","defaultActions","commonWebActionsForWebPage","customActions","pageFunction","arg","result","script","error","console","DEFAULT_WAIT_FOR_NETWORK_IDLE_CONCURRENCY","tree","treeToList","id","elementInfosScriptContent","getElementInfosScriptContent","JSON","point","isOrderSensitive","rect","opt","center","Math","orderSensitive","sanitized","feature","webFeature","elementInfo","_this_viewportSize","matchedRect","Error","scripts","getExtraReturnLogic","assert","startTime","Date","captureElementSnapshot","endTime","sizeInfo","document","window","imgType","quality","base64","createImgBase64ByFormat","buffer","url","x","y","options","button","count","deltaX","deltaY","from","to","sleep","text","action","keys","k","commands","key","element","backspace","isMac","process","size","targetX","targetY","startingPoint","distance","innerHeight","scrollDistance","innerWidth","name","param","Promise","WebPageContextParser","duration","LONG_PRESS_THRESHOLD","MIN_PRESS_THRESHOLD","page","steps","delay","i","resolve","setTimeout","res","underlyingPage","interfaceType","opts","DEFAULT_WAIT_FOR_NAVIGATION_TIMEOUT","DEFAULT_WAIT_FOR_NETWORK_IDLE_TIMEOUT","forceClosePopup","debugProfile","popup"],"mappings":"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"}