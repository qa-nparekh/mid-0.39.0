{"version":3,"file":"puppeteer\\agent-launcher.mjs","sources":["webpack://@sqaitech/web/./src/puppeteer/agent-launcher.ts"],"sourcesContent":["import { readFileSync } from 'node:fs';\r\nimport { getDebug } from '@sqaitech/shared/logger';\r\nimport { assert } from '@sqaitech/shared/utils';\r\n\r\nimport { PuppeteerAgent } from '@/puppeteer/index';\r\nimport type { Cache, MidsceneYamlScriptWebEnv } from '@sqaitech/core';\r\nimport { DEFAULT_WAIT_FOR_NETWORK_IDLE_TIMEOUT } from '@sqaitech/shared/constants';\r\nimport puppeteer, { type Browser } from 'puppeteer';\r\n\r\nexport const defaultUA =\r\n  'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36';\r\nexport const defaultViewportWidth = 1440;\r\nexport const defaultViewportHeight = 768;\r\nexport const defaultViewportScale = process.platform === 'darwin' ? 2 : 1;\r\nexport const defaultWaitForNetworkIdleTimeout =\r\n  DEFAULT_WAIT_FOR_NETWORK_IDLE_TIMEOUT;\r\n\r\ninterface FreeFn {\r\n  name: string;\r\n  fn: () => void;\r\n}\r\n\r\nconst launcherDebug = getDebug('puppeteer:launcher');\r\n\r\nexport async function launchPuppeteerPage(\r\n  target: MidsceneYamlScriptWebEnv,\r\n  preference?: {\r\n    headed?: boolean;\r\n    keepWindow?: boolean;\r\n  },\r\n  browser?: Browser,\r\n) {\r\n  assert(target.url, 'url is required');\r\n  const freeFn: FreeFn[] = [];\r\n\r\n  // prepare the environment\r\n  const ua = target.userAgent || defaultUA;\r\n  let width = defaultViewportWidth;\r\n  let preferMaximizedWindow = true;\r\n  if (target.viewportWidth) {\r\n    preferMaximizedWindow = false;\r\n    assert(\r\n      typeof target.viewportWidth === 'number',\r\n      'viewportWidth must be a number',\r\n    );\r\n    width = Number.parseInt(target.viewportWidth as unknown as string, 10);\r\n    assert(width > 0, `viewportWidth must be greater than 0, but got ${width}`);\r\n  }\r\n  let height = defaultViewportHeight;\r\n  if (target.viewportHeight) {\r\n    preferMaximizedWindow = false;\r\n    assert(\r\n      typeof target.viewportHeight === 'number',\r\n      'viewportHeight must be a number',\r\n    );\r\n    height = Number.parseInt(target.viewportHeight as unknown as string, 10);\r\n    assert(\r\n      height > 0,\r\n      `viewportHeight must be greater than 0, but got ${height}`,\r\n    );\r\n  }\r\n  let dpr = defaultViewportScale;\r\n  if (target.viewportScale) {\r\n    preferMaximizedWindow = false;\r\n    assert(\r\n      typeof target.viewportScale === 'number',\r\n      'viewportScale must be a number',\r\n    );\r\n    dpr = Number.parseInt(target.viewportScale as unknown as string, 10);\r\n    assert(dpr > 0, `viewportScale must be greater than 0, but got ${dpr}`);\r\n  }\r\n  const viewportConfig = {\r\n    width,\r\n    height,\r\n    deviceScaleFactor: dpr,\r\n  };\r\n\r\n  const headed = preference?.headed || preference?.keepWindow;\r\n\r\n  // only maximize window in headed mode\r\n  preferMaximizedWindow = preferMaximizedWindow && !!headed;\r\n\r\n  // launch the browser\r\n  if (headed && process.env.CI === '1') {\r\n    console.warn(\r\n      'you are probably running headed mode in CI, this will usually fail.',\r\n    );\r\n  }\r\n  // do not use 'no-sandbox' on windows https://www.perplexity.ai/search/how-to-solve-this-with-nodejs-dMHpdCypRa..JA8TkQzbeQ\r\n  const isWindows = process.platform === 'win32';\r\n  const args = [\r\n    ...(isWindows ? [] : ['--no-sandbox', '--disable-setuid-sandbox']),\r\n    '--disable-features=HttpsFirstBalancedModeAutoEnable',\r\n    '--disable-features=PasswordLeakDetection',\r\n    '--disable-save-password-bubble',\r\n    `--user-agent=\"${ua}\"`,\r\n    preferMaximizedWindow\r\n      ? '--start-maximized'\r\n      : `--window-size=${width},${height + 200}`, // add 200px for the address bar\r\n  ];\r\n\r\n  launcherDebug(\r\n    'launching browser with viewport, headed',\r\n    headed,\r\n    'viewport',\r\n    viewportConfig,\r\n    'args',\r\n    args,\r\n    'preference',\r\n    preference,\r\n  );\r\n  let browserInstance = browser;\r\n  if (!browserInstance) {\r\n    browserInstance = await puppeteer.launch({\r\n      headless: !preference?.headed,\r\n      defaultViewport: viewportConfig,\r\n      args,\r\n      acceptInsecureCerts: target.acceptInsecureCerts,\r\n    });\r\n    freeFn.push({\r\n      name: 'puppeteer_browser',\r\n      fn: () => {\r\n        if (!preference?.keepWindow) {\r\n          if (isWindows) {\r\n            setTimeout(() => {\r\n              browserInstance?.close();\r\n            }, 800);\r\n          } else {\r\n            browserInstance?.close();\r\n          }\r\n        }\r\n      },\r\n    });\r\n  }\r\n  const page = await browserInstance.newPage();\r\n  // await page.setUserAgent(ua);\r\n  // await page.setViewport(viewportConfig);\r\n\r\n  if (target.cookie) {\r\n    const cookieFileContent = readFileSync(target.cookie, 'utf-8');\r\n    await browserInstance.setCookie(...JSON.parse(cookieFileContent));\r\n  }\r\n\r\n  if (ua) {\r\n    await page.setUserAgent(ua);\r\n  }\r\n\r\n  if (viewportConfig) {\r\n    await page.setViewport(viewportConfig);\r\n  }\r\n\r\n  const waitForNetworkIdleTimeout =\r\n    typeof target.waitForNetworkIdle?.timeout === 'number'\r\n      ? target.waitForNetworkIdle.timeout\r\n      : defaultWaitForNetworkIdleTimeout;\r\n\r\n  try {\r\n    launcherDebug('goto', target.url);\r\n    await page.goto(target.url);\r\n    if (waitForNetworkIdleTimeout > 0) {\r\n      launcherDebug('waitForNetworkIdle', waitForNetworkIdleTimeout);\r\n      await page.waitForNetworkIdle({\r\n        timeout: waitForNetworkIdleTimeout,\r\n      });\r\n    }\r\n  } catch (e) {\r\n    if (\r\n      typeof target.waitForNetworkIdle?.continueOnNetworkIdleError ===\r\n        'boolean' &&\r\n      !target.waitForNetworkIdle?.continueOnNetworkIdleError\r\n    ) {\r\n      const newError = new Error(`failed to wait for network idle: ${e}`, {\r\n        cause: e,\r\n      });\r\n      throw newError;\r\n    }\r\n    const newMessage = `failed to wait for network idle after ${waitForNetworkIdleTimeout}ms, but the script will continue.`;\r\n    console.warn(newMessage);\r\n  }\r\n\r\n  return { page, freeFn };\r\n}\r\n\r\nexport async function puppeteerAgentForTarget(\r\n  target: MidsceneYamlScriptWebEnv,\r\n  preference?: {\r\n    headed?: boolean;\r\n    keepWindow?: boolean;\r\n    testId?: string;\r\n    cache?: Cache;\r\n  },\r\n  browser?: Browser,\r\n) {\r\n  const { page, freeFn } = await launchPuppeteerPage(\r\n    target,\r\n    preference,\r\n    browser,\r\n  );\r\n\r\n  // prepare Midscene agent\r\n  const agent = new PuppeteerAgent(page, {\r\n    autoPrintReportMsg: false,\r\n    testId: preference?.testId,\r\n    cache: preference?.cache,\r\n    aiActionContext: target.aiActionContext,\r\n    forceSameTabNavigation:\r\n      typeof target.forceSameTabNavigation !== 'undefined'\r\n        ? target.forceSameTabNavigation\r\n        : true, // true for default in yaml script\r\n  });\r\n\r\n  freeFn.push({\r\n    name: 'midscene_puppeteer_agent',\r\n    fn: () => agent.destroy(),\r\n  });\r\n\r\n  return { agent, freeFn };\r\n}\r\n"],"names":["defaultUA","defaultViewportWidth","defaultViewportHeight","defaultViewportScale","process","defaultWaitForNetworkIdleTimeout","DEFAULT_WAIT_FOR_NETWORK_IDLE_TIMEOUT","launcherDebug","getDebug","launchPuppeteerPage","target","preference","browser","_target_waitForNetworkIdle","assert","freeFn","ua","width","preferMaximizedWindow","Number","height","dpr","viewportConfig","headed","console","isWindows","args","browserInstance","puppeteer","setTimeout","page","cookieFileContent","readFileSync","JSON","waitForNetworkIdleTimeout","e","_target_waitForNetworkIdle1","_target_waitForNetworkIdle2","newError","Error","newMessage","puppeteerAgentForTarget","agent","PuppeteerAgent"],"mappings":"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"}