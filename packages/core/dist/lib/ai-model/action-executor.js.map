{"version":3,"file":"ai-model\\action-executor.js","sources":["webpack://@sqaitech/core/webpack/runtime/define_property_getters","webpack://@sqaitech/core/webpack/runtime/has_own_property","webpack://@sqaitech/core/webpack/runtime/make_namespace_object","webpack://@sqaitech/core/./src/ai-model/action-executor.ts"],"sourcesContent":["__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n        if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n            Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n        }\n    }\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","import type {\r\n  ExecutionDump,\r\n  ExecutionTask,\r\n  ExecutionTaskApply,\r\n  ExecutionTaskInsightLocateOutput,\r\n  ExecutionTaskProgressOptions,\r\n  ExecutionTaskReturn,\r\n  ExecutorContext,\r\n} from '@/types';\r\nimport { assert } from '@sqaitech/shared/utils';\r\n\r\nexport class Executor {\r\n  name: string;\r\n\r\n  tasks: ExecutionTask[];\r\n\r\n  // status of executor\r\n  status: 'init' | 'pending' | 'running' | 'completed' | 'error';\r\n\r\n  onTaskStart?: ExecutionTaskProgressOptions['onTaskStart'];\r\n\r\n  constructor(\r\n    name: string,\r\n    options?: ExecutionTaskProgressOptions & {\r\n      tasks?: ExecutionTaskApply[];\r\n    },\r\n  ) {\r\n    this.status =\r\n      options?.tasks && options.tasks.length > 0 ? 'pending' : 'init';\r\n    this.name = name;\r\n    this.tasks = (options?.tasks || []).map((item) =>\r\n      this.markTaskAsPending(item),\r\n    );\r\n    this.onTaskStart = options?.onTaskStart;\r\n  }\r\n\r\n  private markTaskAsPending(task: ExecutionTaskApply): ExecutionTask {\r\n    return {\r\n      status: 'pending',\r\n      ...task,\r\n    };\r\n  }\r\n\r\n  async append(task: ExecutionTaskApply[] | ExecutionTaskApply): Promise<void> {\r\n    assert(\r\n      this.status !== 'error',\r\n      `executor is in error state, cannot append task\\nerror=${this.latestErrorTask()?.error}\\n${this.latestErrorTask()?.errorStack}`,\r\n    );\r\n    if (Array.isArray(task)) {\r\n      this.tasks.push(...task.map((item) => this.markTaskAsPending(item)));\r\n    } else {\r\n      this.tasks.push(this.markTaskAsPending(task));\r\n    }\r\n    if (this.status !== 'running') {\r\n      this.status = 'pending';\r\n    }\r\n  }\r\n\r\n  async flush(): Promise<{ output: any; thought?: string } | undefined> {\r\n    if (this.status === 'init' && this.tasks.length > 0) {\r\n      console.warn(\r\n        'illegal state for executor, status is init but tasks are not empty',\r\n      );\r\n    }\r\n\r\n    assert(this.status !== 'running', 'executor is already running');\r\n    assert(this.status !== 'completed', 'executor is already completed');\r\n    assert(this.status !== 'error', 'executor is in error state');\r\n\r\n    const nextPendingIndex = this.tasks.findIndex(\r\n      (task) => task.status === 'pending',\r\n    );\r\n    if (nextPendingIndex < 0) {\r\n      // all tasks are completed\r\n      return;\r\n    }\r\n\r\n    this.status = 'running';\r\n    let taskIndex = nextPendingIndex;\r\n    let successfullyCompleted = true;\r\n\r\n    let previousFindOutput: ExecutionTaskInsightLocateOutput | undefined;\r\n\r\n    while (taskIndex < this.tasks.length) {\r\n      const task = this.tasks[taskIndex];\r\n      assert(\r\n        task.status === 'pending',\r\n        `task status should be pending, but got: ${task.status}`,\r\n      );\r\n      task.timing = {\r\n        start: Date.now(),\r\n      };\r\n      try {\r\n        task.status = 'running';\r\n        try {\r\n          if (this.onTaskStart) {\r\n            await this.onTaskStart(task);\r\n          }\r\n        } catch (e) {\r\n          console.error('error in onTaskStart', e);\r\n        }\r\n        assert(\r\n          ['Insight', 'Action', 'Planning'].indexOf(task.type) >= 0,\r\n          `unsupported task type: ${task.type}`,\r\n        );\r\n\r\n        const { executor, param } = task;\r\n        assert(executor, `executor is required for task type: ${task.type}`);\r\n\r\n        let returnValue;\r\n        const executorContext: ExecutorContext = {\r\n          task,\r\n          element: previousFindOutput?.element,\r\n        };\r\n\r\n        if (task.type === 'Insight') {\r\n          assert(\r\n            task.subType === 'Locate' ||\r\n              task.subType === 'Query' ||\r\n              task.subType === 'Assert' ||\r\n              task.subType === 'WaitFor' ||\r\n              task.subType === 'Boolean' ||\r\n              task.subType === 'Number' ||\r\n              task.subType === 'String',\r\n            `unsupported insight subType: ${task.subType}`,\r\n          );\r\n          returnValue = await task.executor(param, executorContext);\r\n          if (task.subType === 'Locate') {\r\n            previousFindOutput = (\r\n              returnValue as ExecutionTaskReturn<ExecutionTaskInsightLocateOutput>\r\n            )?.output;\r\n          }\r\n        } else if (task.type === 'Action' || task.type === 'Planning') {\r\n          returnValue = await task.executor(param, executorContext);\r\n        } else {\r\n          console.warn(\r\n            `unsupported task type: ${task.type}, will try to execute it directly`,\r\n          );\r\n          returnValue = await task.executor(param, executorContext);\r\n        }\r\n\r\n        Object.assign(task, returnValue);\r\n        task.status = 'finished';\r\n        task.timing.end = Date.now();\r\n        task.timing.cost = task.timing.end - task.timing.start;\r\n        taskIndex++;\r\n      } catch (e: any) {\r\n        successfullyCompleted = false;\r\n        task.error = e;\r\n        task.errorMessage =\r\n          e?.message || (typeof e === 'string' ? e : 'error-without-message');\r\n        task.errorStack = e.stack;\r\n\r\n        task.status = 'failed';\r\n        task.timing.end = Date.now();\r\n        task.timing.cost = task.timing.end - task.timing.start;\r\n        break;\r\n      }\r\n    }\r\n\r\n    // set all remaining tasks as cancelled\r\n    for (let i = taskIndex + 1; i < this.tasks.length; i++) {\r\n      this.tasks[i].status = 'cancelled';\r\n    }\r\n\r\n    if (successfullyCompleted) {\r\n      this.status = 'completed';\r\n    } else {\r\n      this.status = 'error';\r\n    }\r\n\r\n    if (this.tasks.length) {\r\n      // return the last output\r\n      const outputIndex = Math.min(taskIndex, this.tasks.length - 1);\r\n      const { thought, output } = this.tasks[outputIndex];\r\n      return {\r\n        thought,\r\n        output,\r\n      };\r\n    }\r\n  }\r\n\r\n  isInErrorState(): boolean {\r\n    return this.status === 'error';\r\n  }\r\n\r\n  latestErrorTask(): ExecutionTask | null {\r\n    if (this.status !== 'error') {\r\n      return null;\r\n    }\r\n    const errorTaskIndex = this.tasks.findIndex(\r\n      (task) => task.status === 'failed',\r\n    );\r\n    if (errorTaskIndex >= 0) {\r\n      return this.tasks[errorTaskIndex];\r\n    }\r\n    return null;\r\n  }\r\n\r\n  dump(): ExecutionDump {\r\n    const dumpData: ExecutionDump = {\r\n      logTime: Date.now(),\r\n      name: this.name,\r\n      tasks: this.tasks,\r\n    };\r\n    return dumpData;\r\n  }\r\n}\r\n"],"names":["__webpack_require__","definition","key","Object","obj","prop","Symbol","Executor","task","_this_latestErrorTask","_this_latestErrorTask1","assert","Array","item","console","nextPendingIndex","taskIndex","successfullyCompleted","previousFindOutput","Date","e","executor","param","returnValue","executorContext","i","outputIndex","Math","thought","output","errorTaskIndex","dumpData","name","options"],"mappings":"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"}