{"version":3,"file":"insight\\index.mjs","sources":["webpack://@sqai/core/./src/insight/index.ts"],"sourcesContent":["import { AIActionType, type AIArgs, expandSearchArea } from '@/ai-model/common';\r\nimport {\r\n  AiExtractElementInfo,\r\n  AiLocateElement,\r\n  callAIWithObjectResponse,\r\n} from '@/ai-model/index';\r\nimport { AiLocateSection } from '@/ai-model/inspect';\r\nimport { elementDescriberInstruction } from '@/ai-model/prompt/describe';\r\nimport type {\r\n  AIDescribeElementResponse,\r\n  AIUsageInfo,\r\n  BaseElement,\r\n  DetailedLocateParam,\r\n  DumpSubscriber,\r\n  InsightAction,\r\n  InsightExtractOption,\r\n  InsightExtractParam,\r\n  InsightTaskInfo,\r\n  LocateResult,\r\n  PartialInsightDumpFromSDK,\r\n  Rect,\r\n  UIContext,\r\n} from '@/types';\r\nimport {\r\n  type IModelConfig,\r\n  SQAI_FORCE_DEEP_THINK,\r\n  globalConfigManager,\r\n} from '@sqai/shared/env';\r\nimport { compositeElementInfoImg, cropByRect } from '@sqai/shared/img';\r\nimport { getDebug } from '@sqai/shared/logger';\r\nimport { assert } from '@sqai/shared/utils';\r\nimport type { TMultimodalPrompt } from '../ai-model/common';\r\nimport { emitInsightDump } from './utils';\r\n\r\nexport interface LocateOpts {\r\n  context?: UIContext<BaseElement>;\r\n}\r\n\r\nexport type AnyValue<T> = {\r\n  [K in keyof T]: unknown extends T[K] ? any : T[K];\r\n};\r\n\r\ninterface InsightOptions {\r\n  taskInfo?: Omit<InsightTaskInfo, 'durationMs'>;\r\n  aiVendorFn?: typeof callAIWithObjectResponse;\r\n}\r\n\r\nconst debug = getDebug('ai:insight');\r\nexport default class Insight<\r\n  ElementType extends BaseElement = BaseElement,\r\n  ContextType extends UIContext<ElementType> = UIContext<ElementType>,\r\n> {\r\n  contextRetrieverFn: (\r\n    action: InsightAction,\r\n  ) => Promise<ContextType> | ContextType;\r\n\r\n  aiVendorFn: Exclude<InsightOptions['aiVendorFn'], undefined> =\r\n    callAIWithObjectResponse;\r\n\r\n  onceDumpUpdatedFn?: DumpSubscriber;\r\n\r\n  taskInfo?: Omit<InsightTaskInfo, 'durationMs'>;\r\n\r\n  constructor(\r\n    context:\r\n      | ContextType\r\n      | ((action: InsightAction) => Promise<ContextType> | ContextType),\r\n    opt?: InsightOptions,\r\n  ) {\r\n    assert(context, 'context is required for Insight');\r\n    if (typeof context === 'function') {\r\n      this.contextRetrieverFn = context;\r\n    } else {\r\n      this.contextRetrieverFn = () => Promise.resolve(context);\r\n    }\r\n\r\n    // just for unit test, aiVendorFn is callAIWithObjectResponse by default\r\n    if (typeof opt?.aiVendorFn !== 'undefined') {\r\n      this.aiVendorFn = opt.aiVendorFn;\r\n    }\r\n    if (typeof opt?.taskInfo !== 'undefined') {\r\n      this.taskInfo = opt.taskInfo;\r\n    }\r\n  }\r\n\r\n  async locate(\r\n    query: DetailedLocateParam,\r\n    opt: LocateOpts,\r\n    modelConfig: IModelConfig,\r\n  ): Promise<LocateResult> {\r\n    const queryPrompt = typeof query === 'string' ? query : query.prompt;\r\n    assert(queryPrompt, 'query is required for locate');\r\n    const dumpSubscriber = this.onceDumpUpdatedFn;\r\n    this.onceDumpUpdatedFn = undefined;\r\n\r\n    assert(typeof query === 'object', 'query should be an object for locate');\r\n\r\n    const globalDeepThinkSwitch = globalConfigManager.getEnvConfigInBoolean(\r\n      SQAI_FORCE_DEEP_THINK,\r\n    );\r\n    if (globalDeepThinkSwitch) {\r\n      debug('globalDeepThinkSwitch', globalDeepThinkSwitch);\r\n    }\r\n    let searchAreaPrompt;\r\n    if (query.deepThink || globalDeepThinkSwitch) {\r\n      searchAreaPrompt = query.prompt;\r\n    }\r\n\r\n    const { vlMode } = modelConfig;\r\n\r\n    if (searchAreaPrompt && !vlMode) {\r\n      console.warn(\r\n        'The \"deepThink\" feature is not supported with multimodal LLM. Please config VL model for Midscene. https://midscenejs.com/choose-a-model',\r\n      );\r\n      searchAreaPrompt = undefined;\r\n    }\r\n\r\n    const context = opt?.context || (await this.contextRetrieverFn('locate'));\r\n\r\n    let searchArea: Rect | undefined = undefined;\r\n    let searchAreaRawResponse: string | undefined = undefined;\r\n    let searchAreaUsage: AIUsageInfo | undefined = undefined;\r\n    let searchAreaResponse:\r\n      | Awaited<ReturnType<typeof AiLocateSection>>\r\n      | undefined = undefined;\r\n    if (searchAreaPrompt) {\r\n      searchAreaResponse = await AiLocateSection({\r\n        context,\r\n        sectionDescription: searchAreaPrompt,\r\n        modelConfig,\r\n      });\r\n      assert(\r\n        searchAreaResponse.rect,\r\n        `cannot find search area for \"${searchAreaPrompt}\"${\r\n          searchAreaResponse.error ? `: ${searchAreaResponse.error}` : ''\r\n        }`,\r\n      );\r\n      searchAreaRawResponse = searchAreaResponse.rawResponse;\r\n      searchAreaUsage = searchAreaResponse.usage;\r\n      searchArea = searchAreaResponse.rect;\r\n    }\r\n\r\n    const startTime = Date.now();\r\n    const {\r\n      parseResult,\r\n      rect,\r\n      elementById,\r\n      rawResponse,\r\n      usage,\r\n      isOrderSensitive,\r\n    } = await AiLocateElement({\r\n      callAIFn: this.aiVendorFn,\r\n      context,\r\n      targetElementDescription: queryPrompt,\r\n      searchConfig: searchAreaResponse,\r\n      modelConfig,\r\n    });\r\n\r\n    const timeCost = Date.now() - startTime;\r\n    const taskInfo: InsightTaskInfo = {\r\n      ...(this.taskInfo ? this.taskInfo : {}),\r\n      durationMs: timeCost,\r\n      rawResponse: JSON.stringify(rawResponse),\r\n      formatResponse: JSON.stringify(parseResult),\r\n      usage,\r\n      searchArea,\r\n      searchAreaRawResponse,\r\n      searchAreaUsage,\r\n    };\r\n\r\n    let errorLog: string | undefined;\r\n    if (parseResult.errors?.length) {\r\n      errorLog = `AI model failed to locate: \\n${parseResult.errors.join('\\n')}`;\r\n    }\r\n\r\n    const dumpData: PartialInsightDumpFromSDK = {\r\n      type: 'locate',\r\n      userQuery: {\r\n        element: queryPrompt,\r\n      },\r\n      matchedElement: [],\r\n      matchedRect: rect,\r\n      data: null,\r\n      taskInfo,\r\n      deepThink: !!searchArea,\r\n      error: errorLog,\r\n    };\r\n\r\n    const elements: BaseElement[] = [];\r\n    (parseResult.elements || []).forEach((item) => {\r\n      if ('id' in item) {\r\n        const element = elementById(item?.id);\r\n\r\n        if (!element) {\r\n          console.warn(\r\n            `locate: cannot find element id=${item.id}. Maybe an unstable response from AI model`,\r\n          );\r\n          return;\r\n        }\r\n        elements.push(element);\r\n      }\r\n    });\r\n\r\n    emitInsightDump(\r\n      {\r\n        ...dumpData,\r\n        matchedElement: elements,\r\n      },\r\n      dumpSubscriber,\r\n    );\r\n\r\n    if (errorLog) {\r\n      throw new Error(errorLog);\r\n    }\r\n\r\n    assert(\r\n      elements.length <= 1,\r\n      `locate: multiple elements found, length = ${elements.length}`,\r\n    );\r\n\r\n    if (elements.length === 1) {\r\n      return {\r\n        element: {\r\n          id: elements[0]!.id,\r\n          indexId: elements[0]!.indexId,\r\n          center: elements[0]!.center,\r\n          rect: elements[0]!.rect,\r\n          xpaths: elements[0]!.xpaths || [],\r\n          attributes: elements[0]!.attributes,\r\n          isOrderSensitive,\r\n        },\r\n        rect,\r\n      };\r\n    }\r\n    return {\r\n      element: null,\r\n      rect,\r\n    };\r\n  }\r\n\r\n  async extract<T>(\r\n    dataDemand: InsightExtractParam,\r\n    modelConfig: IModelConfig,\r\n    opt?: InsightExtractOption,\r\n    multimodalPrompt?: TMultimodalPrompt,\r\n  ): Promise<{\r\n    data: T;\r\n    thought?: string;\r\n    usage?: AIUsageInfo;\r\n  }> {\r\n    assert(\r\n      typeof dataDemand === 'object' || typeof dataDemand === 'string',\r\n      `dataDemand should be object or string, but get ${typeof dataDemand}`,\r\n    );\r\n    const dumpSubscriber = this.onceDumpUpdatedFn;\r\n    this.onceDumpUpdatedFn = undefined;\r\n\r\n    const context = await this.contextRetrieverFn('extract');\r\n\r\n    const startTime = Date.now();\r\n\r\n    const { parseResult, usage } = await AiExtractElementInfo<T>({\r\n      context,\r\n      dataQuery: dataDemand,\r\n      multimodalPrompt,\r\n      extractOption: opt,\r\n      modelConfig,\r\n    });\r\n\r\n    const timeCost = Date.now() - startTime;\r\n    const taskInfo: InsightTaskInfo = {\r\n      ...(this.taskInfo ? this.taskInfo : {}),\r\n      durationMs: timeCost,\r\n      rawResponse: JSON.stringify(parseResult),\r\n    };\r\n\r\n    let errorLog: string | undefined;\r\n    if (parseResult.errors?.length) {\r\n      errorLog = `AI response error: \\n${parseResult.errors.join('\\n')}`;\r\n    }\r\n\r\n    const dumpData: PartialInsightDumpFromSDK = {\r\n      type: 'extract',\r\n      userQuery: {\r\n        dataDemand,\r\n      },\r\n      matchedElement: [],\r\n      data: null,\r\n      taskInfo,\r\n      error: errorLog,\r\n    };\r\n\r\n    const { data, thought } = parseResult || {};\r\n\r\n    // 4\r\n    emitInsightDump(\r\n      {\r\n        ...dumpData,\r\n        data,\r\n      },\r\n      dumpSubscriber,\r\n    );\r\n\r\n    if (errorLog && !data && !opt?.doNotThrowError) {\r\n      throw new Error(errorLog);\r\n    }\r\n\r\n    return {\r\n      data,\r\n      thought,\r\n      usage,\r\n    };\r\n  }\r\n\r\n  async describe(\r\n    target: Rect | [number, number],\r\n    modelConfig: IModelConfig,\r\n    opt?: {\r\n      deepThink?: boolean;\r\n    },\r\n  ): Promise<Pick<AIDescribeElementResponse, 'description'>> {\r\n    assert(target, 'target is required for insight.describe');\r\n    const context = await this.contextRetrieverFn('describe');\r\n    const { screenshotBase64, size } = context;\r\n    assert(screenshotBase64, 'screenshot is required for insight.describe');\r\n    // The result of the \"describe\" function will be used for positioning, so essentially it is a form of grounding.\r\n    const { vlMode } = modelConfig;\r\n    const systemPrompt = elementDescriberInstruction();\r\n\r\n    // Convert [x,y] center point to Rect if needed\r\n    const defaultRectSize = 30;\r\n    const targetRect: Rect = Array.isArray(target)\r\n      ? {\r\n          left: Math.floor(target[0] - defaultRectSize / 2),\r\n          top: Math.floor(target[1] - defaultRectSize / 2),\r\n          width: defaultRectSize,\r\n          height: defaultRectSize,\r\n        }\r\n      : target;\r\n\r\n    let imagePayload = await compositeElementInfoImg({\r\n      inputImgBase64: screenshotBase64,\r\n      size,\r\n      elementsPositionInfo: [\r\n        {\r\n          rect: targetRect,\r\n        },\r\n      ],\r\n      borderThickness: 3,\r\n    });\r\n\r\n    if (opt?.deepThink) {\r\n      const searchArea = expandSearchArea(targetRect, context.size, vlMode);\r\n      debug('describe: set searchArea', searchArea);\r\n      const croppedResult = await cropByRect(\r\n        imagePayload,\r\n        searchArea,\r\n        vlMode === 'qwen-vl',\r\n      );\r\n      imagePayload = croppedResult.imageBase64;\r\n    }\r\n\r\n    const msgs: AIArgs = [\r\n      { role: 'system', content: systemPrompt },\r\n      {\r\n        role: 'user',\r\n        content: [\r\n          {\r\n            type: 'image_url',\r\n            image_url: {\r\n              url: imagePayload,\r\n              detail: 'high',\r\n            },\r\n          },\r\n        ],\r\n      },\r\n    ];\r\n\r\n    const callAIFn = this\r\n      .aiVendorFn as typeof callAIWithObjectResponse<AIDescribeElementResponse>;\r\n\r\n    const res = await callAIFn(\r\n      msgs,\r\n      AIActionType.DESCRIBE_ELEMENT,\r\n      modelConfig,\r\n    );\r\n\r\n    const { content } = res;\r\n    assert(!content.error, `describe failed: ${content.error}`);\r\n    assert(content.description, 'failed to describe the element');\r\n    return content;\r\n  }\r\n}\r\n"],"names":["debug","getDebug","Insight","query","opt","modelConfig","_parseResult_errors","queryPrompt","assert","dumpSubscriber","undefined","globalDeepThinkSwitch","globalConfigManager","SQAI_FORCE_DEEP_THINK","searchAreaPrompt","vlMode","console","context","searchArea","searchAreaRawResponse","searchAreaUsage","searchAreaResponse","AiLocateSection","startTime","Date","parseResult","rect","elementById","rawResponse","usage","isOrderSensitive","AiLocateElement","timeCost","taskInfo","JSON","errorLog","dumpData","elements","item","element","emitInsightDump","Error","dataDemand","multimodalPrompt","AiExtractElementInfo","data","thought","target","screenshotBase64","size","systemPrompt","elementDescriberInstruction","defaultRectSize","targetRect","Array","Math","imagePayload","compositeElementInfoImg","expandSearchArea","croppedResult","cropByRect","msgs","callAIFn","res","AIActionType","content","callAIWithObjectResponse","Promise"],"mappings":"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"}