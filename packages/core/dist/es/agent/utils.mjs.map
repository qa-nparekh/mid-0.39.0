{"version":3,"file":"agent\\utils.mjs","sources":["webpack://@sqaitech/core/./src/agent/utils.ts"],"sourcesContent":["import { elementByPositionWithElementInfo } from '@/ai-model';\r\nimport type { TMultimodalPrompt, TUserPrompt } from '@/ai-model/common';\r\nimport type { AbstractInterface } from '@/device';\r\nimport type {\r\n  BaseElement,\r\n  ElementCacheFeature,\r\n  ElementTreeNode,\r\n  ExecutionDump,\r\n  ExecutionTask,\r\n  ExecutorContext,\r\n  LocateResultElement,\r\n  PlanningLocateParam,\r\n  UIContext,\r\n} from '@/types';\r\nimport { uploadTestInfoToServer } from '@/utils';\r\nimport { NodeType } from '@sqaitech/shared/constants';\r\nimport {\r\n  SQAI_REPORT_TAG_NAME,\r\n  globalConfigManager,\r\n} from '@sqaitech/shared/env';\r\nimport {\r\n  generateElementByPosition,\r\n  getNodeFromCacheList,\r\n} from '@sqaitech/shared/extractor';\r\nimport { resizeImgBase64 } from '@sqaitech/shared/img';\r\nimport { getDebug } from '@sqaitech/shared/logger';\r\nimport { _keyDefinitions } from '@sqaitech/shared/us-keyboard-layout';\r\nimport { assert, logMsg, uuid } from '@sqaitech/shared/utils';\r\nimport dayjs from 'dayjs';\r\nimport { debug as cacheDebug } from './task-cache';\r\nimport type { TaskExecutor } from './tasks';\r\n\r\nconst debugProfile = getDebug('web:tool:profile');\r\n\r\nexport async function commonContextParser(\r\n  interfaceInstance: AbstractInterface,\r\n  _opt: { uploadServerUrl?: string },\r\n): Promise<UIContext> {\r\n  assert(interfaceInstance, 'interfaceInstance is required');\r\n\r\n  debugProfile('Getting interface description');\r\n  const description = interfaceInstance.describe?.() || '';\r\n  debugProfile('Interface description end');\r\n\r\n  debugProfile('Uploading test info to server');\r\n  uploadTestInfoToServer({\r\n    testUrl: description,\r\n    serverUrl: _opt.uploadServerUrl,\r\n  });\r\n  debugProfile('UploadTestInfoToServer end');\r\n\r\n  const screenshotBase64 = await interfaceInstance.screenshotBase64();\r\n  assert(screenshotBase64!, 'screenshotBase64 is required');\r\n\r\n  const size = await interfaceInstance.size();\r\n  debugProfile(`size: ${size.width}x${size.height} dpr: ${size.dpr}`);\r\n\r\n  return {\r\n    tree: {\r\n      node: null,\r\n      children: [],\r\n    },\r\n    size,\r\n    screenshotBase64: screenshotBase64!,\r\n  };\r\n}\r\n\r\nexport function getReportFileName(tag = 'web') {\r\n  const reportTagName = globalConfigManager.getEnvConfigValue(\r\n    SQAI_REPORT_TAG_NAME,\r\n  );\r\n  const dateTimeInFileName = dayjs().format('YYYY-MM-DD_HH-mm-ss');\r\n  // ensure uniqueness at the same time\r\n  const uniqueId = uuid().substring(0, 8);\r\n  return `${reportTagName || tag}-${dateTimeInFileName}-${uniqueId}`;\r\n}\r\n\r\nexport function printReportMsg(filepath: string) {\r\n  logMsg(`Midscene - report file updated: ${filepath}`);\r\n}\r\n\r\n/**\r\n * Get the current execution file name\r\n * @returns The name of the current execution file\r\n */\r\nexport function getCurrentExecutionFile(trace?: string): string | false {\r\n  const error = new Error();\r\n  const stackTrace = trace || error.stack;\r\n  const pkgDir = process.cwd() || '';\r\n  if (stackTrace) {\r\n    const stackLines = stackTrace.split('\\n');\r\n    for (const line of stackLines) {\r\n      if (\r\n        line.includes('.spec.') ||\r\n        line.includes('.test.') ||\r\n        line.includes('.ts') ||\r\n        line.includes('.js')\r\n      ) {\r\n        const match = line.match(/(?:at\\s+)?(.*?\\.(?:spec|test)\\.[jt]s)/);\r\n        if (match?.[1]) {\r\n          const targetFileName = match[1]\r\n            .replace(pkgDir, '')\r\n            .trim()\r\n            .replace('at ', '');\r\n          return targetFileName;\r\n        }\r\n      }\r\n    }\r\n  }\r\n  return false;\r\n}\r\n\r\nconst testFileIndex = new Map<string, number>();\r\n\r\nexport function generateCacheId(fileName?: string): string {\r\n  let taskFile = fileName || getCurrentExecutionFile();\r\n  if (!taskFile) {\r\n    taskFile = uuid();\r\n    console.warn(\r\n      'Midscene - using random UUID for cache id. Cache may be invalid.',\r\n    );\r\n  }\r\n\r\n  if (testFileIndex.has(taskFile)) {\r\n    const currentIndex = testFileIndex.get(taskFile);\r\n    if (currentIndex !== undefined) {\r\n      testFileIndex.set(taskFile, currentIndex + 1);\r\n    }\r\n  } else {\r\n    testFileIndex.set(taskFile, 1);\r\n  }\r\n  return `${taskFile}-${testFileIndex.get(taskFile)}`;\r\n}\r\n\r\nexport function matchElementFromPlan(\r\n  planLocateParam: PlanningLocateParam,\r\n  tree: ElementTreeNode<BaseElement>,\r\n) {\r\n  if (!planLocateParam) {\r\n    return undefined;\r\n  }\r\n  if (planLocateParam.id) {\r\n    return getNodeFromCacheList(planLocateParam.id);\r\n  }\r\n\r\n  if (planLocateParam.bbox) {\r\n    const centerPosition = {\r\n      x: Math.floor((planLocateParam.bbox[0] + planLocateParam.bbox[2]) / 2),\r\n      y: Math.floor((planLocateParam.bbox[1] + planLocateParam.bbox[3]) / 2),\r\n    };\r\n    let element = elementByPositionWithElementInfo(tree, centerPosition);\r\n\r\n    if (!element) {\r\n      element = generateElementByPosition(centerPosition) as BaseElement;\r\n    }\r\n\r\n    return element;\r\n  }\r\n\r\n  return undefined;\r\n}\r\n\r\nexport async function matchElementFromCache(\r\n  taskExecutor: TaskExecutor,\r\n  cacheEntry: ElementCacheFeature | undefined,\r\n  cachePrompt: TUserPrompt,\r\n  cacheable: boolean | undefined,\r\n): Promise<LocateResultElement | undefined> {\r\n  if (!cacheEntry) {\r\n    return undefined;\r\n  }\r\n\r\n  if (cacheable === false) {\r\n    cacheDebug('cache disabled for prompt: %s', cachePrompt);\r\n    return undefined;\r\n  }\r\n\r\n  if (!taskExecutor.taskCache?.isCacheResultUsed) {\r\n    return undefined;\r\n  }\r\n\r\n  if (!taskExecutor.interface.rectMatchesCacheFeature) {\r\n    cacheDebug(\r\n      'interface does not implement rectMatchesCacheFeature, skip cache',\r\n    );\r\n    return undefined;\r\n  }\r\n\r\n  try {\r\n    const rect =\r\n      await taskExecutor.interface.rectMatchesCacheFeature(cacheEntry);\r\n    const element: LocateResultElement = {\r\n      id: uuid(),\r\n      center: [\r\n        Math.round(rect.left + rect.width / 2),\r\n        Math.round(rect.top + rect.height / 2),\r\n      ],\r\n      rect,\r\n      xpaths: [],\r\n      attributes: {\r\n        nodeType: NodeType.POSITION,\r\n      },\r\n    };\r\n\r\n    cacheDebug('cache hit, prompt: %s', cachePrompt);\r\n    return element;\r\n  } catch (error) {\r\n    cacheDebug('rectMatchesCacheFeature error: %s', error);\r\n    return undefined;\r\n  }\r\n}\r\n\r\nexport function trimContextByViewport(execution: ExecutionDump) {\r\n  function filterVisibleTree(\r\n    node: ElementTreeNode<BaseElement>,\r\n  ): ElementTreeNode<BaseElement> | null {\r\n    if (!node) return null;\r\n\r\n    // recursively process all children\r\n    const filteredChildren = Array.isArray(node.children)\r\n      ? (node.children\r\n          .map(filterVisibleTree)\r\n          .filter((child) => child !== null) as ElementTreeNode<BaseElement>[])\r\n      : [];\r\n\r\n    // if the current node is visible, keep it and the filtered children\r\n    if (node.node && node.node.isVisible === true) {\r\n      return {\r\n        ...node,\r\n        children: filteredChildren,\r\n      };\r\n    }\r\n\r\n    // if the current node is invisible, but has visible children, create an empty node to include these children\r\n    if (filteredChildren.length > 0) {\r\n      return {\r\n        node: null,\r\n        children: filteredChildren,\r\n      };\r\n    }\r\n\r\n    // if the current node is invisible and has no visible children, return null\r\n    return null;\r\n  }\r\n\r\n  return {\r\n    ...execution,\r\n    tasks: Array.isArray(execution.tasks)\r\n      ? execution.tasks.map((task: ExecutionTask) => {\r\n          const newTask = { ...task };\r\n          if (task.uiContext?.tree) {\r\n            newTask.uiContext = {\r\n              ...task.uiContext,\r\n              tree: filterVisibleTree(task.uiContext.tree) || {\r\n                node: null,\r\n                children: [],\r\n              },\r\n            };\r\n          }\r\n          return newTask;\r\n        })\r\n      : execution.tasks,\r\n  };\r\n}\r\n\r\ndeclare const __VERSION__: string | undefined;\r\n\r\nexport const getMidsceneVersion = (): string => {\r\n  if (typeof __VERSION__ !== 'undefined') {\r\n    return __VERSION__;\r\n  } else if (\r\n    process.env.__VERSION__ &&\r\n    process.env.__VERSION__ !== 'undefined'\r\n  ) {\r\n    return process.env.__VERSION__;\r\n  }\r\n  throw new Error('__VERSION__ inject failed during build');\r\n};\r\n\r\nexport const getSqaiVersion = getMidsceneVersion;\r\n\r\nexport const parsePrompt = (\r\n  prompt: TUserPrompt,\r\n): {\r\n  textPrompt: string;\r\n  multimodalPrompt?: TMultimodalPrompt;\r\n} => {\r\n  if (typeof prompt === 'string') {\r\n    return {\r\n      textPrompt: prompt,\r\n      multimodalPrompt: undefined,\r\n    };\r\n  }\r\n  return {\r\n    textPrompt: prompt.prompt,\r\n    multimodalPrompt: prompt.images\r\n      ? {\r\n          images: prompt.images,\r\n          convertHttpImage2Base64: !!prompt.convertHttpImage2Base64,\r\n        }\r\n      : undefined,\r\n  };\r\n};\r\n"],"names":["debugProfile","getDebug","commonContextParser","interfaceInstance","_opt","assert","description","uploadTestInfoToServer","screenshotBase64","size","getReportFileName","tag","reportTagName","globalConfigManager","SQAI_REPORT_TAG_NAME","dateTimeInFileName","dayjs","uniqueId","uuid","printReportMsg","filepath","logMsg","getCurrentExecutionFile","trace","error","Error","stackTrace","pkgDir","process","stackLines","line","match","targetFileName","testFileIndex","Map","generateCacheId","fileName","taskFile","console","currentIndex","undefined","matchElementFromPlan","planLocateParam","tree","getNodeFromCacheList","centerPosition","Math","element","elementByPositionWithElementInfo","generateElementByPosition","matchElementFromCache","taskExecutor","cacheEntry","cachePrompt","cacheable","_taskExecutor_taskCache","cacheDebug","rect","NodeType","trimContextByViewport","execution","filterVisibleTree","node","filteredChildren","Array","child","task","_task_uiContext","newTask","getMidsceneVersion","__VERSION__","getSqaiVersion","parsePrompt","prompt"],"mappings":"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"}