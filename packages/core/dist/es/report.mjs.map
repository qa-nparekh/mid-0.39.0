{"version":3,"file":"report.mjs","sources":["webpack://@sqai/core/./src/report.ts"],"sourcesContent":["import * as fs from 'node:fs';\r\nimport * as path from 'node:path';\r\nimport { getMidsceneRunSubDir } from '@sqai/shared/common';\r\nimport { getReportFileName } from './agent';\r\nimport type { ReportFileWithAttributes } from './types';\r\nimport { getReportTpl, reportHTMLContent } from './utils';\r\n\r\nexport class ReportMergingTool {\r\n  private reportInfos: ReportFileWithAttributes[] = [];\r\n  public append(reportInfo: ReportFileWithAttributes) {\r\n    this.reportInfos.push(reportInfo);\r\n  }\r\n  public clear() {\r\n    this.reportInfos = [];\r\n  }\r\n  private extractScriptContent(filePath: string): string {\r\n    // Regular expression to match content between script tags\r\n    // Requires newline before <script and </script>\r\n    const scriptRegex =\r\n      /\\n<script type=\"SQAI_web_dump\" type=\"application\\/json\"[^>]*>([\\s\\S]*?)\\n<\\/script>/;\r\n\r\n    const fileContent = fs.readFileSync(filePath, 'utf-8');\r\n    const match = scriptRegex.exec(fileContent);\r\n\r\n    return match ? match[1].trim() : '';\r\n  }\r\n\r\n  public mergeReports(\r\n    reportFileName: 'AUTO' | string = 'AUTO', // user custom report filename, save into midscene report dir if undefined\r\n    opts?: {\r\n      rmOriginalReports?: boolean; // whether to remove origin report files\r\n      overwrite?: boolean; // if outfilepath specified, throw an error when overwrite = true, otherwise overwrite the file\r\n    },\r\n  ): string | null {\r\n    if (this.reportInfos.length <= 1) {\r\n      console.log('Not enough report to merge');\r\n      return null;\r\n    }\r\n    opts = Object.assign(\r\n      {\r\n        rmOriginalReports: false,\r\n        overwrite: false,\r\n      },\r\n      opts || {},\r\n    );\r\n    const { rmOriginalReports, overwrite } = opts;\r\n    let outputFilePath;\r\n    const targetDir = `${getMidsceneRunSubDir('report')}`;\r\n    if (reportFileName === 'AUTO') {\r\n      outputFilePath = path.resolve(\r\n        targetDir,\r\n        `${getReportFileName('merged-report')}.html`,\r\n      );\r\n    } else {\r\n      // user specified a outfilepath\r\n      outputFilePath = path.resolve(targetDir, `${reportFileName}.html`);\r\n      if (fs.existsSync(outputFilePath) && !overwrite) {\r\n        throw Error(\r\n          `report file already existed: ${outputFilePath}\\nset override to true to overwrite this file.`,\r\n        );\r\n      } else if (fs.existsSync(outputFilePath) && overwrite) {\r\n        fs.unlinkSync(outputFilePath);\r\n      }\r\n    }\r\n\r\n    console.log(\r\n      `Start merging ${this.reportInfos.length} reports...\\nCreating template file...`,\r\n    );\r\n\r\n    try {\r\n      // Write template\r\n      fs.appendFileSync(outputFilePath, getReportTpl());\r\n\r\n      // Process all reports one by one\r\n      for (let i = 0; i < this.reportInfos.length; i++) {\r\n        const reportInfo = this.reportInfos[i];\r\n        console.log(`Processing report ${i + 1}/${this.reportInfos.length}`);\r\n\r\n        const dumpString = this.extractScriptContent(reportInfo.reportFilePath);\r\n        const reportAttributes = reportInfo.reportAttributes;\r\n\r\n        const reportHtmlStr = `${reportHTMLContent(\r\n          {\r\n            dumpString,\r\n            attributes: {\r\n              playwright_test_duration: reportAttributes.testDuration,\r\n              playwright_test_status: reportAttributes.testStatus,\r\n              playwright_test_title: reportAttributes.testTitle,\r\n              playwright_test_id: reportAttributes.testId,\r\n              playwright_test_description: reportAttributes.testDescription,\r\n            },\r\n          },\r\n          undefined,\r\n          undefined,\r\n          false,\r\n        )}\\n`; // use existed function to achieve report script content\r\n\r\n        fs.appendFileSync(outputFilePath, reportHtmlStr);\r\n      }\r\n\r\n      console.log(`Successfully merged new report: ${outputFilePath}`);\r\n\r\n      // Remove original reports if needed\r\n      if (rmOriginalReports) {\r\n        for (const info of this.reportInfos) {\r\n          try {\r\n            fs.unlinkSync(info.reportFilePath);\r\n          } catch (error) {\r\n            console.error(\r\n              `Error deleting report ${info.reportFilePath}:`,\r\n              error,\r\n            );\r\n          }\r\n        }\r\n        console.log(`Removed ${this.reportInfos.length} original reports`);\r\n      }\r\n      return outputFilePath;\r\n    } catch (error) {\r\n      console.error('Error in mergeReports:', error);\r\n      throw error;\r\n    }\r\n  }\r\n}\r\n"],"names":["ReportMergingTool","reportInfo","filePath","scriptRegex","fileContent","fs","match","reportFileName","opts","console","Object","rmOriginalReports","overwrite","outputFilePath","targetDir","getMidsceneRunSubDir","path","getReportFileName","Error","getReportTpl","i","dumpString","reportAttributes","reportHtmlStr","reportHTMLContent","undefined","info","error"],"mappings":";;;;;;;;;;;;;;;AAOO,MAAMA;IAEJ,OAAOC,UAAoC,EAAE;QAClD,IAAI,CAAC,WAAW,CAAC,IAAI,CAACA;IACxB;IACO,QAAQ;QACb,IAAI,CAAC,WAAW,GAAG,EAAE;IACvB;IACQ,qBAAqBC,QAAgB,EAAU;QAGrD,MAAMC,cACJ;QAEF,MAAMC,cAAcC,aAAgBH,UAAU;QAC9C,MAAMI,QAAQH,YAAY,IAAI,CAACC;QAE/B,OAAOE,QAAQA,KAAK,CAAC,EAAE,CAAC,IAAI,KAAK;IACnC;IAEO,aACLC,iBAAkC,MAAM,EACxCC,IAGC,EACc;QACf,IAAI,IAAI,CAAC,WAAW,CAAC,MAAM,IAAI,GAAG;YAChCC,QAAQ,GAAG,CAAC;YACZ,OAAO;QACT;QACAD,OAAOE,OAAO,MAAM,CAClB;YACE,mBAAmB;YACnB,WAAW;QACb,GACAF,QAAQ,CAAC;QAEX,MAAM,EAAEG,iBAAiB,EAAEC,SAAS,EAAE,GAAGJ;QACzC,IAAIK;QACJ,MAAMC,YAAY,GAAGC,qBAAqB,WAAW;QACrD,IAAIR,AAAmB,WAAnBA,gBACFM,iBAAiBG,QACfF,WACA,GAAGG,kBAAkB,iBAAiB,KAAK,CAAC;aAEzC;YAELJ,iBAAiBG,QAAaF,WAAW,GAAGP,eAAe,KAAK,CAAC;YACjE,IAAIF,WAAcQ,mBAAmB,CAACD,WACpC,MAAMM,MACJ,CAAC,6BAA6B,EAAEL,eAAe,8CAA8C,CAAC;YAE3F,IAAIR,WAAcQ,mBAAmBD,WAC1CP,WAAcQ;QAElB;QAEAJ,QAAQ,GAAG,CACT,CAAC,cAAc,EAAE,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,sCAAsC,CAAC;QAGlF,IAAI;YAEFJ,eAAkBQ,gBAAgBM;YAGlC,IAAK,IAAIC,IAAI,GAAGA,IAAI,IAAI,CAAC,WAAW,CAAC,MAAM,EAAEA,IAAK;gBAChD,MAAMnB,aAAa,IAAI,CAAC,WAAW,CAACmB,EAAE;gBACtCX,QAAQ,GAAG,CAAC,CAAC,kBAAkB,EAAEW,IAAI,EAAE,CAAC,EAAE,IAAI,CAAC,WAAW,CAAC,MAAM,EAAE;gBAEnE,MAAMC,aAAa,IAAI,CAAC,oBAAoB,CAACpB,WAAW,cAAc;gBACtE,MAAMqB,mBAAmBrB,WAAW,gBAAgB;gBAEpD,MAAMsB,gBAAgB,GAAGC,kBACvB;oBACEH;oBACA,YAAY;wBACV,0BAA0BC,iBAAiB,YAAY;wBACvD,wBAAwBA,iBAAiB,UAAU;wBACnD,uBAAuBA,iBAAiB,SAAS;wBACjD,oBAAoBA,iBAAiB,MAAM;wBAC3C,6BAA6BA,iBAAiB,eAAe;oBAC/D;gBACF,GACAG,QACAA,QACA,OACA,EAAE,CAAC;gBAELpB,eAAkBQ,gBAAgBU;YACpC;YAEAd,QAAQ,GAAG,CAAC,CAAC,gCAAgC,EAAEI,gBAAgB;YAG/D,IAAIF,mBAAmB;gBACrB,KAAK,MAAMe,QAAQ,IAAI,CAAC,WAAW,CACjC,IAAI;oBACFrB,WAAcqB,KAAK,cAAc;gBACnC,EAAE,OAAOC,OAAO;oBACdlB,QAAQ,KAAK,CACX,CAAC,sBAAsB,EAAEiB,KAAK,cAAc,CAAC,CAAC,CAAC,EAC/CC;gBAEJ;gBAEFlB,QAAQ,GAAG,CAAC,CAAC,QAAQ,EAAE,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,iBAAiB,CAAC;YACnE;YACA,OAAOI;QACT,EAAE,OAAOc,OAAO;YACdlB,QAAQ,KAAK,CAAC,0BAA0BkB;YACxC,MAAMA;QACR;IACF;;QAjHA,uBAAQ,eAA0C,EAAE;;AAkHtD"}