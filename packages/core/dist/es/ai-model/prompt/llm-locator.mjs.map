{"version":3,"file":"ai-model\\prompt\\llm-locator.mjs","sources":["webpack://@sqaitech/core/./src/ai-model/prompt/llm-locator.ts"],"sourcesContent":["import type { TVlModeTypes } from '@sqaitech/shared/env';\r\nimport type { ResponseFormatJSONSchema } from 'openai/resources/index';\r\nimport { bboxDescription } from './common';\r\nexport function systemPromptToLocateElement(vlMode: TVlModeTypes | undefined) {\r\n  if (vlMode) {\r\n    const bboxComment = bboxDescription(vlMode);\r\n    return `\r\n## Role:\r\nYou are an expert in software testing.\r\n\r\n## Objective:\r\n- Identify elements in screenshots and text that match the user's description.\r\n- Give the coordinates of the element that matches the user's description best in the screenshot.\r\n- Determine whether the user's description is order-sensitive (e.g., contains phrases like 'the third item in the list', 'the last button', etc.).\r\n\r\n## Output Format:\r\n\\`\\`\\`json\r\n{\r\n  \"bbox\": [number, number, number, number],  // ${bboxComment}\r\n  \"errors\"?: string[],\r\n  \"isOrderSensitive\": boolean // Whether the targetElementDescription is order-sensitive (true/false)\r\n}\r\n\\`\\`\\`\r\n\r\nFields:\r\n* \\`bbox\\` is the bounding box of the element that matches the user's description best in the screenshot\r\n* \\`isOrderSensitive\\` is a boolean indicating whether the user's description is order-sensitive (true/false)\r\n* \\`errors\\` is an optional array of error messages (if any)\r\n\r\nOrder-sensitive means the description contains phrases like:\r\n- \"the third item in the list\"\r\n- \"the last button\"\r\n- \"the first input box\"\r\n- \"the second row\"\r\n\r\nNot order-sensitive means the description is like:\r\n- \"confirm button\"\r\n- \"search box\"\r\n- \"password input\"\r\n\r\nFor example, when an element is found and the description is order-sensitive:\r\n\\`\\`\\`json\r\n{\r\n  \"bbox\": [100, 100, 200, 200],\r\n  \"isOrderSensitive\": true,\r\n  \"errors\": []\r\n}\r\n\\`\\`\\`\r\n\r\nWhen no element is found and the description is not order-sensitive:\r\n\\`\\`\\`json\r\n{\r\n  \"bbox\": [],\r\n  \"isOrderSensitive\": false,\r\n  \"errors\": [\"I can see ..., but {some element} is not found\"]\r\n}\r\n\\`\\`\\`\r\n`;\r\n  }\r\n\r\n  return `\r\n## Role:\r\nYou are an expert in software page image (2D) and page element text analysis.\r\n\r\n## Objective:\r\n- Identify elements in screenshots and text that match the user's description.\r\n- Return JSON data containing the selection reason and element ID.\r\n- Determine whether the user's description is order-sensitive (e.g., contains phrases like 'the third item in the list', 'the last button', etc.).\r\n\r\n## Skills:\r\n- Image analysis and recognition\r\n- Multilingual text understanding\r\n- Software UI design and testing\r\n\r\n## Workflow:\r\n1. Receive the user's element description, screenshot, and element description information. Note that the text may contain non-English characters (e.g., Chinese), indicating that the application may be non-English.\r\n2. Based on the user's description, locate the target element ID in the list of element descriptions and the screenshot.\r\n3. Found the required number of elements\r\n4. Return JSON data containing the selection reason and element ID.\r\n5. Judge whether the user's description is order-sensitive (see below for definition and examples).\r\n\r\n## Constraints:\r\n- Strictly adhere to the specified location when describing the required element; do not select elements from other locations.\r\n- Elements in the image with NodeType other than \"TEXT Node\" have been highlighted to identify the element among multiple non-text elements.\r\n- Accurately identify element information based on the user's description and return the corresponding element ID from the element description information, not extracted from the image.\r\n- If no elements are found, the \"elements\" array should be empty.\r\n- The returned data must conform to the specified JSON format.\r\n- The returned value id information must use the id from element info (important: **use id not indexId, id is hash content**)\r\n\r\n## Order-Sensitive Definition:\r\n- If the description contains phrases like \"the third item in the list\", \"the last button\", \"the first input box\", \"the second row\", etc., it is order-sensitive (isOrderSensitive = true).\r\n- If the description is like \"confirm button\", \"search box\", \"password input\", etc., it is not order-sensitive (isOrderSensitive = false).\r\n\r\n## Output Format:\r\n\r\nPlease return the result in JSON format as follows:\r\n\r\n\\`\\`\\`json\r\n{\r\n  \"elements\": [\r\n    // If no matching elements are found, return an empty array []\r\n    {\r\n      \"reason\": \"PLACEHOLDER\", // The thought process for finding the element, replace PLACEHOLDER with your thought process\r\n      \"text\": \"PLACEHOLDER\", // Replace PLACEHOLDER with the text of elementInfo, if none, leave empty\r\n      \"id\": \"PLACEHOLDER\" // Replace PLACEHOLDER with the ID (important: **use id not indexId, id is hash content**) of elementInfo\r\n    }\r\n    // More elements...\r\n  ],\r\n  \"isOrderSensitive\": true, // or false, depending on the user's description\r\n  \"errors\": [] // Array of strings containing any error messages\r\n}\r\n\\`\\`\\`\r\n\r\n## Example:\r\nExample 1:\r\nInput Example:\r\n\\`\\`\\`json\r\n// Description: \"Shopping cart icon in the upper right corner\"\r\n{\r\n  \"description\": \"PLACEHOLDER\", // Description of the target element\r\n  \"screenshot\": \"path/screenshot.png\",\r\n  \"text\": '{\r\n      \"pageSize\": {\r\n        \"width\": 400, // Width of the page\r\n        \"height\": 905 // Height of the page\r\n      },\r\n      \"elementInfos\": [\r\n        {\r\n          \"id\": \"1231\", // ID of the element\r\n          \"indexId\": \"0\", // Index of the element，The image is labeled to the left of the element\r\n          \"attributes\": { // Attributes of the element\r\n            \"nodeType\": \"IMG Node\", // Type of element, types include: TEXT Node, IMG Node, BUTTON Node, INPUT Node\r\n            \"src\": \"https://ap-southeast-3.m\",\r\n            \"class\": \".img\"\r\n          },\r\n          \"content\": \"\", // Text content of the element\r\n          \"rect\": {\r\n            \"left\": 280, // Distance from the left side of the page\r\n            \"top\": 8, // Distance from the top of the page\r\n            \"width\": 44, // Width of the element\r\n            \"height\": 44 // Height of the element\r\n          }\r\n        },\r\n        {\r\n          \"id\": \"66551\", // ID of the element\r\n          \"indexId\": \"1\", // Index of the element,The image is labeled to the left of the element\r\n          \"attributes\": { // Attributes of the element\r\n            \"nodeType\": \"IMG Node\", // Type of element, types include: TEXT Node, IMG Node, BUTTON Node, INPUT Node\r\n            \"src\": \"data:image/png;base64,iVBORw0KGgoAAAANSU...\",\r\n            \"class\": \".icon\"\r\n          },\r\n          \"content\": \"\", // Text content of the element\r\n          \"rect\": {\r\n            \"left\": 350, // Distance from the left side of the page\r\n            \"top\": 16, // Distance from the top of the page\r\n            \"width\": 25, // Width of the element\r\n            \"height\": 25 // Height of the element\r\n          }\r\n        },\r\n        ...\r\n        {\r\n          \"id\": \"12344\",\r\n          \"indexId\": \"2\", // Index of the element，The image is labeled to the left of the element\r\n          \"attributes\": {\r\n            \"nodeType\": \"TEXT Node\",\r\n            \"class\": \".product-name\"\r\n          },\r\n          \"center\": [\r\n            288,\r\n            834\r\n          ],\r\n          \"content\": \"Mango Drink\",\r\n          \"rect\": {\r\n            \"left\": 188,\r\n            \"top\": 827,\r\n            \"width\": 199,\r\n            \"height\": 13\r\n          }\r\n        },\r\n        ...\r\n      ]\r\n    }\r\n  '\r\n}\r\n\\`\\`\\`\r\nOutput Example:\r\n\\`\\`\\`json\r\n{\r\n  \"elements\": [\r\n    {\r\n      // Describe the reason for finding this element, replace with actual value in practice\r\n      \"reason\": \"Reason for finding element 4: It is located in the upper right corner, is an image type, and according to the screenshot, it is a shopping cart icon button\",\r\n      \"text\": \"\",\r\n      // ID(**use id not indexId**) of this element, replace with actual value in practice, **use id not indexId**\r\n      \"id\": \"1231\"\r\n    }\r\n  ],\r\n  \"isOrderSensitive\": true,\r\n  \"errors\": []\r\n}\r\n\\`\\`\\`\r\n  \r\n  `;\r\n}\r\n\r\nexport const locatorSchema: ResponseFormatJSONSchema = {\r\n  type: 'json_schema',\r\n  json_schema: {\r\n    name: 'find_elements',\r\n    strict: true,\r\n    schema: {\r\n      type: 'object',\r\n      properties: {\r\n        elements: {\r\n          type: 'array',\r\n          items: {\r\n            type: 'object',\r\n            properties: {\r\n              reason: {\r\n                type: 'string',\r\n                description: 'Reason for finding this element',\r\n              },\r\n              text: {\r\n                type: 'string',\r\n                description: 'Text content of the element',\r\n              },\r\n              id: {\r\n                type: 'string',\r\n                description: 'ID of this element',\r\n              },\r\n            },\r\n            required: ['reason', 'text', 'id'],\r\n            additionalProperties: false,\r\n          },\r\n          description: 'List of found elements',\r\n        },\r\n        isOrderSensitive: {\r\n          type: 'boolean',\r\n          description:\r\n            'Whether the targetElementDescription is order-sensitive (true/false)',\r\n        },\r\n        errors: {\r\n          type: 'array',\r\n          items: {\r\n            type: 'string',\r\n          },\r\n          description: 'List of error messages, if any',\r\n        },\r\n      },\r\n      required: ['elements', 'isOrderSensitive', 'errors'],\r\n      additionalProperties: false,\r\n    },\r\n  },\r\n};\r\n\r\nexport const findElementPrompt = ({\r\n  pageDescription,\r\n  targetElementDescription,\r\n}: {\r\n  pageDescription: string;\r\n  targetElementDescription: string;\r\n}) => `\r\nHere is the item user want to find:\r\n=====================================\r\n${targetElementDescription}\r\n=====================================\r\n\r\n${pageDescription}\r\n  `;\r\n"],"names":["systemPromptToLocateElement","vlMode","bboxComment","bboxDescription","locatorSchema","findElementPrompt","pageDescription","targetElementDescription"],"mappings":";AAGO,SAASA,4BAA4BC,MAAgC;IAC1E,IAAIA,QAAQ;QACV,MAAMC,cAAcC,gBAAgBF;QACpC,OAAO,CAAC;;;;;;;;;;;;gDAYoC,EAAEC,YAAY;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAuC9D,CAAC;IACC;IAEA,OAAO,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EA8IR,CAAC;AACH;AAEO,MAAME,gBAA0C;IACrD,MAAM;IACN,aAAa;QACX,MAAM;QACN,QAAQ;QACR,QAAQ;YACN,MAAM;YACN,YAAY;gBACV,UAAU;oBACR,MAAM;oBACN,OAAO;wBACL,MAAM;wBACN,YAAY;4BACV,QAAQ;gCACN,MAAM;gCACN,aAAa;4BACf;4BACA,MAAM;gCACJ,MAAM;gCACN,aAAa;4BACf;4BACA,IAAI;gCACF,MAAM;gCACN,aAAa;4BACf;wBACF;wBACA,UAAU;4BAAC;4BAAU;4BAAQ;yBAAK;wBAClC,sBAAsB;oBACxB;oBACA,aAAa;gBACf;gBACA,kBAAkB;oBAChB,MAAM;oBACN,aACE;gBACJ;gBACA,QAAQ;oBACN,MAAM;oBACN,OAAO;wBACL,MAAM;oBACR;oBACA,aAAa;gBACf;YACF;YACA,UAAU;gBAAC;gBAAY;gBAAoB;aAAS;YACpD,sBAAsB;QACxB;IACF;AACF;AAEO,MAAMC,oBAAoB,CAAC,EAChCC,eAAe,EACfC,wBAAwB,EAIzB,GAAK,CAAC;;;AAGP,EAAEA,yBAAyB;;;AAG3B,EAAED,gBAAgB;EAChB,CAAC"}