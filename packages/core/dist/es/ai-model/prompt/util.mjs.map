{"version":3,"file":"ai-model\\prompt\\util.mjs","sources":["webpack://@sqai/core/./src/ai-model/prompt/util.ts"],"sourcesContent":["import { imageInfoOfBase64 } from '@/image/index';\r\nimport type { BaseElement, ElementTreeNode, Size, UIContext } from '@/types';\r\nimport { NodeType } from '@sqai/shared/constants';\r\nimport type { TVlModeTypes } from '@sqai/shared/env';\r\nimport {\r\n  descriptionOfTree,\r\n  generateElementByPosition,\r\n  treeToList,\r\n} from '@sqai/shared/extractor';\r\nimport { assert } from '@sqai/shared/utils';\r\n\r\nexport function describeSize(size: Size) {\r\n  return `${size.width} x ${size.height}`;\r\n}\r\n\r\nexport function describeElement(\r\n  elements: (Pick<BaseElement, 'rect' | 'content'> & { id: string })[],\r\n) {\r\n  const sliceLength = 80;\r\n  return elements\r\n    .map((item) =>\r\n      [\r\n        item.id,\r\n        item.rect.left,\r\n        item.rect.top,\r\n        item.rect.left + item.rect.width,\r\n        item.rect.top + item.rect.height,\r\n        item.content.length > sliceLength\r\n          ? `${item.content.slice(0, sliceLength)}...`\r\n          : item.content,\r\n      ].join(', '),\r\n    )\r\n    .join('\\n');\r\n}\r\nexport const distanceThreshold = 16;\r\n\r\nexport function elementByPositionWithElementInfo(\r\n  treeRoot: ElementTreeNode<BaseElement>,\r\n  position: {\r\n    x: number;\r\n    y: number;\r\n  },\r\n  options?: {\r\n    requireStrictDistance?: boolean;\r\n    filterPositionElements?: boolean;\r\n  },\r\n) {\r\n  const requireStrictDistance = options?.requireStrictDistance ?? true;\r\n  const filterPositionElements = options?.filterPositionElements ?? false;\r\n\r\n  assert(typeof position !== 'undefined', 'position is required for query');\r\n\r\n  const matchingElements: BaseElement[] = [];\r\n\r\n  function dfs(node: ElementTreeNode<BaseElement>) {\r\n    if (node?.node) {\r\n      const item = node.node;\r\n      if (\r\n        item.rect.left <= position.x &&\r\n        position.x <= item.rect.left + item.rect.width &&\r\n        item.rect.top <= position.y &&\r\n        position.y <= item.rect.top + item.rect.height\r\n      ) {\r\n        if (\r\n          !(\r\n            filterPositionElements &&\r\n            item.attributes?.nodeType === NodeType.POSITION\r\n          ) &&\r\n          item.isVisible\r\n        ) {\r\n          matchingElements.push(item);\r\n        }\r\n      }\r\n    }\r\n\r\n    for (const child of node.children) {\r\n      dfs(child);\r\n    }\r\n  }\r\n\r\n  dfs(treeRoot);\r\n\r\n  if (matchingElements.length === 0) {\r\n    return undefined;\r\n  }\r\n\r\n  // Find the smallest element by area\r\n  const element = matchingElements.reduce((smallest, current) => {\r\n    const smallestArea = smallest.rect.width * smallest.rect.height;\r\n    const currentArea = current.rect.width * current.rect.height;\r\n    return currentArea < smallestArea ? current : smallest;\r\n  });\r\n\r\n  const distanceToCenter = distance(\r\n    { x: element.center[0], y: element.center[1] },\r\n    position,\r\n  );\r\n\r\n  if (requireStrictDistance) {\r\n    return distanceToCenter <= distanceThreshold ? element : undefined;\r\n  }\r\n\r\n  return element;\r\n}\r\n\r\nexport function distance(\r\n  point1: { x: number; y: number },\r\n  point2: { x: number; y: number },\r\n) {\r\n  return Math.sqrt((point1.x - point2.x) ** 2 + (point1.y - point2.y) ** 2);\r\n}\r\n\r\nexport const samplePageDescription = `\r\nAnd the page is described as follows:\r\n====================\r\nThe size of the page: 1280 x 720\r\nSome of the elements are marked with a rectangle in the screenshot corresponding to the markerId, some are not.\r\n\r\nDescription of all the elements in screenshot:\r\n<div id=\"969f1637\" markerId=\"1\" left=\"100\" top=\"100\" width=\"100\" height=\"100\"> // The markerId indicated by the rectangle label in the screenshot\r\n  <h4 id=\"b211ecb2\" markerId=\"5\" left=\"150\" top=\"150\" width=\"90\" height=\"60\">\r\n    The username is accepted\r\n  </h4>\r\n  ...many more\r\n</div>\r\n====================\r\n`;\r\n\r\nexport async function describeUserPage<\r\n  ElementType extends BaseElement = BaseElement,\r\n>(\r\n  context: Omit<UIContext<ElementType>, 'describer'>,\r\n  opt: {\r\n    truncateTextLength?: number;\r\n    filterNonTextContent?: boolean;\r\n    domIncluded?: boolean | 'visible-only';\r\n    visibleOnly?: boolean;\r\n    vlMode: TVlModeTypes | undefined;\r\n  },\r\n) {\r\n  const { screenshotBase64 } = context;\r\n  let width: number;\r\n  let height: number;\r\n\r\n  if (context.size) {\r\n    ({ width, height } = context.size);\r\n  } else {\r\n    const imgSize = await imageInfoOfBase64(screenshotBase64);\r\n    ({ width, height } = imgSize);\r\n  }\r\n\r\n  const treeRoot = context.tree;\r\n  // dfs tree, save the id and element info\r\n  const idElementMap: Record<string, ElementType> = {};\r\n  const flatElements: ElementType[] = treeToList(treeRoot);\r\n\r\n  if (opt?.domIncluded === true && flatElements.length >= 5000) {\r\n    console.warn(\r\n      'The number of elements is too large, it may cause the prompt to be too long, please use domIncluded: \"visible-only\" to reduce the number of elements',\r\n    );\r\n  }\r\n\r\n  flatElements.forEach((element) => {\r\n    idElementMap[element.id] = element;\r\n    if (typeof element.indexId !== 'undefined') {\r\n      idElementMap[`${element.indexId}`] = element;\r\n    }\r\n  });\r\n\r\n  let pageDescription = '';\r\n\r\n  const visibleOnly =\r\n    opt?.domIncluded === 'visible-only' ? true : (opt?.visibleOnly ?? false);\r\n  const resolvedVlMode = opt?.vlMode;\r\n  const shouldIncludeDOM = opt?.domIncluded || !resolvedVlMode;\r\n\r\n  if (shouldIncludeDOM) {\r\n    // non-vl mode must provide the page description\r\n    const contentTree = await descriptionOfTree(\r\n      treeRoot,\r\n      opt?.truncateTextLength,\r\n      opt?.filterNonTextContent,\r\n      visibleOnly,\r\n    );\r\n\r\n    // if match by position, don't need to provide the page description\r\n    const sizeDescription = describeSize({ width, height });\r\n    pageDescription = `The size of the page: ${sizeDescription} \\n The page elements tree:\\n${contentTree}`;\r\n  }\r\n\r\n  return {\r\n    description: pageDescription,\r\n    elementById(idOrIndexId: string) {\r\n      assert(typeof idOrIndexId !== 'undefined', 'id is required for query');\r\n      const item = idElementMap[`${idOrIndexId}`];\r\n      return item;\r\n    },\r\n    elementByPosition(\r\n      position: { x: number; y: number },\r\n      size: { width: number; height: number },\r\n    ) {\r\n      return elementByPositionWithElementInfo(treeRoot, position);\r\n    },\r\n    insertElementByPosition(position: { x: number; y: number }) {\r\n      const element = generateElementByPosition(position) as ElementType;\r\n\r\n      treeRoot.children.push({\r\n        node: element,\r\n        children: [],\r\n      });\r\n      flatElements.push(element);\r\n      idElementMap[element.id] = element;\r\n      return element;\r\n    },\r\n    size: { width, height },\r\n  };\r\n}\r\n"],"names":["describeSize","size","describeElement","elements","sliceLength","item","distanceThreshold","elementByPositionWithElementInfo","treeRoot","position","options","requireStrictDistance","filterPositionElements","assert","matchingElements","dfs","node","_item_attributes","NodeType","child","element","smallest","current","smallestArea","currentArea","distanceToCenter","distance","undefined","point1","point2","Math","samplePageDescription","describeUserPage","context","opt","screenshotBase64","width","height","imgSize","imageInfoOfBase64","idElementMap","flatElements","treeToList","console","pageDescription","visibleOnly","resolvedVlMode","shouldIncludeDOM","contentTree","descriptionOfTree","sizeDescription","idOrIndexId","generateElementByPosition"],"mappings":"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"}