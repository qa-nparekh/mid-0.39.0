{"version":3,"file":"ai-model\\inspect.mjs","sources":["webpack://@sqai/core/./src/ai-model/inspect.ts"],"sourcesContent":["import type {\r\n  AIDataExtractionResponse,\r\n  AIElementLocatorResponse,\r\n  AIElementResponse,\r\n  AISectionLocatorResponse,\r\n  AIUsageInfo,\r\n  BaseElement,\r\n  ElementById,\r\n  InsightExtractOption,\r\n  Rect,\r\n  ReferenceImage,\r\n  UIContext,\r\n} from '@/types';\r\nimport type { IModelConfig } from '@sqai/shared/env';\r\nimport {\r\n  cropByRect,\r\n  paddingToMatchBlockByBase64,\r\n  preProcessImageUrl,\r\n} from '@sqai/shared/img';\r\nimport { getDebug } from '@sqai/shared/logger';\r\nimport { assert } from '@sqai/shared/utils';\r\nimport type {\r\n  ChatCompletionSystemMessageParam,\r\n  ChatCompletionUserMessageParam,\r\n} from 'openai/resources/index';\r\nimport type { TMultimodalPrompt, TUserPrompt } from './common';\r\nimport {\r\n  AIActionType,\r\n  adaptBboxToRect,\r\n  expandSearchArea,\r\n  markupImageForLLM,\r\n  mergeRects,\r\n} from './common';\r\nimport {\r\n  extractDataQueryPrompt,\r\n  systemPromptToExtract,\r\n} from './prompt/extraction';\r\nimport {\r\n  findElementPrompt,\r\n  systemPromptToLocateElement,\r\n} from './prompt/llm-locator';\r\nimport {\r\n  sectionLocatorInstruction,\r\n  systemPromptToLocateSection,\r\n} from './prompt/llm-section-locator';\r\nimport {\r\n  describeUserPage,\r\n  distance,\r\n  distanceThreshold,\r\n  elementByPositionWithElementInfo,\r\n} from './prompt/util';\r\nimport { callAIWithObjectResponse } from './service-caller/index';\r\n\r\nexport type AIArgs = [\r\n  ChatCompletionSystemMessageParam,\r\n  ...ChatCompletionUserMessageParam[],\r\n];\r\n\r\nconst debugInspect = getDebug('ai:inspect');\r\nconst debugSection = getDebug('ai:section');\r\n\r\nconst extraTextFromUserPrompt = (prompt: TUserPrompt): string => {\r\n  if (typeof prompt === 'string') {\r\n    return prompt;\r\n  } else {\r\n    return prompt.prompt;\r\n  }\r\n};\r\n\r\nconst promptsToChatParam = async (\r\n  multimodalPrompt: TMultimodalPrompt,\r\n): Promise<ChatCompletionUserMessageParam[]> => {\r\n  const msgs: ChatCompletionUserMessageParam[] = [];\r\n  if (multimodalPrompt?.images?.length) {\r\n    msgs.push({\r\n      role: 'user',\r\n      content: [\r\n        {\r\n          type: 'text',\r\n          text: 'Next, I will provide all the reference images.',\r\n        },\r\n      ],\r\n    });\r\n\r\n    for (const item of multimodalPrompt.images) {\r\n      const base64 = await preProcessImageUrl(\r\n        item.url,\r\n        !!multimodalPrompt.convertHttpImage2Base64,\r\n      );\r\n\r\n      msgs.push({\r\n        role: 'user',\r\n        content: [\r\n          {\r\n            type: 'text',\r\n            text: `reference image ${item.name}:`,\r\n          },\r\n        ],\r\n      });\r\n\r\n      msgs.push({\r\n        role: 'user',\r\n        content: [\r\n          {\r\n            type: 'image_url',\r\n            image_url: {\r\n              url: base64,\r\n              detail: 'high',\r\n            },\r\n          },\r\n        ],\r\n      });\r\n    }\r\n  }\r\n  return msgs;\r\n};\r\n\r\nexport async function AiLocateElement<\r\n  ElementType extends BaseElement = BaseElement,\r\n>(options: {\r\n  context: UIContext<ElementType>;\r\n  targetElementDescription: TUserPrompt;\r\n  referenceImage?: ReferenceImage;\r\n  callAIFn: typeof callAIWithObjectResponse<\r\n    AIElementResponse | [number, number]\r\n  >;\r\n  searchConfig?: Awaited<ReturnType<typeof AiLocateSection>>;\r\n  modelConfig: IModelConfig;\r\n}): Promise<{\r\n  parseResult: AIElementLocatorResponse;\r\n  rect?: Rect;\r\n  rawResponse: string;\r\n  elementById: ElementById;\r\n  usage?: AIUsageInfo;\r\n  isOrderSensitive?: boolean;\r\n}> {\r\n  const { context, targetElementDescription, callAIFn, modelConfig } = options;\r\n  const { vlMode } = modelConfig;\r\n  const { screenshotBase64 } = context;\r\n\r\n  const { description, elementById, insertElementByPosition } =\r\n    await describeUserPage(context, { vlMode });\r\n\r\n  assert(\r\n    targetElementDescription,\r\n    'cannot find the target element description',\r\n  );\r\n  const userInstructionPrompt = findElementPrompt({\r\n    pageDescription: description,\r\n    targetElementDescription: extraTextFromUserPrompt(targetElementDescription),\r\n  });\r\n  const systemPrompt = systemPromptToLocateElement(vlMode);\r\n\r\n  let imagePayload = screenshotBase64;\r\n  let imageWidth = context.size.width;\r\n  let imageHeight = context.size.height;\r\n  let originalImageWidth = imageWidth;\r\n  let originalImageHeight = imageHeight;\r\n\r\n  if (options.searchConfig) {\r\n    assert(\r\n      options.searchConfig.rect,\r\n      'searchArea is provided but its rect cannot be found. Failed to locate element',\r\n    );\r\n    assert(\r\n      options.searchConfig.imageBase64,\r\n      'searchArea is provided but its imageBase64 cannot be found. Failed to locate element',\r\n    );\r\n\r\n    imagePayload = options.searchConfig.imageBase64;\r\n    imageWidth = options.searchConfig.rect?.width;\r\n    imageHeight = options.searchConfig.rect?.height;\r\n    originalImageWidth = imageWidth;\r\n    originalImageHeight = imageHeight;\r\n  } else if (vlMode === 'qwen-vl') {\r\n    const paddedResult = await paddingToMatchBlockByBase64(imagePayload);\r\n    imageWidth = paddedResult.width;\r\n    imageHeight = paddedResult.height;\r\n    imagePayload = paddedResult.imageBase64;\r\n  } else if (vlMode === 'qwen3-vl') {\r\n    // const paddedResult = await paddingToMatchBlockByBase64(imagePayload, 32);\r\n    // imageWidth = paddedResult.width;\r\n    // imageHeight = paddedResult.height;\r\n    // imagePayload = paddedResult.imageBase64;\r\n  } else if (!vlMode) {\r\n    imagePayload = await markupImageForLLM(\r\n      screenshotBase64,\r\n      context.tree,\r\n      context.size,\r\n    );\r\n  }\r\n\r\n  const msgs: AIArgs = [\r\n    { role: 'system', content: systemPrompt },\r\n    {\r\n      role: 'user',\r\n      content: [\r\n        {\r\n          type: 'image_url',\r\n          image_url: {\r\n            url: imagePayload,\r\n            detail: 'high',\r\n          },\r\n        },\r\n        {\r\n          type: 'text',\r\n          text: userInstructionPrompt,\r\n        },\r\n      ],\r\n    },\r\n  ];\r\n\r\n  if (typeof targetElementDescription !== 'string') {\r\n    const addOns = await promptsToChatParam({\r\n      images: targetElementDescription.images,\r\n      convertHttpImage2Base64: targetElementDescription.convertHttpImage2Base64,\r\n    });\r\n    msgs.push(...addOns);\r\n  }\r\n\r\n  const res = await callAIFn(msgs, AIActionType.INSPECT_ELEMENT, modelConfig);\r\n\r\n  const rawResponse = JSON.stringify(res.content);\r\n\r\n  let resRect: Rect | undefined;\r\n  let matchedElements: AIElementLocatorResponse['elements'] =\r\n    'elements' in res.content ? res.content.elements : [];\r\n  let errors: AIElementLocatorResponse['errors'] | undefined =\r\n    'errors' in res.content ? res.content.errors : [];\r\n  try {\r\n    if ('bbox' in res.content && Array.isArray(res.content.bbox)) {\r\n      resRect = adaptBboxToRect(\r\n        res.content.bbox,\r\n        imageWidth,\r\n        imageHeight,\r\n        options.searchConfig?.rect?.left,\r\n        options.searchConfig?.rect?.top,\r\n        originalImageWidth,\r\n        originalImageHeight,\r\n        vlMode,\r\n      );\r\n\r\n      debugInspect('resRect', resRect);\r\n\r\n      const rectCenter = {\r\n        x: resRect.left + resRect.width / 2,\r\n        y: resRect.top + resRect.height / 2,\r\n      };\r\n      let element = elementByPositionWithElementInfo(context.tree, rectCenter);\r\n\r\n      const distanceToCenter = element\r\n        ? distance({ x: element.center[0], y: element.center[1] }, rectCenter)\r\n        : 0;\r\n\r\n      if (!element || distanceToCenter > distanceThreshold) {\r\n        element = insertElementByPosition(rectCenter);\r\n      }\r\n\r\n      if (element) {\r\n        matchedElements = [element];\r\n        errors = [];\r\n      }\r\n    }\r\n  } catch (e) {\r\n    const msg =\r\n      e instanceof Error\r\n        ? `Failed to parse bbox: ${e.message}`\r\n        : 'unknown error in locate';\r\n    if (!errors || errors?.length === 0) {\r\n      errors = [msg];\r\n    } else {\r\n      errors.push(`(${msg})`);\r\n    }\r\n  }\r\n\r\n  return {\r\n    rect: resRect,\r\n    parseResult: {\r\n      elements: matchedElements,\r\n      errors,\r\n    },\r\n    rawResponse,\r\n    elementById,\r\n    usage: res.usage,\r\n    isOrderSensitive:\r\n      typeof res.content === 'object' &&\r\n      res.content !== null &&\r\n      'isOrderSensitive' in res.content\r\n        ? (res.content as any).isOrderSensitive\r\n        : undefined,\r\n  };\r\n}\r\n\r\nexport async function AiLocateSection(options: {\r\n  context: UIContext<BaseElement>;\r\n  sectionDescription: TUserPrompt;\r\n  modelConfig: IModelConfig;\r\n}): Promise<{\r\n  rect?: Rect;\r\n  imageBase64?: string;\r\n  error?: string;\r\n  rawResponse: string;\r\n  usage?: AIUsageInfo;\r\n}> {\r\n  const { context, sectionDescription, modelConfig } = options;\r\n  const { vlMode } = modelConfig;\r\n  const { screenshotBase64 } = context;\r\n\r\n  const systemPrompt = systemPromptToLocateSection(vlMode);\r\n  const sectionLocatorInstructionText = sectionLocatorInstruction({\r\n    sectionDescription: extraTextFromUserPrompt(sectionDescription),\r\n  });\r\n  const msgs: AIArgs = [\r\n    { role: 'system', content: systemPrompt },\r\n    {\r\n      role: 'user',\r\n      content: [\r\n        {\r\n          type: 'image_url',\r\n          image_url: {\r\n            url: screenshotBase64,\r\n            detail: 'high',\r\n          },\r\n        },\r\n        {\r\n          type: 'text',\r\n          text: sectionLocatorInstructionText,\r\n        },\r\n      ],\r\n    },\r\n  ];\r\n\r\n  if (typeof sectionDescription !== 'string') {\r\n    const addOns = await promptsToChatParam({\r\n      images: sectionDescription.images,\r\n      convertHttpImage2Base64: sectionDescription.convertHttpImage2Base64,\r\n    });\r\n    msgs.push(...addOns);\r\n  }\r\n\r\n  const result = await callAIWithObjectResponse<AISectionLocatorResponse>(\r\n    msgs,\r\n    AIActionType.EXTRACT_DATA,\r\n    modelConfig,\r\n  );\r\n\r\n  let sectionRect: Rect | undefined;\r\n  const sectionBbox = result.content.bbox;\r\n  if (sectionBbox) {\r\n    const targetRect = adaptBboxToRect(\r\n      sectionBbox,\r\n      context.size.width,\r\n      context.size.height,\r\n      0,\r\n      0,\r\n      context.size.width,\r\n      context.size.height,\r\n      vlMode,\r\n    );\r\n    debugSection('original targetRect %j', targetRect);\r\n\r\n    const referenceBboxList = result.content.references_bbox || [];\r\n    debugSection('referenceBboxList %j', referenceBboxList);\r\n\r\n    const referenceRects = referenceBboxList\r\n      .filter((bbox) => Array.isArray(bbox))\r\n      .map((bbox) => {\r\n        return adaptBboxToRect(\r\n          bbox,\r\n          context.size.width,\r\n          context.size.height,\r\n          0,\r\n          0,\r\n          context.size.width,\r\n          context.size.height,\r\n          vlMode,\r\n        );\r\n      });\r\n    debugSection('referenceRects %j', referenceRects);\r\n\r\n    // merge the sectionRect and referenceRects\r\n    const mergedRect = mergeRects([targetRect, ...referenceRects]);\r\n    debugSection('mergedRect %j', mergedRect);\r\n\r\n    // expand search area to at least 200 x 200\r\n    sectionRect = expandSearchArea(mergedRect, context.size, vlMode);\r\n    debugSection('expanded sectionRect %j', sectionRect);\r\n  }\r\n\r\n  let imageBase64 = screenshotBase64;\r\n  if (sectionRect) {\r\n    const croppedResult = await cropByRect(\r\n      screenshotBase64,\r\n      sectionRect,\r\n      vlMode === 'qwen-vl',\r\n    );\r\n    imageBase64 = croppedResult.imageBase64;\r\n    sectionRect.width = croppedResult.width;\r\n    sectionRect.height = croppedResult.height;\r\n  }\r\n\r\n  return {\r\n    rect: sectionRect,\r\n    imageBase64,\r\n    error: result.content.error,\r\n    rawResponse: JSON.stringify(result.content),\r\n    usage: result.usage,\r\n  };\r\n}\r\n\r\nexport async function AiExtractElementInfo<\r\n  T,\r\n  ElementType extends BaseElement = BaseElement,\r\n>(options: {\r\n  dataQuery: string | Record<string, string>;\r\n  multimodalPrompt?: TMultimodalPrompt;\r\n  context: UIContext<ElementType>;\r\n  extractOption?: InsightExtractOption;\r\n  modelConfig: IModelConfig;\r\n}) {\r\n  const { dataQuery, context, extractOption, multimodalPrompt, modelConfig } =\r\n    options;\r\n  const { vlMode } = modelConfig;\r\n  const systemPrompt = systemPromptToExtract();\r\n\r\n  const { screenshotBase64 } = context;\r\n\r\n  const { description, elementById } = await describeUserPage(context, {\r\n    truncateTextLength: 200,\r\n    filterNonTextContent: false,\r\n    visibleOnly: false,\r\n    domIncluded: extractOption?.domIncluded,\r\n    vlMode,\r\n  });\r\n\r\n  const extractDataPromptText = extractDataQueryPrompt(description, dataQuery);\r\n\r\n  const userContent: ChatCompletionUserMessageParam['content'] = [];\r\n\r\n  if (extractOption?.screenshotIncluded !== false) {\r\n    userContent.push({\r\n      type: 'image_url',\r\n      image_url: {\r\n        url: screenshotBase64,\r\n        detail: 'high',\r\n      },\r\n    });\r\n  }\r\n\r\n  userContent.push({\r\n    type: 'text',\r\n    text: extractDataPromptText,\r\n  });\r\n\r\n  const msgs: AIArgs = [\r\n    { role: 'system', content: systemPrompt },\r\n    {\r\n      role: 'user',\r\n      content: userContent,\r\n    },\r\n  ];\r\n\r\n  if (multimodalPrompt) {\r\n    const addOns = await promptsToChatParam({\r\n      images: multimodalPrompt.images,\r\n      convertHttpImage2Base64: multimodalPrompt.convertHttpImage2Base64,\r\n    });\r\n    msgs.push(...addOns);\r\n  }\r\n\r\n  const result = await callAIWithObjectResponse<AIDataExtractionResponse<T>>(\r\n    msgs,\r\n    AIActionType.EXTRACT_DATA,\r\n    modelConfig,\r\n  );\r\n  return {\r\n    parseResult: result.content,\r\n    elementById,\r\n    usage: result.usage,\r\n  };\r\n}\r\n"],"names":["debugInspect","getDebug","debugSection","extraTextFromUserPrompt","prompt","promptsToChatParam","multimodalPrompt","_multimodalPrompt_images","msgs","item","base64","preProcessImageUrl","AiLocateElement","options","context","targetElementDescription","callAIFn","modelConfig","vlMode","screenshotBase64","description","elementById","insertElementByPosition","describeUserPage","assert","userInstructionPrompt","findElementPrompt","systemPrompt","systemPromptToLocateElement","imagePayload","imageWidth","imageHeight","originalImageWidth","originalImageHeight","_options_searchConfig_rect","_options_searchConfig_rect1","paddedResult","paddingToMatchBlockByBase64","markupImageForLLM","addOns","res","AIActionType","rawResponse","JSON","resRect","matchedElements","errors","Array","_options_searchConfig_rect2","_options_searchConfig_rect3","adaptBboxToRect","rectCenter","element","elementByPositionWithElementInfo","distanceToCenter","distance","distanceThreshold","e","msg","Error","undefined","AiLocateSection","sectionDescription","systemPromptToLocateSection","sectionLocatorInstructionText","sectionLocatorInstruction","result","callAIWithObjectResponse","sectionRect","sectionBbox","targetRect","referenceBboxList","referenceRects","bbox","mergedRect","mergeRects","expandSearchArea","imageBase64","croppedResult","cropByRect","AiExtractElementInfo","dataQuery","extractOption","systemPromptToExtract","extractDataPromptText","extractDataQueryPrompt","userContent"],"mappings":"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"}