{"version":3,"file":"yaml\\utils.mjs","sources":["webpack://@sqaitech/core/./src/yaml/utils.ts"],"sourcesContent":["import type { TUserPrompt } from '@/ai-model/common';\r\nimport type {\r\n  DetailedLocateParam,\r\n  LocateOption,\r\n  MidsceneYamlScript,\r\n} from '@/types';\r\nimport { getDebug } from '@sqaitech/shared/logger';\r\nimport { assert } from '@sqaitech/shared/utils';\r\nimport yaml from 'js-yaml';\r\n\r\nconst debugUtils = getDebug('yaml:utils');\r\n\r\nexport function interpolateEnvVars(content: string): string {\r\n  // Process line by line to skip commented lines\r\n  const lines = content.split('\\n');\r\n  const processedLines = lines.map((line) => {\r\n    // Check if the line is a YAML comment (starts with # after optional whitespace)\r\n    const trimmedLine = line.trimStart();\r\n    if (trimmedLine.startsWith('#')) {\r\n      // Skip interpolation for comment lines\r\n      return line;\r\n    }\r\n\r\n    // Process environment variables for non-comment lines\r\n    return line.replace(/\\$\\{([^}]+)\\}/g, (_, envVar) => {\r\n      const value = process.env[envVar.trim()];\r\n      if (value === undefined) {\r\n        throw new Error(\r\n          `Environment variable \"${envVar.trim()}\" is not defined`,\r\n        );\r\n      }\r\n      return value;\r\n    });\r\n  });\r\n\r\n  return processedLines.join('\\n');\r\n}\r\n\r\nexport function parseYamlScript(\r\n  content: string,\r\n  filePath?: string,\r\n): MidsceneYamlScript {\r\n  let processedContent = content;\r\n  if (content.indexOf('android') !== -1 && content.match(/deviceId:\\s*(\\d+)/)) {\r\n    let matchedDeviceId;\r\n    processedContent = content.replace(\r\n      /deviceId:\\s*(\\d+)/g,\r\n      (match, deviceId) => {\r\n        matchedDeviceId = deviceId;\r\n        return `deviceId: '${deviceId}'`;\r\n      },\r\n    );\r\n    console.warn(\r\n      `please use string-style deviceId in yaml script, for example: deviceId: \"${matchedDeviceId}\"`,\r\n    );\r\n  }\r\n  const interpolatedContent = interpolateEnvVars(processedContent);\r\n  const obj = yaml.load(interpolatedContent, {\r\n    schema: yaml.JSON_SCHEMA,\r\n  }) as MidsceneYamlScript;\r\n\r\n  const pathTip = filePath ? `, failed to load ${filePath}` : '';\r\n  assert(obj.tasks, `property \"tasks\" is required in yaml script ${pathTip}`);\r\n  assert(\r\n    Array.isArray(obj.tasks),\r\n    `property \"tasks\" must be an array in yaml script, but got ${obj.tasks}`,\r\n  );\r\n  return obj;\r\n}\r\n\r\nexport function buildDetailedLocateParam(\r\n  locatePrompt: TUserPrompt,\r\n  opt?: LocateOption,\r\n): DetailedLocateParam | undefined {\r\n  debugUtils('will call buildDetailedLocateParam', locatePrompt, opt);\r\n  let prompt = locatePrompt || opt?.prompt || (opt as any)?.locate; // as a shortcut\r\n  let deepThink = false;\r\n  let cacheable = true;\r\n  let xpath = undefined;\r\n\r\n  if (typeof opt === 'object' && opt !== null) {\r\n    deepThink = opt.deepThink ?? false;\r\n    cacheable = opt.cacheable ?? true;\r\n    xpath = opt.xpath;\r\n    if (locatePrompt && opt.prompt && locatePrompt !== opt.prompt) {\r\n      console.warn(\r\n        'conflict prompt for item',\r\n        locatePrompt,\r\n        opt,\r\n        'maybe you put the prompt in the wrong place',\r\n      );\r\n    }\r\n    prompt = prompt || opt.prompt;\r\n  }\r\n\r\n  if (!prompt) {\r\n    debugUtils(\r\n      'no prompt, will return undefined in buildDetailedLocateParam',\r\n      opt,\r\n    );\r\n    return undefined;\r\n  }\r\n\r\n  return {\r\n    prompt,\r\n    deepThink,\r\n    cacheable,\r\n    xpath,\r\n  };\r\n}\r\n\r\nexport function buildDetailedLocateParamAndRestParams(\r\n  locatePrompt: TUserPrompt,\r\n  opt: LocateOption | undefined,\r\n  excludeKeys: string[] = [],\r\n): {\r\n  locateParam: DetailedLocateParam | undefined;\r\n  restParams: Record<string, any>;\r\n} {\r\n  const locateParam = buildDetailedLocateParam(locatePrompt, opt);\r\n\r\n  // Extract all keys from opt except the ones already included in locateParam\r\n  const restParams: Record<string, any> = {};\r\n\r\n  if (typeof opt === 'object' && opt !== null) {\r\n    // Get all keys from opt\r\n    const allKeys = Object.keys(opt);\r\n\r\n    // Keys already included in locateParam: prompt, deepThink, cacheable, xpath\r\n    const locateParamKeys = Object.keys(locateParam || {});\r\n\r\n    // Extract all other keys\r\n    for (const key of allKeys) {\r\n      if (\r\n        !locateParamKeys.includes(key) &&\r\n        !excludeKeys.includes(key) &&\r\n        key !== 'locate'\r\n      ) {\r\n        restParams[key] = opt[key as keyof LocateOption];\r\n      }\r\n    }\r\n  }\r\n\r\n  return {\r\n    locateParam,\r\n    restParams,\r\n  };\r\n}\r\n"],"names":["debugUtils","getDebug","interpolateEnvVars","content","lines","processedLines","line","trimmedLine","_","envVar","value","process","undefined","Error","parseYamlScript","filePath","processedContent","matchedDeviceId","match","deviceId","console","interpolatedContent","obj","yaml","pathTip","assert","Array","buildDetailedLocateParam","locatePrompt","opt","prompt","deepThink","cacheable","xpath","buildDetailedLocateParamAndRestParams","excludeKeys","locateParam","restParams","allKeys","Object","locateParamKeys","key"],"mappings":";;;AAUA,MAAMA,aAAaC,SAAS;AAErB,SAASC,mBAAmBC,OAAe;IAEhD,MAAMC,QAAQD,QAAQ,KAAK,CAAC;IAC5B,MAAME,iBAAiBD,MAAM,GAAG,CAAC,CAACE;QAEhC,MAAMC,cAAcD,KAAK,SAAS;QAClC,IAAIC,YAAY,UAAU,CAAC,MAEzB,OAAOD;QAIT,OAAOA,KAAK,OAAO,CAAC,kBAAkB,CAACE,GAAGC;YACxC,MAAMC,QAAQC,QAAQ,GAAG,CAACF,OAAO,IAAI,GAAG;YACxC,IAAIC,AAAUE,WAAVF,OACF,MAAM,IAAIG,MACR,CAAC,sBAAsB,EAAEJ,OAAO,IAAI,GAAG,gBAAgB,CAAC;YAG5D,OAAOC;QACT;IACF;IAEA,OAAOL,eAAe,IAAI,CAAC;AAC7B;AAEO,SAASS,gBACdX,OAAe,EACfY,QAAiB;IAEjB,IAAIC,mBAAmBb;IACvB,IAAIA,AAA+B,OAA/BA,QAAQ,OAAO,CAAC,cAAqBA,QAAQ,KAAK,CAAC,sBAAsB;QAC3E,IAAIc;QACJD,mBAAmBb,QAAQ,OAAO,CAChC,sBACA,CAACe,OAAOC;YACNF,kBAAkBE;YAClB,OAAO,CAAC,WAAW,EAAEA,SAAS,CAAC,CAAC;QAClC;QAEFC,QAAQ,IAAI,CACV,CAAC,yEAAyE,EAAEH,gBAAgB,CAAC,CAAC;IAElG;IACA,MAAMI,sBAAsBnB,mBAAmBc;IAC/C,MAAMM,MAAMC,QAAAA,IAAS,CAACF,qBAAqB;QACzC,QAAQE,QAAAA,WAAgB;IAC1B;IAEA,MAAMC,UAAUT,WAAW,CAAC,iBAAiB,EAAEA,UAAU,GAAG;IAC5DU,OAAOH,IAAI,KAAK,EAAE,CAAC,4CAA4C,EAAEE,SAAS;IAC1EC,OACEC,MAAM,OAAO,CAACJ,IAAI,KAAK,GACvB,CAAC,0DAA0D,EAAEA,IAAI,KAAK,EAAE;IAE1E,OAAOA;AACT;AAEO,SAASK,yBACdC,YAAyB,EACzBC,GAAkB;IAElB7B,WAAW,sCAAsC4B,cAAcC;IAC/D,IAAIC,SAASF,gBAAgBC,CAAAA,QAAAA,MAAAA,KAAAA,IAAAA,IAAK,MAAM,AAAD,KAAMA,CAAAA,QAAAA,MAAAA,KAAAA,IAAAA,IAAa,MAAM,AAAD;IAC/D,IAAIE,YAAY;IAChB,IAAIC,YAAY;IAChB,IAAIC;IAEJ,IAAI,AAAe,YAAf,OAAOJ,OAAoBA,AAAQ,SAARA,KAAc;QAC3CE,YAAYF,IAAI,SAAS,IAAI;QAC7BG,YAAYH,IAAI,SAAS,IAAI;QAC7BI,QAAQJ,IAAI,KAAK;QACjB,IAAID,gBAAgBC,IAAI,MAAM,IAAID,iBAAiBC,IAAI,MAAM,EAC3DT,QAAQ,IAAI,CACV,4BACAQ,cACAC,KACA;QAGJC,SAASA,UAAUD,IAAI,MAAM;IAC/B;IAEA,IAAI,CAACC,QAAQ,YACX9B,WACE,gEACA6B;IAKJ,OAAO;QACLC;QACAC;QACAC;QACAC;IACF;AACF;AAEO,SAASC,sCACdN,YAAyB,EACzBC,GAA6B,EAC7BM,cAAwB,EAAE;IAK1B,MAAMC,cAAcT,yBAAyBC,cAAcC;IAG3D,MAAMQ,aAAkC,CAAC;IAEzC,IAAI,AAAe,YAAf,OAAOR,OAAoBA,AAAQ,SAARA,KAAc;QAE3C,MAAMS,UAAUC,OAAO,IAAI,CAACV;QAG5B,MAAMW,kBAAkBD,OAAO,IAAI,CAACH,eAAe,CAAC;QAGpD,KAAK,MAAMK,OAAOH,QAChB,IACE,CAACE,gBAAgB,QAAQ,CAACC,QAC1B,CAACN,YAAY,QAAQ,CAACM,QACtBA,AAAQ,aAARA,KAEAJ,UAAU,CAACI,IAAI,GAAGZ,GAAG,CAACY,IAA0B;IAGtD;IAEA,OAAO;QACLL;QACAC;IACF;AACF"}