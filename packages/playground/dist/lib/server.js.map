{"version":3,"file":"server.js","sources":["webpack://@sqaitech/playground/webpack/runtime/compat_get_default_export","webpack://@sqaitech/playground/webpack/runtime/define_property_getters","webpack://@sqaitech/playground/webpack/runtime/has_own_property","webpack://@sqaitech/playground/webpack/runtime/make_namespace_object","webpack://@sqaitech/playground/./src/server.ts"],"sourcesContent":["// getDefaultExport function for compatibility with non-ESM modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};\n","__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n        if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n            Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n        }\n    }\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","import { existsSync, readFileSync, writeFileSync } from 'node:fs';\r\nimport type { Server } from 'node:http';\r\nimport { dirname, join } from 'node:path';\r\nimport { fileURLToPath } from 'node:url';\r\nimport type { Agent as PageAgent } from '@sqaitech/core/agent';\r\nimport { getTmpDir } from '@sqaitech/core/utils';\r\nimport { PLAYGROUND_SERVER_PORT } from '@sqaitech/shared/constants';\r\nimport { overrideAIConfig } from '@sqaitech/shared/env';\r\nimport { uuid } from '@sqaitech/shared/utils';\r\nimport express, { type Request, type Response } from 'express';\r\nimport { executeAction, formatErrorMessage } from './common';\r\n\r\nimport 'dotenv/config';\r\n\r\nconst defaultPort = PLAYGROUND_SERVER_PORT;\r\n\r\n// Static path for playground files\r\nconst __filename = fileURLToPath(import.meta.url);\r\nconst __dirname = dirname(__filename);\r\nconst STATIC_PATH = join(__dirname, '..', '..', 'static');\r\n\r\nconst errorHandler = (\r\n  err: unknown,\r\n  req: Request,\r\n  res: Response,\r\n  next: express.NextFunction,\r\n) => {\r\n  console.error(err);\r\n  const errorMessage =\r\n    err instanceof Error ? err.message : 'Internal server error';\r\n  res.status(500).json({\r\n    error: errorMessage,\r\n  });\r\n};\r\n\r\nclass PlaygroundServer {\r\n  private _app: express.Application;\r\n  tmpDir: string;\r\n  server?: Server;\r\n  port?: number | null;\r\n  agent: PageAgent;\r\n  staticPath: string;\r\n  taskProgressTips: Record<string, string>;\r\n  id: string; // Unique identifier for this server instance\r\n\r\n  private _initialized = false;\r\n\r\n  // Factory function for recreating agent\r\n  private agentFactory?: (() => PageAgent | Promise<PageAgent>) | null;\r\n\r\n  // Track current running task\r\n  private currentTaskId: string | null = null;\r\n\r\n  constructor(\r\n    agent: PageAgent | (() => PageAgent) | (() => Promise<PageAgent>),\r\n    staticPath = STATIC_PATH,\r\n    id?: string, // Optional override ID\r\n  ) {\r\n    this._app = express();\r\n    this.tmpDir = getTmpDir()!;\r\n    this.staticPath = staticPath;\r\n    this.taskProgressTips = {};\r\n    // Use provided ID, or generate random UUID for each startup\r\n    this.id = id || uuid();\r\n\r\n    // Support both instance and factory function modes\r\n    if (typeof agent === 'function') {\r\n      this.agentFactory = agent;\r\n      this.agent = null as any; // Will be initialized in launch()\r\n    } else {\r\n      this.agent = agent;\r\n      this.agentFactory = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the Express app instance for custom configuration\r\n   *\r\n   * IMPORTANT: Add middleware (like CORS) BEFORE calling launch()\r\n   * The routes are initialized when launch() is called, so middleware\r\n   * added after launch() will not affect the API routes.\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * import cors from 'cors';\r\n   *\r\n   * const server = new PlaygroundServer(agent);\r\n   *\r\n   * // Add CORS middleware before launch\r\n   * server.app.use(cors({\r\n   *   origin: true,\r\n   *   credentials: true,\r\n   *   methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS']\r\n   * }));\r\n   *\r\n   * await server.launch();\r\n   * ```\r\n   */\r\n  get app(): express.Application {\r\n    return this._app;\r\n  }\r\n\r\n  /**\r\n   * Initialize Express app with all routes and middleware\r\n   * Called automatically by launch() if not already initialized\r\n   */\r\n  private initializeApp(): void {\r\n    if (this._initialized) return;\r\n\r\n    // Built-in middleware to parse JSON bodies\r\n    this._app.use(express.json({ limit: '50mb' }));\r\n\r\n    // Context update middleware (after JSON parsing)\r\n    this._app.use(\r\n      (req: Request, _res: Response, next: express.NextFunction) => {\r\n        const { context } = req.body || {};\r\n        if (\r\n          context &&\r\n          'updateContext' in this.agent.interface &&\r\n          typeof this.agent.interface.updateContext === 'function'\r\n        ) {\r\n          this.agent.interface.updateContext(context);\r\n          console.log('Context updated by PlaygroundServer middleware');\r\n        }\r\n        next();\r\n      },\r\n    );\r\n\r\n    // NOTE: CORS middleware should be added externally via server.app.use()\r\n    // before calling server.launch() if needed\r\n\r\n    // API routes\r\n    this.setupRoutes();\r\n\r\n    // Static file serving (if staticPath is provided)\r\n    this.setupStaticRoutes();\r\n\r\n    // Error handler middleware (must be last)\r\n    this._app.use(errorHandler);\r\n\r\n    this._initialized = true;\r\n  }\r\n\r\n  filePathForUuid(uuid: string) {\r\n    return join(this.tmpDir, `${uuid}.json`);\r\n  }\r\n\r\n  saveContextFile(uuid: string, context: string) {\r\n    const tmpFile = this.filePathForUuid(uuid);\r\n    console.log(`save context file: ${tmpFile}`);\r\n    writeFileSync(tmpFile, context);\r\n    return tmpFile;\r\n  }\r\n\r\n  /**\r\n   * Recreate agent instance (for cancellation)\r\n   */\r\n  private async recreateAgent(): Promise<void> {\r\n    if (!this.agentFactory) {\r\n      console.warn(\r\n        'Cannot recreate agent: factory function not provided. Agent recreation is only available when using factory mode.',\r\n      );\r\n      return;\r\n    }\r\n\r\n    console.log('Recreating agent to cancel current task...');\r\n\r\n    // Destroy old agent instance\r\n    try {\r\n      if (this.agent && typeof this.agent.destroy === 'function') {\r\n        await this.agent.destroy();\r\n      }\r\n    } catch (error) {\r\n      console.warn('Failed to destroy old agent:', error);\r\n    }\r\n\r\n    // Create new agent instance\r\n    try {\r\n      this.agent = await this.agentFactory();\r\n      console.log('Agent recreated successfully');\r\n    } catch (error) {\r\n      console.error('Failed to recreate agent:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Setup all API routes\r\n   */\r\n  private setupRoutes(): void {\r\n    this._app.get('/status', async (req: Request, res: Response) => {\r\n      res.send({\r\n        status: 'ok',\r\n        id: this.id,\r\n      });\r\n    });\r\n\r\n    this._app.get('/context/:uuid', async (req: Request, res: Response) => {\r\n      const { uuid } = req.params;\r\n      const contextFile = this.filePathForUuid(uuid);\r\n\r\n      if (!existsSync(contextFile)) {\r\n        return res.status(404).json({\r\n          error: 'Context not found',\r\n        });\r\n      }\r\n\r\n      const context = readFileSync(contextFile, 'utf8');\r\n      res.json({\r\n        context,\r\n      });\r\n    });\r\n\r\n    this._app.get(\r\n      '/task-progress/:requestId',\r\n      async (req: Request, res: Response) => {\r\n        const { requestId } = req.params;\r\n        res.json({\r\n          tip: this.taskProgressTips[requestId] || '',\r\n        });\r\n      },\r\n    );\r\n\r\n    this._app.post('/action-space', async (req: Request, res: Response) => {\r\n      try {\r\n        let actionSpace = [];\r\n\r\n        actionSpace = await this.agent.interface.actionSpace();\r\n\r\n        // Process actionSpace to make paramSchema serializable with shape info\r\n        const processedActionSpace = actionSpace.map((action: unknown) => {\r\n          if (action && typeof action === 'object' && 'paramSchema' in action) {\r\n            const typedAction = action as {\r\n              paramSchema?: { shape?: object; [key: string]: unknown };\r\n              [key: string]: unknown;\r\n            };\r\n            if (\r\n              typedAction.paramSchema &&\r\n              typeof typedAction.paramSchema === 'object'\r\n            ) {\r\n              // Extract shape information from Zod schema\r\n              let processedSchema = null;\r\n\r\n              try {\r\n                // Extract shape from runtime Zod object\r\n                if (\r\n                  typedAction.paramSchema.shape &&\r\n                  typeof typedAction.paramSchema.shape === 'object'\r\n                ) {\r\n                  processedSchema = {\r\n                    type: 'ZodObject',\r\n                    shape: typedAction.paramSchema.shape,\r\n                  };\r\n                }\r\n              } catch (e) {\r\n                const actionName =\r\n                  'name' in typedAction && typeof typedAction.name === 'string'\r\n                    ? typedAction.name\r\n                    : 'unknown';\r\n                console.warn(\r\n                  'Failed to process paramSchema for action:',\r\n                  actionName,\r\n                  e,\r\n                );\r\n              }\r\n\r\n              return {\r\n                ...typedAction,\r\n                paramSchema: processedSchema,\r\n              };\r\n            }\r\n          }\r\n          return action;\r\n        });\r\n\r\n        res.json(processedActionSpace);\r\n      } catch (error: unknown) {\r\n        const errorMessage =\r\n          error instanceof Error ? error.message : 'Unknown error';\r\n        console.error('Failed to get action space:', error);\r\n        res.status(500).json({\r\n          error: errorMessage,\r\n        });\r\n      }\r\n    });\r\n\r\n    // -------------------------\r\n    // actions from report file\r\n    this._app.post(\r\n      '/playground-with-context',\r\n      async (req: Request, res: Response) => {\r\n        const context = req.body.context;\r\n\r\n        if (!context) {\r\n          return res.status(400).json({\r\n            error: 'context is required',\r\n          });\r\n        }\r\n\r\n        const requestId = uuid();\r\n        this.saveContextFile(requestId, context);\r\n        return res.json({\r\n          location: `/playground/${requestId}`,\r\n          uuid: requestId,\r\n        });\r\n      },\r\n    );\r\n\r\n    this._app.post('/execute', async (req: Request, res: Response) => {\r\n      const {\r\n        type,\r\n        prompt,\r\n        params,\r\n        requestId,\r\n        deepThink,\r\n        screenshotIncluded,\r\n        domIncluded,\r\n      } = req.body;\r\n\r\n      if (!type) {\r\n        return res.status(400).json({\r\n          error: 'type is required',\r\n        });\r\n      }\r\n\r\n      // Check if another task is running\r\n      if (this.currentTaskId) {\r\n        return res.status(409).json({\r\n          error: 'Another task is already running',\r\n          currentTaskId: this.currentTaskId,\r\n        });\r\n      }\r\n\r\n      // Lock this task\r\n      if (requestId) {\r\n        this.currentTaskId = requestId;\r\n        this.taskProgressTips[requestId] = '';\r\n\r\n        this.agent.onTaskStartTip = (tip: string) => {\r\n          this.taskProgressTips[requestId] = tip;\r\n        };\r\n      }\r\n\r\n      const response: {\r\n        result: unknown;\r\n        dump: string | null;\r\n        error: string | null;\r\n        reportHTML: string | null;\r\n        requestId?: string;\r\n      } = {\r\n        result: null,\r\n        dump: null,\r\n        error: null,\r\n        reportHTML: null,\r\n        requestId,\r\n      };\r\n\r\n      const startTime = Date.now();\r\n      try {\r\n        // Get action space to check for dynamic actions\r\n        const actionSpace = await this.agent.interface.actionSpace();\r\n\r\n        // Prepare value object for executeAction\r\n        const value = {\r\n          type,\r\n          prompt,\r\n          params,\r\n        };\r\n\r\n        response.result = await executeAction(\r\n          this.agent,\r\n          type,\r\n          actionSpace,\r\n          value,\r\n          {\r\n            deepThink,\r\n            screenshotIncluded,\r\n            domIncluded,\r\n          },\r\n        );\r\n      } catch (error: unknown) {\r\n        response.error = formatErrorMessage(error);\r\n      }\r\n\r\n      try {\r\n        response.dump = JSON.parse(this.agent.dumpDataString());\r\n        response.reportHTML = this.agent.reportHTMLString() || null;\r\n\r\n        this.agent.writeOutActionDumps();\r\n        this.agent.resetDump();\r\n      } catch (error: unknown) {\r\n        const errorMessage =\r\n          error instanceof Error ? error.message : 'Unknown error';\r\n        console.error(\r\n          `write out dump failed: requestId: ${requestId}, ${errorMessage}`,\r\n        );\r\n      }\r\n\r\n      res.send(response);\r\n      const timeCost = Date.now() - startTime;\r\n\r\n      if (response.error) {\r\n        console.error(\r\n          `handle request failed after ${timeCost}ms: requestId: ${requestId}, ${response.error}`,\r\n        );\r\n      } else {\r\n        console.log(\r\n          `handle request done after ${timeCost}ms: requestId: ${requestId}`,\r\n        );\r\n      }\r\n\r\n      // Clean up task progress tip and unlock after execution completes\r\n      if (requestId) {\r\n        delete this.taskProgressTips[requestId];\r\n        // Release the lock\r\n        if (this.currentTaskId === requestId) {\r\n          this.currentTaskId = null;\r\n        }\r\n      }\r\n    });\r\n\r\n    this._app.post(\r\n      '/cancel/:requestId',\r\n      async (req: Request, res: Response) => {\r\n        const { requestId } = req.params;\r\n\r\n        if (!requestId) {\r\n          return res.status(400).json({\r\n            error: 'requestId is required',\r\n          });\r\n        }\r\n\r\n        try {\r\n          // Check if this is the current running task\r\n          if (this.currentTaskId !== requestId) {\r\n            return res.json({\r\n              status: 'not_found',\r\n              message: 'Task not found or already completed',\r\n            });\r\n          }\r\n\r\n          console.log(`Cancelling task: ${requestId}`);\r\n\r\n          // Recreate agent to cancel the current task\r\n          await this.recreateAgent();\r\n\r\n          // Clean up\r\n          delete this.taskProgressTips[requestId];\r\n          this.currentTaskId = null;\r\n\r\n          res.json({\r\n            status: 'cancelled',\r\n            message: 'Task cancelled successfully by recreating agent',\r\n          });\r\n        } catch (error: unknown) {\r\n          const errorMessage =\r\n            error instanceof Error ? error.message : 'Unknown error';\r\n          console.error(`Failed to cancel: ${errorMessage}`);\r\n          res.status(500).json({\r\n            error: `Failed to cancel: ${errorMessage}`,\r\n          });\r\n        }\r\n      },\r\n    );\r\n\r\n    // Screenshot API for real-time screenshot polling\r\n    this._app.get('/screenshot', async (_req: Request, res: Response) => {\r\n      try {\r\n        // Check if page has screenshotBase64 method\r\n        if (typeof this.agent.interface.screenshotBase64 !== 'function') {\r\n          return res.status(500).json({\r\n            error: 'Screenshot method not available on current interface',\r\n          });\r\n        }\r\n\r\n        const base64Screenshot = await this.agent.interface.screenshotBase64();\r\n\r\n        res.json({\r\n          screenshot: base64Screenshot,\r\n          timestamp: Date.now(),\r\n        });\r\n      } catch (error: unknown) {\r\n        const errorMessage =\r\n          error instanceof Error ? error.message : 'Unknown error';\r\n        console.error(`Failed to take screenshot: ${errorMessage}`);\r\n        res.status(500).json({\r\n          error: `Failed to take screenshot: ${errorMessage}`,\r\n        });\r\n      }\r\n    });\r\n\r\n    // Interface info API for getting interface type and description\r\n    this._app.get('/interface-info', async (_req: Request, res: Response) => {\r\n      try {\r\n        const type = this.agent.interface.interfaceType || 'Unknown';\r\n        const description = this.agent.interface.describe?.() || undefined;\r\n\r\n        res.json({\r\n          type,\r\n          description,\r\n        });\r\n      } catch (error: unknown) {\r\n        const errorMessage =\r\n          error instanceof Error ? error.message : 'Unknown error';\r\n        console.error(`Failed to get interface info: ${errorMessage}`);\r\n        res.status(500).json({\r\n          error: `Failed to get interface info: ${errorMessage}`,\r\n        });\r\n      }\r\n    });\r\n\r\n    this.app.post('/config', async (req: Request, res: Response) => {\r\n      const { aiConfig } = req.body;\r\n\r\n      if (!aiConfig || typeof aiConfig !== 'object') {\r\n        return res.status(400).json({\r\n          error: 'aiConfig is required and must be an object',\r\n        });\r\n      }\r\n\r\n      if (Object.keys(aiConfig).length === 0) {\r\n        return res.json({\r\n          status: 'ok',\r\n          message: 'AI config not changed due to empty object',\r\n        });\r\n      }\r\n\r\n      try {\r\n        overrideAIConfig(aiConfig);\r\n\r\n        return res.json({\r\n          status: 'ok',\r\n          message: 'AI config updated successfully',\r\n        });\r\n      } catch (error: unknown) {\r\n        const errorMessage =\r\n          error instanceof Error ? error.message : 'Unknown error';\r\n        console.error(`Failed to update AI config: ${errorMessage}`);\r\n        return res.status(500).json({\r\n          error: `Failed to update AI config: ${errorMessage}`,\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Setup static file serving routes\r\n   */\r\n  private setupStaticRoutes(): void {\r\n    // Handle index.html with port injection\r\n    this._app.get('/', (_req: Request, res: Response) => {\r\n      this.serveHtmlWithPorts(res);\r\n    });\r\n\r\n    this._app.get('/index.html', (_req: Request, res: Response) => {\r\n      this.serveHtmlWithPorts(res);\r\n    });\r\n\r\n    // Use express.static middleware for secure static file serving\r\n    this._app.use(express.static(this.staticPath));\r\n\r\n    // Fallback to index.html for SPA routing\r\n    this._app.get('*', (_req: Request, res: Response) => {\r\n      this.serveHtmlWithPorts(res);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Serve HTML with injected port configuration\r\n   */\r\n  private serveHtmlWithPorts(res: Response): void {\r\n    try {\r\n      const htmlPath = join(this.staticPath, 'index.html');\r\n      let html = readFileSync(htmlPath, 'utf8');\r\n\r\n      // Get scrcpy server port from global\r\n      const scrcpyPort = (global as any).scrcpyServerPort || this.port! + 1;\r\n\r\n      // Inject scrcpy port configuration script into HTML head\r\n      const configScript = `\r\n        <script>\r\n          window.SCRCPY_PORT = ${scrcpyPort};\r\n        </script>\r\n      `;\r\n\r\n      // Insert the script before closing </head> tag\r\n      html = html.replace('</head>', `${configScript}</head>`);\r\n\r\n      res.setHeader('Content-Type', 'text/html');\r\n      res.send(html);\r\n    } catch (error) {\r\n      console.error('Error serving HTML with ports:', error);\r\n      res.status(500).send('Internal Server Error');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Launch the server on specified port\r\n   */\r\n  async launch(port?: number): Promise<PlaygroundServer> {\r\n    // If using factory mode, initialize agent\r\n    if (this.agentFactory) {\r\n      console.log('Initializing agent from factory function...');\r\n      this.agent = await this.agentFactory();\r\n      console.log('Agent initialized successfully');\r\n    }\r\n\r\n    // Initialize routes now, after any middleware has been added\r\n    this.initializeApp();\r\n\r\n    this.port = port || defaultPort;\r\n\r\n    return new Promise((resolve) => {\r\n      const serverPort = this.port;\r\n      this.server = this._app.listen(serverPort, () => {\r\n        resolve(this);\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Close the server and clean up resources\r\n   */\r\n  async close(): Promise<void> {\r\n    return new Promise((resolve, reject) => {\r\n      if (this.server) {\r\n        // Clean up the single agent\r\n        try {\r\n          this.agent.destroy();\r\n        } catch (error) {\r\n          console.warn('Failed to destroy agent:', error);\r\n        }\r\n        this.taskProgressTips = {};\r\n\r\n        // Close the server\r\n        this.server.close((error) => {\r\n          if (error) {\r\n            reject(error);\r\n          } else {\r\n            this.server = undefined;\r\n            resolve();\r\n          }\r\n        });\r\n      } else {\r\n        resolve();\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\nexport default PlaygroundServer;\r\nexport { PlaygroundServer };\r\n"],"names":["__webpack_require__","module","getter","definition","key","Object","obj","prop","Symbol","defaultPort","PLAYGROUND_SERVER_PORT","__filename","fileURLToPath","__dirname","dirname","STATIC_PATH","join","errorHandler","err","req","res","next","console","errorMessage","Error","PlaygroundServer","express","_res","context","uuid","tmpFile","writeFileSync","error","contextFile","existsSync","readFileSync","requestId","actionSpace","processedActionSpace","action","typedAction","processedSchema","e","actionName","type","prompt","params","deepThink","screenshotIncluded","domIncluded","tip","response","startTime","Date","value","executeAction","formatErrorMessage","JSON","timeCost","_req","base64Screenshot","_this_agent_interface","description","undefined","aiConfig","overrideAIConfig","htmlPath","html","scrcpyPort","global","configScript","port","Promise","resolve","serverPort","reject","agent","staticPath","id","getTmpDir"],"mappings":"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"}