{"version":3,"file":"common.mjs","sources":["webpack://@sqaitech/playground/./src/common.ts"],"sourcesContent":["import type { DeviceAction } from '@sqaitech/core';\r\nimport { findAllMidsceneLocatorField } from '@sqaitech/core/ai-model';\r\nimport { buildDetailedLocateParam } from '@sqaitech/core/yaml';\r\nimport type {\r\n  ExecutionOptions,\r\n  FormValue,\r\n  PlaygroundAgent,\r\n  ValidationResult,\r\n} from './types';\r\n\r\n// APIs that should not generate replay scripts\r\nexport const dataExtractionAPIs = [\r\n  'aiQuery',\r\n  'aiBoolean',\r\n  'aiNumber',\r\n  'aiString',\r\n  'aiAsk',\r\n];\r\n\r\nexport const validationAPIs = ['aiAssert', 'aiWaitFor'];\r\n\r\nexport const noReplayAPIs = [...dataExtractionAPIs, ...validationAPIs];\r\n\r\nexport const formatErrorMessage = (e: any): string => {\r\n  const errorMessage = e?.message || '';\r\n\r\n  if (errorMessage.includes('of different extension')) {\r\n    return 'Conflicting extension detected. Please disable the suspicious plugins and refresh the page. Guide: https://midscenejs.com/quick-experience.html#faq';\r\n  }\r\n\r\n  if (errorMessage.includes('NOT_IMPLEMENTED_AS_DESIGNED')) {\r\n    return 'Further actions cannot be performed in the current environment';\r\n  }\r\n\r\n  return errorMessage || 'Unknown error';\r\n};\r\n\r\n// Parse structured parameters for callActionInActionSpace\r\nexport async function parseStructuredParams(\r\n  action: DeviceAction<unknown>,\r\n  params: Record<string, unknown>,\r\n  options: ExecutionOptions = {},\r\n): Promise<unknown[]> {\r\n  if (!action?.paramSchema || !('shape' in action.paramSchema)) {\r\n    return [params.prompt || '', options];\r\n  }\r\n\r\n  const schema = action.paramSchema;\r\n  const keys =\r\n    schema && 'shape' in schema\r\n      ? Object.keys((schema as { shape: Record<string, unknown> }).shape)\r\n      : [];\r\n\r\n  const paramObj: Record<string, unknown> = { ...options };\r\n\r\n  keys.forEach((key) => {\r\n    if (\r\n      params[key] !== undefined &&\r\n      params[key] !== null &&\r\n      params[key] !== ''\r\n    ) {\r\n      paramObj[key] = params[key];\r\n    }\r\n  });\r\n\r\n  // Check if there's a locate field that needs detailed locate param processing\r\n  if (schema) {\r\n    const locatorFieldKeys = findAllMidsceneLocatorField(schema);\r\n    locatorFieldKeys.forEach((locateKey: string) => {\r\n      const locatePrompt = params[locateKey];\r\n      if (locatePrompt && typeof locatePrompt === 'string') {\r\n        // Build detailed locate param using the locate prompt and options\r\n        const detailedLocateParam = buildDetailedLocateParam(locatePrompt, {\r\n          deepThink: options.deepThink,\r\n          cacheable: true, // Default to true for playground\r\n        });\r\n        if (detailedLocateParam) {\r\n          paramObj[locateKey] = detailedLocateParam;\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  return [paramObj];\r\n}\r\n\r\nexport function validateStructuredParams(\r\n  value: FormValue,\r\n  action: DeviceAction<unknown> | undefined,\r\n): ValidationResult {\r\n  if (!value.params) {\r\n    return { valid: false, errorMessage: 'Parameters are required' };\r\n  }\r\n\r\n  if (!action?.paramSchema) {\r\n    return { valid: true };\r\n  }\r\n\r\n  try {\r\n    const paramsForValidation = { ...value.params };\r\n\r\n    const schema = action.paramSchema;\r\n    if (schema) {\r\n      const locatorFieldKeys = findAllMidsceneLocatorField(schema);\r\n      locatorFieldKeys.forEach((key: string) => {\r\n        if (typeof paramsForValidation[key] === 'string') {\r\n          paramsForValidation[key] = {\r\n            midscene_location_field_flag: true,\r\n            prompt: paramsForValidation[key],\r\n            center: [0, 0],\r\n            rect: { left: 0, top: 0, width: 0, height: 0 },\r\n          };\r\n        }\r\n      });\r\n    }\r\n\r\n    action.paramSchema?.parse(paramsForValidation);\r\n    return { valid: true };\r\n  } catch (error: unknown) {\r\n    const zodError = error as {\r\n      errors?: Array<{ path: string[]; message: string }>;\r\n    };\r\n    if (zodError.errors && zodError.errors.length > 0) {\r\n      const errorMessages = zodError.errors\r\n        .filter((err) => {\r\n          const path = err.path.join('.');\r\n          return (\r\n            !path.includes('center') &&\r\n            !path.includes('rect') &&\r\n            !path.includes('midscene_location_field_flag')\r\n          );\r\n        })\r\n        .map((err) => {\r\n          const field = err.path.join('.');\r\n          return `${field}: ${err.message}`;\r\n        });\r\n\r\n      if (errorMessages.length > 0) {\r\n        return {\r\n          valid: false,\r\n          errorMessage: `Validation error: ${errorMessages.join(', ')}`,\r\n        };\r\n      }\r\n    } else {\r\n      const errorMsg =\r\n        error instanceof Error ? error.message : 'Unknown validation error';\r\n      return {\r\n        valid: false,\r\n        errorMessage: `Parameter validation failed: ${errorMsg}`,\r\n      };\r\n    }\r\n  }\r\n\r\n  return { valid: true };\r\n}\r\n\r\nexport async function executeAction(\r\n  activeAgent: PlaygroundAgent,\r\n  actionType: string,\r\n  actionSpace: DeviceAction<unknown>[],\r\n  value: FormValue,\r\n  options: ExecutionOptions,\r\n): Promise<unknown> {\r\n  const action = actionSpace?.find(\r\n    (a: DeviceAction<unknown>) =>\r\n      a.interfaceAlias === actionType || a.name === actionType,\r\n  );\r\n\r\n  if (action && typeof activeAgent.callActionInActionSpace === 'function') {\r\n    if (value.params) {\r\n      const parsedParams = await parseStructuredParams(\r\n        action,\r\n        value.params,\r\n        options,\r\n      );\r\n      return await activeAgent.callActionInActionSpace(\r\n        action.name,\r\n        parsedParams[0],\r\n      );\r\n    } else {\r\n      // For prompt-based actions, we need to build the detailed locate param\r\n      const detailedLocateParam = value.prompt\r\n        ? buildDetailedLocateParam(value.prompt, {\r\n            deepThink: options.deepThink,\r\n            cacheable: true,\r\n          })\r\n        : undefined;\r\n\r\n      return await activeAgent.callActionInActionSpace(action.name, {\r\n        locate: detailedLocateParam,\r\n        ...options,\r\n      });\r\n    }\r\n  } else {\r\n    const prompt = value.prompt;\r\n\r\n    if (actionType === 'aiAssert') {\r\n      const { pass, thought } =\r\n        (await activeAgent?.aiAssert?.(prompt || '', undefined, {\r\n          keepRawResponse: true,\r\n          ...options,\r\n        })) || {};\r\n      return { pass: pass || false, thought: thought || '' };\r\n    }\r\n\r\n    // Fallback for methods not found in actionSpace\r\n    if (activeAgent && typeof activeAgent[actionType] === 'function') {\r\n      return await activeAgent[actionType](prompt, options);\r\n    }\r\n\r\n    throw new Error(`Unknown action type: ${actionType}`);\r\n  }\r\n}\r\n"],"names":["dataExtractionAPIs","validationAPIs","noReplayAPIs","formatErrorMessage","e","errorMessage","parseStructuredParams","action","params","options","schema","keys","Object","paramObj","key","undefined","locatorFieldKeys","findAllMidsceneLocatorField","locateKey","locatePrompt","detailedLocateParam","buildDetailedLocateParam","validateStructuredParams","value","_action_paramSchema","paramsForValidation","error","zodError","errorMessages","err","path","field","errorMsg","Error","executeAction","activeAgent","actionType","actionSpace","a","parsedParams","prompt","pass","thought"],"mappings":"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"}