{"version":3,"file":"launcher.mjs","sources":["webpack://@sqaitech/playground/./src/launcher.ts"],"sourcesContent":["import { spawn } from 'node:child_process';\r\nimport type { Agent, Agent as PageAgent } from '@sqaitech/core/agent';\r\nimport { PLAYGROUND_SERVER_PORT } from '@sqaitech/shared/constants';\r\nimport cors from 'cors';\r\nimport PlaygroundServer from './server';\r\n\r\nexport interface LaunchPlaygroundOptions {\r\n  /**\r\n   * Port to start the playground server on\r\n   * @default 5800\r\n   */\r\n  port?: number;\r\n\r\n  /**\r\n   * Whether to automatically open the playground in browser\r\n   * @default true\r\n   */\r\n  openBrowser?: boolean;\r\n\r\n  /**\r\n   * Custom browser command to open playground\r\n   * @default 'open' on macOS, 'start' on Windows, 'xdg-open' on Linux\r\n   */\r\n  browserCommand?: string;\r\n\r\n  /**\r\n   * Whether to show server logs\r\n   * @default true\r\n   */\r\n  verbose?: boolean;\r\n\r\n  /**\r\n   * Fixed ID for the playground server instance\r\n   * If provided, the same ID will be used across restarts,\r\n   * allowing chat history to persist\r\n   * @default undefined (generates random UUID)\r\n   */\r\n  id?: string;\r\n\r\n  /**\r\n   * Whether to enable CORS (Cross-Origin Resource Sharing)\r\n   * @default false\r\n   */\r\n  enableCors?: boolean;\r\n\r\n  /**\r\n   * CORS configuration options\r\n   * @default { origin: '*', credentials: true } when enableCors is true\r\n   */\r\n  corsOptions?: {\r\n    origin?: string | boolean | string[];\r\n    credentials?: boolean;\r\n    methods?: string[];\r\n    allowedHeaders?: string[];\r\n  };\r\n}\r\n\r\nexport interface LaunchPlaygroundResult {\r\n  /**\r\n   * The playground server instance\r\n   */\r\n  server: PlaygroundServer;\r\n\r\n  /**\r\n   * The server port\r\n   */\r\n  port: number;\r\n\r\n  /**\r\n   * The server host\r\n   */\r\n  host: string;\r\n\r\n  /**\r\n   * Function to gracefully shutdown the playground\r\n   */\r\n  close: () => Promise<void>;\r\n}\r\n\r\n/**\r\n * Create a playground launcher for a specific agent\r\n *\r\n * @example\r\n * ```typescript\r\n * import { playgroundForAgent } from '@sqaitech/playground';\r\n * import { SampleDevice, Agent } from '@sqaitech/core';\r\n *\r\n * const device = new SampleDevice();\r\n * const agent = new Agent(device);\r\n *\r\n * // Launch playground for the agent\r\n * const server = await playgroundForAgent(agent).launch();\r\n *\r\n * // Launch with CORS enabled\r\n * const serverWithCors = await playgroundForAgent(agent).launch({\r\n *   enableCors: true,\r\n *   corsOptions: {\r\n *     origin: ['http://localhost:3000', 'http://localhost:8080'],\r\n *     credentials: true\r\n *   }\r\n * });\r\n *\r\n * // Later, when you want to shutdown:\r\n * server.close();\r\n * ```\r\n */\r\nexport function playgroundForAgent(agent: Agent) {\r\n  return {\r\n    /**\r\n     * Launch the playground server with optional configuration\r\n     */\r\n    async launch(\r\n      options: LaunchPlaygroundOptions = {},\r\n    ): Promise<LaunchPlaygroundResult> {\r\n      const {\r\n        port = PLAYGROUND_SERVER_PORT,\r\n        openBrowser = true,\r\n        browserCommand,\r\n        verbose = true,\r\n        id,\r\n        enableCors = false,\r\n        corsOptions = { origin: '*', credentials: true },\r\n      } = options;\r\n\r\n      // Extract agent components - Agent has interface property\r\n      const webPage = agent.interface;\r\n      if (!webPage) {\r\n        throw new Error('Agent must have an interface property');\r\n      }\r\n\r\n      if (verbose) {\r\n        console.log('üöÄ Starting Midscene Playground...');\r\n        console.log(`üì± Agent: ${agent.constructor.name}`);\r\n        console.log(`üñ•Ô∏è Page: ${webPage.constructor.name}`);\r\n        console.log(`üåê Port: ${port}`);\r\n        if (enableCors) {\r\n          console.log('üîì CORS enabled');\r\n        }\r\n      }\r\n\r\n      // Create and launch the server with agent instance\r\n      const server = new PlaygroundServer(\r\n        agent as unknown as PageAgent,\r\n        undefined, // staticPath - use default\r\n        id, // Optional override ID (usually not needed now)\r\n      );\r\n\r\n      // Register CORS middleware if enabled\r\n      if (enableCors) {\r\n        server.app.use(cors(corsOptions));\r\n      }\r\n\r\n      const launchedServer = (await server.launch(port)) as PlaygroundServer;\r\n\r\n      if (verbose) {\r\n        console.log(`‚úÖ Playground server started on port ${port}`);\r\n      }\r\n\r\n      const url = `http://127.0.0.1:${port}`;\r\n\r\n      // Open browser if requested\r\n      if (openBrowser) {\r\n        await openInBrowser(url, browserCommand, verbose);\r\n      }\r\n\r\n      return {\r\n        server: launchedServer,\r\n        port,\r\n        host: '127.0.0.1',\r\n        close: async () => {\r\n          if (verbose) {\r\n            console.log('üõë Shutting down Midscene Playground...');\r\n          }\r\n\r\n          try {\r\n            await launchedServer.close();\r\n            if (verbose) {\r\n              console.log('‚úÖ Playground shutdown complete');\r\n            }\r\n          } catch (error) {\r\n            if (verbose) {\r\n              console.error('‚ùå Error during playground shutdown:', error);\r\n            }\r\n            throw error;\r\n          }\r\n        },\r\n      };\r\n    },\r\n  };\r\n}\r\n\r\n/**\r\n * Open URL in browser using platform-appropriate command\r\n */\r\nasync function openInBrowser(\r\n  url: string,\r\n  customCommand?: string,\r\n  verbose = true,\r\n): Promise<void> {\r\n  return new Promise((resolve, reject) => {\r\n    let command: string;\r\n    let args: string[];\r\n\r\n    if (customCommand) {\r\n      command = customCommand;\r\n      args = [url];\r\n    } else {\r\n      // Detect platform and use appropriate command\r\n      switch (process.platform) {\r\n        case 'darwin':\r\n          command = 'open';\r\n          args = [url];\r\n          break;\r\n        case 'win32':\r\n          command = 'start';\r\n          args = ['', url]; // Empty string for title\r\n          break;\r\n        default:\r\n          command = 'xdg-open';\r\n          args = [url];\r\n          break;\r\n      }\r\n    }\r\n\r\n    if (verbose) {\r\n      console.log(`üåê Opening browser: ${command} ${args.join(' ')}`);\r\n    }\r\n\r\n    const child = spawn(command, args, {\r\n      detached: true,\r\n      stdio: 'ignore',\r\n    });\r\n\r\n    child.on('error', (error) => {\r\n      if (verbose) {\r\n        console.warn('‚ö†Ô∏è  Failed to open browser automatically:', error.message);\r\n        console.log(`üåê Please open manually: ${url}`);\r\n      }\r\n      // Don't reject, just continue - browser opening is optional\r\n      resolve();\r\n    });\r\n\r\n    child.on('close', () => {\r\n      resolve();\r\n    });\r\n\r\n    // Don't wait for the browser process\r\n    child.unref();\r\n  });\r\n}\r\n"],"names":["playgroundForAgent","agent","options","port","PLAYGROUND_SERVER_PORT","openBrowser","browserCommand","verbose","id","enableCors","corsOptions","webPage","Error","console","server","PlaygroundServer","undefined","cors","launchedServer","url","openInBrowser","error","customCommand","Promise","resolve","reject","command","args","process","child","spawn"],"mappings":";;;;AA0GO,SAASA,mBAAmBC,KAAY;IAC7C,OAAO;QAIL,MAAM,QACJC,UAAmC,CAAC,CAAC;YAErC,MAAM,EACJC,OAAOC,sBAAsB,EAC7BC,cAAc,IAAI,EAClBC,cAAc,EACdC,UAAU,IAAI,EACdC,EAAE,EACFC,aAAa,KAAK,EAClBC,cAAc;gBAAE,QAAQ;gBAAK,aAAa;YAAK,CAAC,EACjD,GAAGR;YAGJ,MAAMS,UAAUV,MAAM,SAAS;YAC/B,IAAI,CAACU,SACH,MAAM,IAAIC,MAAM;YAGlB,IAAIL,SAAS;gBACXM,QAAQ,GAAG,CAAC;gBACZA,QAAQ,GAAG,CAAC,CAAC,iBAAU,EAAEZ,MAAM,WAAW,CAAC,IAAI,EAAE;gBACjDY,QAAQ,GAAG,CAAC,CAAC,wBAAU,EAAEF,QAAQ,WAAW,CAAC,IAAI,EAAE;gBACnDE,QAAQ,GAAG,CAAC,CAAC,gBAAS,EAAEV,MAAM;gBAC9B,IAAIM,YACFI,QAAQ,GAAG,CAAC;YAEhB;YAGA,MAAMC,SAAS,IAAIC,SACjBd,OACAe,QACAR;YAIF,IAAIC,YACFK,OAAO,GAAG,CAAC,GAAG,CAACG,KAAKP;YAGtB,MAAMQ,iBAAkB,MAAMJ,OAAO,MAAM,CAACX;YAE5C,IAAII,SACFM,QAAQ,GAAG,CAAC,CAAC,2CAAoC,EAAEV,MAAM;YAG3D,MAAMgB,MAAM,CAAC,iBAAiB,EAAEhB,MAAM;YAGtC,IAAIE,aACF,MAAMe,cAAcD,KAAKb,gBAAgBC;YAG3C,OAAO;gBACL,QAAQW;gBACRf;gBACA,MAAM;gBACN,OAAO;oBACL,IAAII,SACFM,QAAQ,GAAG,CAAC;oBAGd,IAAI;wBACF,MAAMK,eAAe,KAAK;wBAC1B,IAAIX,SACFM,QAAQ,GAAG,CAAC;oBAEhB,EAAE,OAAOQ,OAAO;wBACd,IAAId,SACFM,QAAQ,KAAK,CAAC,4CAAuCQ;wBAEvD,MAAMA;oBACR;gBACF;YACF;QACF;IACF;AACF;AAKA,eAAeD,cACbD,GAAW,EACXG,aAAsB,EACtBf,UAAU,IAAI;IAEd,OAAO,IAAIgB,QAAQ,CAACC,SAASC;QAC3B,IAAIC;QACJ,IAAIC;QAEJ,IAAIL,eAAe;YACjBI,UAAUJ;YACVK,OAAO;gBAACR;aAAI;QACd,OAEE,OAAQS,QAAQ,QAAQ;YACtB,KAAK;gBACHF,UAAU;gBACVC,OAAO;oBAACR;iBAAI;gBACZ;YACF,KAAK;gBACHO,UAAU;gBACVC,OAAO;oBAAC;oBAAIR;iBAAI;gBAChB;YACF;gBACEO,UAAU;gBACVC,OAAO;oBAACR;iBAAI;gBACZ;QACJ;QAGF,IAAIZ,SACFM,QAAQ,GAAG,CAAC,CAAC,2BAAoB,EAAEa,QAAQ,CAAC,EAAEC,KAAK,IAAI,CAAC,MAAM;QAGhE,MAAME,QAAQC,MAAMJ,SAASC,MAAM;YACjC,UAAU;YACV,OAAO;QACT;QAEAE,MAAM,EAAE,CAAC,SAAS,CAACR;YACjB,IAAId,SAAS;gBACXM,QAAQ,IAAI,CAAC,uDAA6CQ,MAAM,OAAO;gBACvER,QAAQ,GAAG,CAAC,CAAC,gCAAyB,EAAEM,KAAK;YAC/C;YAEAK;QACF;QAEAK,MAAM,EAAE,CAAC,SAAS;YAChBL;QACF;QAGAK,MAAM,KAAK;IACb;AACF"}